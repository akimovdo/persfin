<div class="container mx-auto p-6">
  <h1 class="text-3xl font-bold mb-6">Начисления</h1>
  
  <% if (data.error) { %>
    <div class="alert alert-error mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <span><%- data.error %></span>
    </div>
  <% } %>
  
  <!-- Статистика -->
  <% if (data.stats) { %>
    <div class="stats shadow mb-6 w-full">
      <div class="stat">
        <div class="stat-figure text-primary">
          <i class="fas fa-receipt text-3xl"></i>
        </div>
        <div class="stat-title">Всего начислений</div>
        <div class="stat-value text-primary"><%- data.stats.total %></div>
        <div class="stat-desc">Активных: <%- data.stats.active %>, Закрытых: <%- data.stats.closed %></div>
      </div>
      
      <div class="stat">
        <div class="stat-figure text-secondary">
          <i class="fas fa-ruble-sign text-3xl"></i>
        </div>
        <div class="stat-title">Общая сумма</div>
        <div class="stat-value text-secondary"><%- data.stats.totalSum.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %> ₽</div>
      </div>
      
      <% if (data.stats.overdue > 0) { %>
        <div class="stat">
          <div class="stat-figure text-error">
            <i class="fas fa-exclamation-triangle text-3xl"></i>
          </div>
          <div class="stat-title">Просрочено</div>
          <div class="stat-value text-error"><%- data.stats.overdue %></div>
          <div class="stat-desc">Требуют внимания</div>
        </div>
      <% } %>
    </div>
  <% } %>
  
  <!-- Фильтры и поиск -->
  <div class="card bg-base-200 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title">Фильтры</h2>
      <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Поиск -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Поиск</span>
          </label>
          <input 
            type="text" 
            name="q" 
            value="<%- data.filters.search %>" 
            placeholder="Название или номер..."
            class="input input-bordered"
          />
        </div>
        
        <!-- Партнёр -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Партнёр</span>
          </label>
          <select name="partner" class="select select-bordered">
            <option value="">Все партнёры</option>
            <% data.partners.forEach(p => { %>
              <option value="<%- p.id %>" <%= data.filters.partnerId === p.id ? 'selected' : '' %>>
                <%- p.name %>
              </option>
            <% }) %>
          </select>
        </div>
        
        <!-- Статус -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Статус</span>
          </label>
          <select name="status" class="select select-bordered">
            <option value="">Все</option>
            <option value="active" <%= data.filters.status === 'active' ? 'selected' : '' %>>Активные</option>
            <option value="closed" <%= data.filters.status === 'closed' ? 'selected' : '' %>>Закрытые</option>
          </select>
        </div>
        
        <!-- Кнопки -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">&nbsp;</span>
          </label>
          <div class="flex gap-2">
            <button type="submit" class="btn btn-primary flex-1">
              <i class="fas fa-search"></i>
              Найти
            </button>
            <a href="/dashboard/accruals" class="btn btn-ghost">
              <i class="fas fa-times"></i>
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Кнопка создания -->
  <div class="mb-4">
    <button onclick="openAccrualModal()" class="btn btn-primary">
      <i class="fas fa-plus"></i>
      Создать начисление
    </button>
  </div>
  
  <!-- Модальное окно для создания/редактирования -->
  <dialog id="accrualModal" class="modal">
    <div class="modal-box max-w-2xl">
      <h3 class="font-bold text-lg mb-4" id="modalTitle">Создать начисление</h3>
      
      <form id="accrualForm" class="space-y-4">
        <input type="hidden" id="accrualId" value="">
        
        <!-- Название -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Название <span class="text-error">*</span></span>
          </label>
          <input 
            type="text" 
            id="accrualName" 
            name="name"
            placeholder="Введите название начисления"
            class="input input-bordered"
            required
          />
        </div>
        
        <!-- Номер -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Номер</span>
          </label>
          <input 
            type="text" 
            id="accrualNumber" 
            name="number"
            placeholder="Номер документа"
            class="input input-bordered"
          />
        </div>
        
        <!-- Партнёр -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Партнёр <span class="text-error">*</span></span>
          </label>
          <select 
            id="accrualPartner" 
            name="partner"
            class="select select-bordered"
            required>
            <option value="">Выберите партнёра</option>
            <% data.partners.forEach(p => { %>
              <option value="<%- p.id %>"><%- p.name %></option>
            <% }) %>
          </select>
        </div>
        
        <!-- Статья затрат -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Статья затрат <span class="text-error">*</span></span>
          </label>
          <select 
            id="accrualCostItem" 
            name="cost_item"
            class="select select-bordered"
            required>
            <option value="">Выберите статью затрат</option>
            <% 
              // Загружаем статьи затрат
              try {
                const costItems = $app.findRecordsByFilter('cost_items', '', 'name', 0, 0);
                costItems.forEach(ci => {
            %>
              <option value="<%- ci.getString('id') %>"><%- ci.getString('name') %></option>
            <%
                });
              } catch (e) {}
            %>
          </select>
        </div>
        
        <!-- Сумма -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Сумма <span class="text-error">*</span></span>
          </label>
          <input 
            type="number" 
            id="accrualSum" 
            name="sum"
            placeholder="0.00"
            step="0.01"
            min="0"
            class="input input-bordered"
            required
          />
        </div>
        
        <!-- Срок оплаты -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Срок оплаты <span class="text-error">*</span></span>
          </label>
          <input 
            type="date" 
            id="accrualRepaymentDate" 
            name="repayment_date"
            class="input input-bordered"
            required
          />
        </div>
        
        <!-- Описание -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Описание</span>
          </label>
          <textarea 
            id="accrualDescription" 
            name="description"
            placeholder="Дополнительная информация"
            class="textarea textarea-bordered"
            rows="3"></textarea>
        </div>
        
        <!-- Принудительное закрытие (только при редактировании) -->
        <div class="form-control" id="forcedClosureContainer" style="display: none;">
          <label class="label cursor-pointer">
            <span class="label-text">Принудительно закрыть</span>
            <input 
              type="checkbox" 
              id="accrualForcedClosure" 
              name="Forced_closure"
              class="checkbox"
            />
          </label>
        </div>
        
        <div class="modal-action">
          <button type="button" onclick="closeAccrualModal()" class="btn btn-ghost">
            Отмена
          </button>
          <button type="submit" class="btn btn-primary" id="submitButton">
            <span class="loading loading-spinner loading-sm hidden" id="submitSpinner"></span>
            <span id="submitText">Создать</span>
          </button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button onclick="closeAccrualModal()">close</button>
    </form>
  </dialog>
  
  <!-- Таблица начислений -->
  <div class="overflow-x-auto">
    <table class="table table-zebra w-full">
      <thead>
        <tr>
          <th>Название</th>
          <th>Номер</th>
          <th>Партнёр</th>
          <th>Статья затрат</th>
          <th>Сумма</th>
          <th>Срок оплаты</th>
          <th>Статус</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        <% if (data.items.length === 0) { %>
          <tr>
            <td colspan="8" class="text-center py-8 text-base-content/50">
              <i class="fas fa-inbox text-4xl mb-2"></i>
              <p>Начисления не найдены</p>
            </td>
          </tr>
        <% } else { %>
          <% data.items.forEach(item => { %>
            <tr>
              <td>
                <div class="font-medium"><%- item.name %></div>
                <% if (item.description) { %>
                  <div class="text-sm opacity-50"><%- item.description %></div>
                <% } %>
              </td>
              <td><%- item.number || '—' %></td>
              <td>
                <% if (item.expand.partner) { %>
                  <%- item.expand.partner.name %>
                <% } else { %>
                  <span class="text-base-content/50">—</span>
                <% } %>
              </td>
              <td>
                <% if (item.expand.cost_item) { %>
                  <%- item.expand.cost_item.name %>
                <% } else { %>
                  <span class="text-base-content/50">—</span>
                <% } %>
              </td>
              <td class="font-mono"><%- item.sum.toLocaleString('ru-RU', { minimumFractionDigits: 2 }) %> ₽</td>
              <td>
                <% 
                  const repaymentDate = new Date(item.repayment_date);
                  const now = new Date();
                  const isOverdue = !item.Forced_closure && repaymentDate < now;
                %>
                <span class="<%= isOverdue ? 'text-error font-bold' : '' %>">
                  <%- item.repayment_date %>
                </span>
              </td>
              <td>
                <% if (item.Forced_closure) { %>
                  <span class="badge badge-success">Закрыто</span>
                <% } else { %>
                  <span class="badge badge-warning">Активно</span>
                <% } %>
              </td>
              <td>
                <div class="flex gap-2">
                  <button 
                    onclick="editAccrual('<%- item.id %>')" 
                    class="btn btn-xs btn-ghost"
                    title="Редактировать">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button 
                    data-id="<%- item.id %>"
                    data-name="<%- item.name %>"
                    onclick="deleteAccrualHandler(this)" 
                    class="btn btn-xs btn-error"
                    title="Удалить">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>
  
  <!-- Пагинация -->
  <% if (data.pagination && data.pagination.totalPages > 1) { %>
    <div class="flex justify-center mt-6">
      <div class="join">
        <% if (data.pagination.page > 1) { %>
          <a href="?page=<%- data.pagination.page - 1 %>&q=<%- encodeURIComponent(data.filters.search) %>&partner=<%- encodeURIComponent(data.filters.partnerId) %>&status=<%- encodeURIComponent(data.filters.status) %>" 
             class="join-item btn">«</a>
        <% } %>
        
        <button class="join-item btn btn-active">
          Страница <%- data.pagination.page %> из <%- data.pagination.totalPages %>
        </button>
        
        <% if (data.pagination.hasMore) { %>
          <a href="?page=<%- data.pagination.page + 1 %>&q=<%- encodeURIComponent(data.filters.search) %>&partner=<%- encodeURIComponent(data.filters.partnerId) %>&status=<%- encodeURIComponent(data.filters.status) %>" 
             class="join-item btn">»</a>
        <% } %>
      </div>
    </div>
    <div class="text-center mt-2 text-sm opacity-70">
      Показано <%- data.items.length %> из <%- data.pagination.totalItems %> записей
    </div>
  <% } %>
</div>

<script>
// Модальное окно
const accrualModal = document.getElementById('accrualModal');
const accrualForm = document.getElementById('accrualForm');
const modalTitle = document.getElementById('modalTitle');
const submitButton = document.getElementById('submitButton');
const submitText = document.getElementById('submitText');
const submitSpinner = document.getElementById('submitSpinner');
const forcedClosureContainer = document.getElementById('forcedClosureContainer');

// Открыть модалку для создания
function openAccrualModal() {
  // Сброс формы
  accrualForm.reset();
  document.getElementById('accrualId').value = '';
  
  // Заголовок и кнопка
  modalTitle.textContent = 'Создать начисление';
  submitText.textContent = 'Создать';
  
  // Скрыть поле принудительного закрытия
  forcedClosureContainer.style.display = 'none';
  
  // Открыть модалку
  accrualModal.showModal();
}

// Открыть модалку для редактирования
async function editAccrual(id) {
  try {
    // Загружаем данные начисления
    const response = await fetch('/xapi/accruals/get_one?id=' + id);
    const result = await response.json();
    
    if (!result.success) {
      toastError(result.error || 'Ошибка загрузки данных');
      return;
    }
    
    const data = result.data;
    
    // Заполняем форму
    document.getElementById('accrualId').value = data.id;
    document.getElementById('accrualName').value = data.name;
    document.getElementById('accrualNumber').value = data.number || '';
    document.getElementById('accrualPartner').value = data.partner;
    document.getElementById('accrualCostItem').value = data.cost_item;
    document.getElementById('accrualSum').value = data.sum;
    document.getElementById('accrualRepaymentDate').value = data.repayment_date;
    document.getElementById('accrualDescription').value = data.description || '';
    document.getElementById('accrualForcedClosure').checked = data.Forced_closure;
    
    // Заголовок и кнопка
    modalTitle.textContent = 'Редактировать начисление';
    submitText.textContent = 'Сохранить';
    
    // Показать поле принудительного закрытия
    forcedClosureContainer.style.display = 'block';
    
    // Открыть модалку
    accrualModal.showModal();
    
  } catch (error) {
    console.error('Error loading accrual:', error);
    toastError('Ошибка загрузки данных');
  }
}

// Закрыть модалку
function closeAccrualModal() {
  accrualModal.close();
  accrualForm.reset();
}

// Обработка отправки формы
accrualForm.addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const accrualId = document.getElementById('accrualId').value;
  const isEdit = !!accrualId;
  
  // Собираем данные формы
  const formData = {
    name: document.getElementById('accrualName').value.trim(),
    number: document.getElementById('accrualNumber').value.trim(),
    partner: document.getElementById('accrualPartner').value,
    cost_item: document.getElementById('accrualCostItem').value,
    sum: parseFloat(document.getElementById('accrualSum').value),
    repayment_date: document.getElementById('accrualRepaymentDate').value,
    description: document.getElementById('accrualDescription').value.trim()
  };
  
  // Для редактирования добавляем Forced_closure
  if (isEdit) {
    formData.Forced_closure = document.getElementById('accrualForcedClosure').checked;
  }
  
  // Валидация
  if (!formData.name || !formData.partner || !formData.cost_item || !formData.sum || !formData.repayment_date) {
    toastError('Заполните все обязательные поля');
    return;
  }
  
  // Показываем спиннер
  submitButton.disabled = true;
  submitSpinner.classList.remove('hidden');
  submitText.textContent = isEdit ? 'Сохранение...' : 'Создание...';
  
  try {
    // Выбираем endpoint
    const url = isEdit 
      ? '/xapi/accruals/update?id=' + accrualId
      : '/xapi/accruals/create-simple';
    
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(formData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      toastSuccess(result.message || (isEdit ? 'Начисление обновлено' : 'Начисление создано'));
      closeAccrualModal();
      
      // Перезагружаем страницу для обновления списка
      location.reload();
    } else {
      toastError(result.message || result.error || 'Ошибка сохранения');
    }
  } catch (error) {
    console.error('Error saving accrual:', error);
    toastError('Ошибка сети');
  } finally {
    // Скрываем спиннер
    submitButton.disabled = false;
    submitSpinner.classList.add('hidden');
    submitText.textContent = isEdit ? 'Сохранить' : 'Создать';
  }
});

async function deleteAccrualHandler(button) {
  const id = button.dataset.id;
  const name = button.dataset.name;
  
  const confirmed = await showConfirmDialog({
    title: 'Удалить начисление?',
    message: 'Вы действительно хотите удалить начисление "' + name + '"?',
    details: 'Это действие нельзя отменить',
    type: 'danger',
    confirmText: 'Удалить',
    confirmClass: 'btn-error'
  });
  
  if (!confirmed) {
    return;
  }
  
  try {
    const response = await fetch('/xapi/accruals/delete?id=' + id, {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (result.success) {
      toastSuccess('Начисление удалено');
      location.reload();
    } else {
      toastError(result.message || 'Ошибка удаления');
    }
  } catch (error) {
    console.error('Error:', error);
    toastError('Ошибка сети');
  }
}
</script>
