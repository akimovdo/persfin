<%
meta('title', 'Дашборд · Все начисления');

const parseNumeric = (value) => {
	if (typeof value === 'number') {
		return Number.isFinite(value) ? value : 0;
	}
	if (typeof value === 'string') {
		const normalized = value.replace(',', '.');
		const parsed = Number(normalized);
		return Number.isFinite(parsed) ? parsed : 0;
	}
	if (Array.isArray(value)) {
		// Проверка на байтовый массив (ASCII-коды)
		if (value.length > 0 && value.every(v => typeof v === 'number' && v >= 0 && v <= 255)) {
			// Преобразуем байтовый массив в строку
			try {
				const str = String.fromCharCode(...value);
				const parsed = Number(str);
				if (Number.isFinite(parsed)) return parsed;
			} catch (e) {
				// Игнорируем ошибки
			}
		}
		// Обычный массив - берем первый элемент
		return value.length ? parseNumeric(value[0]) : 0;
	}
	if (value && typeof value === 'object') {
		if (Object.prototype.hasOwnProperty.call(value, 'value')) {
			return parseNumeric(value.value);
		}
		const firstKey = Object.keys(value)[0];
		if (firstKey) {
			return parseNumeric(value[firstKey]);
		}
	}
	return 0;
};

const stripHtml = (value) => {
	if (!value) return '';
	return String(value).replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
};

const truncateText = (value, limit = 140) => {
	if (!value) return '';
	const text = String(value);
	return text.length > limit ? text.slice(0, limit) + '…' : text;
};

const getMonthName = (dateString) => {
	if (!dateString) return '';
	
	const months = [
		'январь', 'февраль', 'март', 'апрель', 'май', 'июнь',
		'июль', 'август', 'сентябрь', 'октябрь', 'ноябрь', 'декабрь'
	];
	
	const date = new Date(dateString);
	return months[date.getMonth()];
};

const formatCurrency = (input) => {
	if (input === null || input === undefined) {
		return '—';
	}

	let amount = input;

	if (typeof amount === 'string') {
		const normalized = amount.replace(/[^0-9,.-]/g, '').replace(',', '.');
		amount = Number(normalized);
	} else if (typeof amount === 'bigint') {
		amount = Number(amount);
	} else if (typeof amount === 'object') {
		if (Object.prototype.hasOwnProperty.call(amount, 'value')) {
			return formatCurrency(amount.value);
		}
		const firstKey = Object.keys(amount)[0];
		if (firstKey) {
			return formatCurrency(amount[firstKey]);
		}
		return '—';
	} else if (typeof amount !== 'number') {
		amount = Number(amount);
	}

	if (!Number.isFinite(amount)) {
		return '—';
	}

	const safe = Math.round(amount * 100) / 100;

	if (!Number.isFinite(safe)) {
		return '—';
	}

		const absolute = Math.abs(safe);
		const sign = safe < 0 ? '-' : '';
		const integerPart = Math.trunc(absolute);
		const fractionPart = Math.round((absolute - integerPart) * 100);

		const integerString = String(integerPart).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
		const fractionString = fractionPart.toString().padStart(2, '0');

		return `${sign}${integerString}.${fractionString} ₽`;
};

const formatDate = (value) => {
	if (!value) return '—';
	try {
		const parsed = new Date(value);
		if (Number.isNaN(parsed.getTime())) {
			return value;
		}
		return parsed.toLocaleDateString('ru-RU', {
			day: '2-digit',
			month: 'short',
			year: 'numeric'
		});
	} catch (error) {
		return value;
	}
};

const getRowClass = (status) => {
	switch (status) {
		case 'overdue':
			return 'bg-error/10';
		case 'due-today':
			return 'bg-warning/10';
		case 'forced':
			return 'bg-primary/10';
		case 'closed':
			return 'bg-success/10';
		default:
			return '';
	}
};

let accruals = [];
let forcedClosedAccruals = [];
let fullyPaidAccruals = [];
let plannedIncome = [];
let waitIncomes = [];
let partners = [];
let costItems = [];
let loadError = null;
let partnerBalances = {};
let costItemBalances = {};
let summary = {
	total: 0,
	totalSum: 0,
	overdue: 0,
	overdueSum: 0,
	dueToday: 0,
	dueTodaySum: 0,
	upcoming: 0,
	upcomingSum: 0,
	closed: 0,
	closedSum: 0,
	forced: 0,
	balanceSum: 0
};

// Данные банка
let bankConfig = null;
let bankBalance = null;
let lastSyncDate = null;

try {
	// Загружаем справочники
	const partnersRecords = $app.findRecordsByFilter('partners', '', 'name', 0, 0);
	const costItemsRecords = $app.findRecordsByFilter('cost_items', '', 'name', 0, 0);
	
	// Загружаем только активные начисления (is_forced_closed = false AND balance != 0)
	const records = $app.findRecordsByFilter('accruals_all_with_status', 'is_forced_closed = false && balance != 0', '', 0, 0);
	
	// Загружаем принудительно закрытые
	const forcedRecords = $app.findRecordsByFilter('accruals_all_with_status', 'is_forced_closed = true', '', 0, 0);
	
	// Загружаем полностью оплаченные (balance = 0 или balance <= 0)
	const paidRecords = $app.findRecordsByFilter('accruals_all_with_status', 'is_forced_closed = false && balance <= 0', '', 0, 0);
	
	// Загружаем планируемые поступления
	const incomeRecords = $app.findRecordsByFilter('planned_income', '', '-income_date', 0, 0);
	
	summary.total = records.length;

	for (let i = 0; i < records.length; i++) {
		const record = records[i];

		const totalAccrued = parseNumeric(record.get('total_accrued'));
		const totalPaid = parseNumeric(record.get('total_paid'));
		const balance = parseNumeric(record.get('balance'));

		const daysDifferenceRaw = record.get('days_difference');
		const daysDifference = typeof daysDifferenceRaw === 'number' && !Number.isNaN(daysDifferenceRaw)
			? daysDifferenceRaw
			: null;

		const paymentsCountRaw = record.get('payments_count');
		const paymentsCount = typeof paymentsCountRaw === 'number' && !Number.isNaN(paymentsCountRaw)
			? paymentsCountRaw
			: parseNumeric(paymentsCountRaw);

		const isForcedClosed = Boolean(record.get('is_forced_closed'));

		let descriptionRaw = '';
		const descriptionCandidate = record.get('description');
		if (typeof descriptionCandidate === 'string') {
			descriptionRaw = descriptionCandidate;
		}

	const statusInfo = {
		status: 'active',
		label: 'В работе',
		badgeClass: 'badge-info'
	};

	if (isForcedClosed) {
		statusInfo.status = 'forced';
		statusInfo.label = 'Закрыто';
		statusInfo.badgeClass = 'badge-outline';
		summary.forced += 1;
	} else if (balance <= 0) {
		statusInfo.status = 'closed';
		statusInfo.label = 'Оплачено';
		statusInfo.badgeClass = 'badge-success';
		summary.closed += 1;
		summary.closedSum += totalAccrued;
	} else if (typeof daysDifference === 'number' && daysDifference < 0) {
		statusInfo.status = 'overdue';
		statusInfo.label = `Просрочено ${Math.abs(daysDifference)} дн.`;
		statusInfo.badgeClass = 'badge-error';
		summary.overdue += 1;
		summary.overdueSum += balance;
	} else if (daysDifference === 0) {
		statusInfo.status = 'due-today';
		statusInfo.label = 'Оплата сегодня';
		statusInfo.badgeClass = 'badge-warning';
		summary.dueToday += 1;
		summary.dueTodaySum += balance;
	} else {
		statusInfo.status = 'upcoming';
		statusInfo.label = typeof daysDifference === 'number'
			? `До оплаты ${daysDifference} дн.`
			: 'В работе';
		statusInfo.badgeClass = 'badge-info';
		summary.upcoming += 1;
		summary.upcomingSum += balance;
	}		
		summary.totalSum += totalAccrued;
		if (!isForcedClosed && balance > 0) {
			summary.balanceSum += balance;
			
			// Группируем по партнёрам
			const partnerName = record.getString('partner_name');
			if (partnerName) {
				if (!partnerBalances[partnerName]) {
					partnerBalances[partnerName] = 0;
				}
				partnerBalances[partnerName] += balance;
			}
			
			// Группируем по статьям затрат
			const costItemName = record.getString('cost_item_name');
			if (costItemName) {
				if (!costItemBalances[costItemName]) {
					costItemBalances[costItemName] = 0;
				}
				costItemBalances[costItemName] += balance;
			}
		}

		accruals.push({
			id: record.getString('id'),
			number: record.getString('number'),
			name: record.getString('accrual_name'),
			partnerId: record.getString('partner_id'),
			partnerName: record.getString('partner_name'),
			costItemId: record.getString('cost_item_id'),
			costItemName: record.getString('cost_item_name'),
			totalAccrued,
			totalPaid,
			balance,
			daysDifference,
			paymentsCount,
			repaymentDate: record.getString('repayment_date'),
			description: truncateText(stripHtml(descriptionRaw), 140),
			created: record.getString('created'),
			updated: record.getString('updated'),
			isForcedClosed,
			status: statusInfo.status,
			statusLabel: statusInfo.label,
			statusBadgeClass: statusInfo.badgeClass
		});

	}
	
	// Обработка принудительно закрытых начислений
	for (let i = 0; i < forcedRecords.length; i++) {
		const record = forcedRecords[i];
		
		const totalAccrued = parseNumeric(record.get('total_accrued'));
		const totalPaid = parseNumeric(record.get('total_paid'));
		const balance = parseNumeric(record.get('balance'));
		
		let descriptionRaw = '';
		const descriptionCandidate = record.get('description');
		if (typeof descriptionCandidate === 'string') {
			descriptionRaw = descriptionCandidate;
		}
		
		forcedClosedAccruals.push({
			id: record.getString('id'),
			number: record.getString('number'),
			name: record.getString('accrual_name'),
			partnerId: record.getString('partner_id'),
			partnerName: record.getString('partner_name'),
			costItemId: record.getString('cost_item_id'),
			costItemName: record.getString('cost_item_name'),
			totalAccrued,
			totalPaid,
			balance,
			repaymentDate: record.getString('repayment_date'),
			description: truncateText(stripHtml(descriptionRaw), 140),
			isForcedClosed: true,
			created: record.getString('created')
		});
	}
	
	// Обработка полностью оплаченных начислений
	for (let i = 0; i < paidRecords.length; i++) {
		const record = paidRecords[i];
		
		const totalAccrued = parseNumeric(record.get('total_accrued'));
		const totalPaid = parseNumeric(record.get('total_paid'));
		
		let descriptionRaw = '';
		const descriptionCandidate = record.get('description');
		if (typeof descriptionCandidate === 'string') {
			descriptionRaw = descriptionCandidate;
		}
		
		fullyPaidAccruals.push({
			id: record.getString('id'),
			number: record.getString('number'),
			name: record.getString('accrual_name'),
			partnerId: record.getString('partner_id'),
			partnerName: record.getString('partner_name'),
			costItemId: record.getString('cost_item_id'),
			costItemName: record.getString('cost_item_name'),
			totalAccrued,
			totalPaid,
			repaymentDate: record.getString('repayment_date'),
			description: truncateText(stripHtml(descriptionRaw), 140),
			isForcedClosed: false,
			created: record.getString('created')
		});
	}
	
	// Преобразуем partnerBalances в отсортированный массив
	var partnerBalancesArray = [];
	for (var partnerName in partnerBalances) {
		if (partnerBalances.hasOwnProperty(partnerName)) {
			partnerBalancesArray.push({
				name: partnerName,
				balance: partnerBalances[partnerName]
			});
		}
	}
	// Сортируем по убыванию остатка
	partnerBalancesArray.sort(function(a, b) {
		return b.balance - a.balance;
	});
	
	// Преобразуем costItemBalances в отсортированный массив
	var costItemBalancesArray = [];
	for (var costItemName in costItemBalances) {
		if (costItemBalances.hasOwnProperty(costItemName)) {
			costItemBalancesArray.push({
				name: costItemName,
				balance: costItemBalances[costItemName]
			});
		}
	}
	// Сортируем по убыванию остатка
	costItemBalancesArray.sort(function(a, b) {
		return b.balance - a.balance;
	});
	
	// Обработка планируемых поступлений
	var totalPlannedIncome = 0;
	for (var i = 0; i < incomeRecords.length; i++) {
		var record = incomeRecords[i];
		
		var incomeSum = parseNumeric(record.get('sum'));
		var incomeDateStr = record.getString('income_date');
		
		totalPlannedIncome += incomeSum;
		
		plannedIncome.push({
			id: record.getString('id'),
			name: record.getString('name'),
			sum: incomeSum,
			incomeDate: incomeDateStr,
			created: record.getString('created'),
			updated: record.getString('updated')
		});
	}
	
	// Загружаем ожидаемые поступления с балансом
	const waitIncomesRecords = $app.findRecordsByFilter('wait_incomes_with_status', '', '-accrual_month', 0, 0);
	
	var totalWaitIncomesBalance = 0;
	for (var i = 0; i < waitIncomesRecords.length; i++) {
		var record = waitIncomesRecords[i];
		
		var sum = parseNumeric(record.get('sum'));
		var totalReceived = parseNumeric(record.get('total_received'));
		var balance = parseNumeric(record.get('balance'));
		
		// Пропускаем записи с нулевым балансом
		if (balance === 0) {
			continue;
		}
		
		// Получаем оригинальную сумму из таблицы wait_incomes
		var originalSum = sum;
		try {
			const originalRecord = $app.dao().findRecordById('wait_incomes', record.getString('id'));
			originalSum = parseNumeric(originalRecord.get('sum'));
		} catch (e) {
			// Если не удалось получить оригинальную запись, используем расчетную сумму / 0.9
			originalSum = Math.round(sum / 0.9);
		}
		
		totalWaitIncomesBalance += balance;
		
		waitIncomes.push({
			id: record.getString('id'),
			name: record.getString('name'),
			sum: sum,
			originalSum: originalSum, // Добавляем оригинальную сумму
			totalReceived: totalReceived,
			balance: balance,
			paymentsCount: parseNumeric(record.get('payments_count')),
			accrualMonth: record.getString('accrual_month'),
			daysDifference: record.get('days_difference'),
			created: record.getString('created'),
			updated: record.getString('updated')
		});
	}
	
	// Преобразуем Records в массивы для использования в форме
	partners = [];
	for (let i = 0; i < partnersRecords.length; i++) {
		partners.push({
			id: partnersRecords[i].id,
			name: partnersRecords[i].get('name')
		});
	}
	
	costItems = [];
	for (let i = 0; i < costItemsRecords.length; i++) {
		costItems.push({
			id: costItemsRecords[i].id,
			name: costItemsRecords[i].get('name')
		});
	}
	
} catch (error) {
	loadError = error;
	if (typeof log !== 'undefined' && log && typeof log.error === 'function') {
		log.error('[dashboard::accruals_all_with_status] failed to load view', error);
	}
}

// Загрузка данных банка
try {
	bankConfig = $app.findFirstRecordByFilter('tochka_config', 'is_active = true');
	if (bankConfig) {
		bankBalance = bankConfig.get('endDateBalance');
		const lastSync = bankConfig.get('last_sync_date');
		if (lastSync) {
			lastSyncDate = new Date(lastSync);
		}
	}
} catch (error) {
	// Конфигурация банка не найдена или не активна
}
%>

<section class="space-y-6">
	<header class="space-y-1">
		<h1 class="text-2xl font-semibold">Все начисления</h1>
		<p class="text-sm text-base-content/70">Источник: представление <code>accruals_all_with_status</code></p>
	</header>

	<% if (loadError) { %>
		<div class="alert alert-error">
			<span>Не удалось загрузить данные: <%= loadError?.message || loadError %></span>
		</div>
	<% } else { %>
		<!-- Раздел работы с банком -->
		<div class="space-y-4">
			<div class="divider">
				<h2 class="text-xl font-semibold">
					<i class="fas fa-university"></i>
					Банк Точка
				</h2>
			</div>
			
			<% if (bankConfig) { %>
				<div class="grid gap-4 md:grid-cols-2">
					<!-- Виджет с балансом -->
					<div class="rounded-lg bg-gradient-to-br from-primary/20 to-primary/5 p-6 border border-primary/30">
						<div class="flex items-start justify-between mb-4">
							<div>
								<p class="text-xs uppercase tracking-wide text-base-content/60 mb-1">Текущий баланс</p>
								<p class="text-3xl font-bold text-primary">
									<%= bankBalance !== null && bankBalance !== undefined ? formatCurrency(bankBalance) : '—' %>
								</p>
							</div>
							<div class="badge badge-success badge-sm">
								<i class="fas fa-check-circle mr-1"></i>
								Активен
							</div>
						</div>
						<div class="text-sm text-base-content/70">
							<% if (lastSyncDate) { %>
								<p>
									<i class="fas fa-sync-alt mr-1"></i>
									Последнее обновление: <span class="font-medium"><%= formatDate(lastSyncDate) %></span>
								</p>
							<% } else { %>
								<p class="text-warning">
									<i class="fas fa-exclamation-triangle mr-1"></i>
									Данные ещё не загружены
								</p>
							<% } %>
						</div>
					</div>
					
					<!-- Карточка с кнопкой загрузки -->
					<div class="rounded-lg bg-base-200 p-6">
						<p class="text-xs uppercase tracking-wide text-base-content/60 mb-4">Синхронизация</p>
						<div class="space-y-3">
							<button 
								class="btn btn-primary w-full"
								id="btnLoadBank">
								<i class="fas fa-download"></i>
								Загрузить выписку
							</button>
							<button 
								onclick="openPaymentsModal()" 
								class="btn btn-secondary w-full"
								id="btnAllocatePayments">
								<i class="fas fa-link"></i>
								Разнести платежи
							</button>
							<p class="text-xs text-base-content/60 text-center">
								<% if (lastSyncDate) { %>
									Будет загружена выписка с <%= formatDate(lastSyncDate) %> по текущую дату.<br>
									<span class="text-base-content/50">Обработка обычно занимает 5-15 секунд</span>
								<% } else { %>
									Будет загружена выписка за последний месяц.<br>
									<span class="text-base-content/50">Обработка обычно занимает 5-15 секунд</span>
								<% } %>
							</p>
						</div>
						<div id="bankLoadResult" class="mt-4" style="display: none;"></div>
					</div>
				</div>
			<% } else { %>
				<div class="alert alert-warning">
					<i class="fas fa-exclamation-triangle"></i>
					<span>Конфигурация банка не настроена. Добавьте активную запись в таблицу <code>tochka_config</code>.</span>
				</div>
			<% } %>
		</div>

		<!-- Раздел Поступления -->
		<div class="space-y-4">
			<div class="divider">
				<h2 class="text-xl font-semibold">
					<i class="fas fa-arrow-down text-success"></i>
					Поступления
				</h2>
			</div>
			
			<div class="grid gap-4 md:grid-cols-2">
				<!-- Абонентская плата -->
				<div class="rounded-lg bg-base-200 p-4 flex flex-col">
					<p class="text-xs uppercase tracking-wide text-base-content/60 mb-2">Абонентская плата</p>
					<div class="space-y-1 flex-1 overflow-y-auto text-sm">
						<% if (plannedIncome.length === 0) { %>
							<p class="text-base-content/60 text-xs">Нет данных</p>
						<% } else { %>
							<% for (var i = 0; i < plannedIncome.length; i++) { %>
								<div class="flex justify-between items-center">
									<span class="text-base-content/80 truncate mr-2"><%= plannedIncome[i].name %></span>
									<span class="font-semibold text-success whitespace-nowrap"><%= formatCurrency(plannedIncome[i].sum) %></span>
								</div>
							<% } %>
							<div class="border-t border-base-300 pt-2 mt-2 flex justify-between items-center">
								<span class="text-base-content font-semibold">ИТОГО</span>
								<span class="font-bold text-success whitespace-nowrap"><%= formatCurrency(totalPlannedIncome) %></span>
							</div>
							<div class="mt-3">
								<button 
									onclick="generateWaitIncomes()" 
									class="btn btn-xs btn-success w-full"
									id="btnGenerateWaitIncomes">
									<i class="fas fa-magic"></i>
									Создать ожидаемые поступления
								</button>
							</div>
						<% } %>
					</div>
				</div>
				
				<!-- Ожидаемые платежи -->
				<div class="rounded-lg bg-base-200 p-4 flex flex-col">
					<p class="text-xs uppercase tracking-wide text-base-content/60 mb-2">Ожидаемые платежи</p>
					<div class="space-y-1 flex-1 overflow-y-auto text-sm">
						<% if (waitIncomes.length === 0) { %>
							<p class="text-base-content/60 text-xs">Нет данных</p>
						<% } else { %>
							<% for (var i = 0; i < waitIncomes.length; i++) { %>
								<div class="flex justify-between items-center hover:bg-base-300 cursor-pointer p-2 rounded transition-colors wait-income-item" 
									 data-id="<%= waitIncomes[i].id %>" 
									 data-name="<%= waitIncomes[i].name %>" 
									 data-sum="<%= waitIncomes[i].originalSum %>" 
									 data-accrual-month="<%= waitIncomes[i].accrualMonth %>"
									 onclick="openEditWaitIncomeModal(this)">
									<span class="text-base-content/80 truncate mr-2">
										<%= waitIncomes[i].name %>
										<% if (waitIncomes[i].accrualMonth) { %>
											<span class="text-base-content/50">
												(<%= getMonthName(waitIncomes[i].accrualMonth) %>)
											</span>
										<% } %>
									</span>
									<span class="font-semibold <%= waitIncomes[i].balance > 0 ? 'text-info' : 'text-success' %> whitespace-nowrap">
										<%= formatCurrency(waitIncomes[i].balance) %>
									</span>
								</div>
							<% } %>
							<div class="border-t border-base-300 pt-2 mt-2 flex justify-between items-center">
								<span class="text-base-content font-semibold">ИТОГО</span>
								<span class="font-bold text-info whitespace-nowrap"><%= formatCurrency(totalWaitIncomesBalance) %></span>
							</div>
							<div class="mt-3">
								<button 
									onclick="openAddWaitIncomeModal()" 
									class="btn btn-xs btn-info w-full"
									id="btnAddWaitIncome">
									<i class="fas fa-plus"></i>
									Добавить платеж
								</button>
							</div>
						<% } %>
					</div>
				</div>
			</div>
		</div>

		<div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
			<div class="rounded-lg bg-base-200 p-4 flex flex-col">
				<p class="text-xs uppercase tracking-wide text-base-content/60 mb-3">Статус начислений</p>
				<div class="space-y-3 flex-1">
					<div>
						<p class="text-xs text-base-content/60">Всего начислений</p>
						<p class="text-xl font-semibold"><%= formatCurrency(summary.totalSum) %></p>
						<p class="text-xs text-base-content/50"><%= summary.total %> шт.</p>
					</div>
					<div>
						<p class="text-xs text-base-content/60">Просрочено</p>
						<p class="text-xl font-semibold text-error"><%= formatCurrency(summary.overdueSum) %></p>
						<p class="text-xs text-base-content/50"><%= summary.overdue %> шт.</p>
					</div>
					<div>
						<p class="text-xs text-base-content/60">Оплата сегодня</p>
						<p class="text-xl font-semibold text-warning"><%= formatCurrency(summary.dueTodaySum) %></p>
						<p class="text-xs text-base-content/50"><%= summary.dueToday %> шт.</p>
					</div>
				</div>
			</div>
			<div class="rounded-lg bg-base-200 p-4 flex flex-col">
				<p class="text-xs uppercase tracking-wide text-base-content/60 mb-2">Остаток по партнёрам</p>
				<div class="space-y-1 flex-1 overflow-y-auto text-sm">
					<% if (partnerBalancesArray.length === 0) { %>
						<p class="text-base-content/60 text-xs">Нет данных</p>
					<% } else { %>
						<% for (var i = 0; i < partnerBalancesArray.length; i++) { %>
							<div class="flex justify-between items-center">
								<span class="text-base-content/80 truncate mr-2"><%= partnerBalancesArray[i].name %></span>
								<span class="font-semibold text-info whitespace-nowrap"><%= formatCurrency(partnerBalancesArray[i].balance) %></span>
							</div>
						<% } %>
					<% } %>
				</div>
			</div>
			<div class="rounded-lg bg-base-200 p-4 flex flex-col">
				<p class="text-xs uppercase tracking-wide text-base-content/60 mb-2">Остаток по статьям</p>
				<div class="space-y-1 flex-1 overflow-y-auto text-sm">
					<% if (costItemBalancesArray.length === 0) { %>
						<p class="text-base-content/60 text-xs">Нет данных</p>
					<% } else { %>
						<% for (var i = 0; i < costItemBalancesArray.length; i++) { %>
							<div class="flex justify-between items-center">
								<span class="text-base-content/80 truncate mr-2"><%= costItemBalancesArray[i].name %></span>
								<span class="font-semibold text-info whitespace-nowrap"><%= formatCurrency(costItemBalancesArray[i].balance) %></span>
							</div>
						<% } %>
					<% } %>
				</div>
			</div>
		</div>

	<!-- Раздел Расходы -->
	<div class="divider mt-16">
		<h2 class="text-2xl font-bold text-base-content/80 flex items-center gap-2">
			<i class="fas fa-arrow-up text-error"></i> Расходы
		</h2>
	</div>

	<!-- Фильтры и toggle кнопки -->
	<div class="flex gap-3 flex-wrap items-end mb-4">
		<!-- Кнопка добавления начисления -->
		<button 
			type="button"
			onclick="openAddAccrualModal()" 
			class="btn btn-sm btn-primary">
			<i class="fas fa-plus"></i>
			Добавить начисление
		</button>
		
		<!-- Фильтр по партнёрам -->
		<div class="form-control">
			<label class="label pb-1">
				<span class="label-text text-xs">Фильтр по партнёру:</span>
			</label>
			<select 
				class="select select-bordered select-sm w-full max-w-xs"
				id="partnerFilter"
				onchange="filterByPartner()">
				<option value="">Все партнёры (<%= accruals.length %>)</option>
				<% for (var i = 0; i < partnerBalancesArray.length; i++) { %>
					<option value="<%= partnerBalancesArray[i].name %>">
						<%= partnerBalancesArray[i].name %> 
						(<%= accruals.filter(function(a) { return a.partnerName === partnerBalancesArray[i].name; }).length %>)
					</option>
				<% } %>
			</select>
		</div>
		
		<!-- Фильтр по статьям -->
		<div class="form-control">
			<label class="label pb-1">
				<span class="label-text text-xs">Фильтр по статье затрат:</span>
			</label>
			<select 
				class="select select-bordered select-sm w-full max-w-xs"
				id="costItemFilter"
				onchange="filterByCostItem()">
				<option value="">Все статьи (<%= accruals.length %>)</option>
				<% for (var i = 0; i < costItemBalancesArray.length; i++) { %>
					<option value="<%= costItemBalancesArray[i].name %>">
						<%= costItemBalancesArray[i].name %> 
						(<%= accruals.filter(function(a) { return a.costItemName === costItemBalancesArray[i].name; }).length %>)
					</option>
				<% } %>
			</select>
		</div>
		
		<!-- Отбор по платежам -->
		<div class="form-control">
			<label class="label pb-1">
				<span class="label-text text-xs">Отбор по платежам:</span>
			</label>
			<div class="flex gap-2">
				<button 
					type="button"
					onclick="toggleForcedClosed()" 
					class="btn btn-sm btn-outline btn-primary"
					id="btnToggleForcedClosed"
					data-count="<%= forcedClosedAccruals.length %>">
					<i class="fas fa-ban"></i>
					Принудительно закрытые (<%= forcedClosedAccruals.length %>)
				</button>
				<button 
					type="button"
					onclick="toggleFullyPaid()" 
					class="btn btn-sm btn-outline btn-success"
					id="btnToggleFullyPaid"
					data-count="<%= fullyPaidAccruals.length %>">
					<i class="fas fa-check-circle"></i>
					Полностью оплаченные (<%= fullyPaidAccruals.length %>)
				</button>
			</div>
		</div>
	</div>

	<% if (!accruals.length) { %>
		<div class="alert">
			<span>Начислений пока нет.</span>
		</div>
	<% } else { %>
		<div class="overflow-x-auto rounded-xl border border-base-200">
				<table class="table table-zebra table-sm">
					<thead>
						<tr>
							<th class="whitespace-nowrap">Начисление</th>
							<th>Партнёр / Статья</th>
							<th class="text-right">Начислено</th>
							<th class="text-right">Оплачено</th>
							<th class="text-right">Баланс</th>
							<th class="whitespace-nowrap">Срок оплаты</th>
							<th>Статус</th>
							<th class="text-center">Платежи</th>
							<th>Описание</th>
							<th class="text-center">Действия</th>
						</tr>
					</thead>
					<tbody>
						<% accruals.forEach(function(item) { %>
							<tr class="align-top <%= getRowClass(item.status) %> accrual-row hover:bg-base-300 cursor-pointer transition-colors" 
								data-partner-name="<%= item.partnerName || '' %>"
								data-cost-item="<%= item.costItemName || '' %>"
								data-accrual-id="<%= item.id %>"
								data-accrual-name="<%= item.name || '' %>"
								data-accrual-number="<%= item.number || '' %>"
								data-accrual-partner="<%= item.partnerId || '' %>"
								data-accrual-cost-item="<%= item.costItemId || '' %>"
								data-accrual-sum="<%= item.totalAccrued %>"
								data-accrual-repayment-date="<%= item.repaymentDate || '' %>"
								data-accrual-description="<%= item.description || '' %>"
								data-accrual-forced-closure="<%= item.isForcedClosed ? 'true' : 'false' %>"
								onclick="openEditAccrualModal(this)">
								<td class="whitespace-nowrap">
									<div class="font-semibold"><%= item.name || 'Без названия' %></div>
									<div class="text-xs text-base-content/60"><%= item.number || 'Без номера' %></div>
								</td>
								<td>
									<% if (item.costItemName) { %>
										<div class="font-medium"><%= item.costItemName %></div>
									<% } else { %>
										<div class="text-base-content/60">—</div>
									<% } %>
									<% if (item.partnerName) { %>
										<div class="text-xs text-base-content/60"><%= item.partnerName %></div>
									<% } %>
								</td>
								<td class="text-right">
									<div class="font-medium"><%= formatCurrency(item.totalAccrued) %></div>
									<div class="text-xs text-base-content/60">Начислено</div>
								</td>
								<td class="text-right">
									<div class="font-medium"><%= formatCurrency(item.totalPaid) %></div>
									<div class="text-xs text-base-content/60">Оплачено</div>
								</td>
								<td class="text-right">
									<div class="font-semibold <%= item.balance > 0 ? 'text-error' : 'text-success' %>"><%= formatCurrency(item.balance) %></div>
									<div class="text-xs text-base-content/60">К оплате</div>
								</td>
								<td class="whitespace-nowrap">
									<div class="font-medium"><%= formatDate(item.repaymentDate) %></div>
									<% if (typeof item.daysDifference === 'number') { %>
										<% if (item.daysDifference > 0) { %>
											<div class="text-xs text-base-content/60">Осталось <%= item.daysDifference %> дн.</div>
										<% } else if (item.daysDifference < 0) { %>
											<div class="text-xs text-error">Просрочка <%= Math.abs(item.daysDifference) %> дн.</div>
										<% } else { %>
											<div class="text-xs text-warning">Сегодня</div>
										<% } %>
									<% } %>
								</td>
								<td>
									<span class="badge <%= item.statusBadgeClass %> whitespace-nowrap"><%= item.statusLabel %></span>
								</td>
								<td class="text-center">
									<div class="font-medium"><%= item.paymentsCount %></div>
									<div class="text-xs text-base-content/60">платеж(ей)</div>
								</td>
								<td class="max-w-xs">
									<% if (item.description) { %>
										<p class="text-sm text-base-content/80"><%= item.description %></p>
									<% } else { %>
										<span class="text-base-content/40">—</span>
									<% } %>
								</td>
								<td class="text-center">
									<button 
										class="btn btn-xs btn-success"
										onclick="event.stopPropagation(); openManualPaymentModal('<%= item.id %>', '<%= item.name %>', <%= item.balance %>)">
										<i class="fas fa-money-bill-wave"></i>
										Оплатить
									</button>
								</td>
							</tr>
						<% }); %>
					</tbody>
				</table>
			</div>
		<% } %>
	<% } %>
	
	<!-- Принудительно закрытые начисления -->
	<div id="forcedClosedBlock" style="display: none;" class="space-y-4">
		<div class="divider">
			<h3 class="text-lg font-semibold">
				<i class="fas fa-ban text-primary"></i>
				Принудительно закрытые начисления (<%= forcedClosedAccruals.length %>)
			</h3>
		</div>
		<% if (forcedClosedAccruals.length > 0) { %>
			<div class="overflow-x-auto rounded-xl border border-base-200">
				<table class="table table-zebra table-sm">
					<thead>
						<tr>
							<th>Начисление</th>
							<th>Партнёр / Статья</th>
							<th class="text-right">Начислено</th>
							<th class="text-right">Оплачено</th>
							<th class="text-right">Баланс</th>
							<th>Срок оплаты</th>
							<th>Создано</th>
						</tr>
					</thead>
					<tbody>
						<% forcedClosedAccruals.forEach(function(item) { %>
							<tr class="align-top bg-primary/10 hover:bg-primary/20 cursor-pointer transition-colors"
								data-accrual-id="<%= item.id %>"
								data-accrual-name="<%= item.name || '' %>"
								data-accrual-number="<%= item.number || '' %>"
								data-accrual-partner="<%= item.partnerId || '' %>"
								data-accrual-cost-item="<%= item.costItemId || '' %>"
								data-accrual-sum="<%= item.totalAccrued %>"
								data-accrual-repayment-date="<%= item.repaymentDate || '' %>"
								data-accrual-description="<%= item.description || '' %>"
								data-accrual-forced-closure="<%= item.isForcedClosed ? 'true' : 'false' %>"
								onclick="openEditAccrualModal(this)">
								<td class="whitespace-nowrap">
									<div class="font-semibold"><%= item.name || 'Без названия' %></div>
									<div class="text-xs text-base-content/60"><%= item.number || 'Без номера' %></div>
								</td>
								<td>
									<% if (item.costItemName) { %>
										<div class="font-medium"><%= item.costItemName %></div>
									<% } %>
									<% if (item.partnerName) { %>
										<div class="text-xs text-base-content/60"><%= item.partnerName %></div>
									<% } %>
								</td>
								<td class="text-right">
									<div class="font-semibold"><%= formatCurrency(item.totalAccrued) %></div>
								</td>
								<td class="text-right">
									<div class="font-semibold text-success"><%= formatCurrency(item.totalPaid) %></div>
								</td>
								<td class="text-right">
									<div class="font-semibold <%= item.balance > 0 ? 'text-error' : 'text-success' %>">
										<%= formatCurrency(item.balance) %>
									</div>
								</td>
								<td class="whitespace-nowrap">
									<%= formatDate(item.repaymentDate) %>
								</td>
								<td class="whitespace-nowrap text-xs text-base-content/60">
									<%= formatDate(item.created) %>
								</td>
							</tr>
						<% }); %>
					</tbody>
				</table>
			</div>
		<% } else { %>
			<div class="alert">
				<span>Нет принудительно закрытых начислений</span>
			</div>
		<% } %>
	</div>
	
	<!-- Полностью оплаченные начисления -->
	<!-- Данных: <%= fullyPaidAccruals.length %> -->
	<div id="fullyPaidBlock" style="display: none;" class="space-y-4">
		<div class="divider">
			<h3 class="text-lg font-semibold">
				<i class="fas fa-check-circle text-success"></i>
				Полностью оплаченные начисления (<%= fullyPaidAccruals.length %>)
			</h3>
		</div>
		<% if (fullyPaidAccruals.length > 0) { %>
			<div class="overflow-x-auto rounded-xl border border-base-200">
				<table class="table table-zebra table-sm">
					<thead>
						<tr>
							<th>Начисление</th>
							<th>Партнёр / Статья</th>
							<th class="text-right">Начислено</th>
							<th class="text-right">Оплачено</th>
							<th>Срок оплаты</th>
							<th>Создано</th>
						</tr>
					</thead>
					<tbody>
						<% fullyPaidAccruals.forEach(function(item) { %>
							<tr class="align-top bg-success/10 hover:bg-success/20 cursor-pointer transition-colors"
								data-accrual-id="<%= item.id %>"
								data-accrual-name="<%= item.name || '' %>"
								data-accrual-number="<%= item.number || '' %>"
								data-accrual-partner="<%= item.partnerId || '' %>"
								data-accrual-cost-item="<%= item.costItemId || '' %>"
								data-accrual-sum="<%= item.totalAccrued %>"
								data-accrual-repayment-date="<%= item.repaymentDate || '' %>"
								data-accrual-description="<%= item.description || '' %>"
								data-accrual-forced-closure="<%= item.isForcedClosed ? 'true' : 'false' %>"
								onclick="openEditAccrualModal(this)">
								<td class="whitespace-nowrap">
									<div class="font-semibold"><%= item.name || 'Без названия' %></div>
									<div class="text-xs text-base-content/60"><%= item.number || 'Без номера' %></div>
								</td>
								<td>
									<% if (item.costItemName) { %>
										<div class="font-medium"><%= item.costItemName %></div>
									<% } %>
									<% if (item.partnerName) { %>
										<div class="text-xs text-base-content/60"><%= item.partnerName %></div>
									<% } %>
								</td>
								<td class="text-right">
									<div class="font-semibold"><%= formatCurrency(item.totalAccrued) %></div>
								</td>
								<td class="text-right">
									<div class="font-semibold text-success"><%= formatCurrency(item.totalPaid) %></div>
								</td>
								<td class="whitespace-nowrap">
									<%= formatDate(item.repaymentDate) %>
								</td>
								<td class="whitespace-nowrap text-xs text-base-content/60">
									<%= formatDate(item.created) %>
								</td>
							</tr>
						<% }); %>
					</tbody>
				</table>
			</div>
		<% } else { %>
			<div class="alert">
				<span>Нет полностью оплаченных начислений</span>
			</div>
		<% } %>
	</div>
</section>

<!-- Модальное окно для добавления начисления -->
<dialog id="addAccrualModal" class="modal">
	<div class="modal-box max-w-2xl">
		<h3 class="font-bold text-lg mb-4">
			<i class="fas fa-plus-circle text-primary"></i>
			Добавить начисление
		</h3>
		<form id="addAccrualForm" class="space-y-4">
			<!-- Название -->
			<div class="form-control">
				<label class="label">
					<span class="label-text">Название <span class="text-error">*</span></span>
				</label>
				<input 
					type="text" 
					name="name" 
					class="input input-bordered w-full" 
					placeholder="Название начисления"
					required />
			</div>

			<!-- Номер -->
			<div class="form-control">
				<label class="label">
					<span class="label-text">Номер</span>
				</label>
				<input 
					type="text" 
					name="number" 
					class="input input-bordered w-full" 
					placeholder="Номер документа" />
			</div>

			<div class="grid grid-cols-2 gap-4">
				<!-- Партнер -->
				<div class="form-control">
					<label class="label">
						<span class="label-text">Партнёр <span class="text-error">*</span></span>
					</label>
					<select 
						name="partner" 
						class="select select-bordered w-full"
						required>
						<option value="">Выберите партнёра</option>
						<% for (let i = 0; i < partners.length; i++) { %>
							<option value="<%= partners[i].id %>"><%= partners[i].name %></option>
						<% } %>
					</select>
				</div>

				<!-- Статья расходов -->
				<div class="form-control">
					<label class="label">
						<span class="label-text">Статья расходов <span class="text-error">*</span></span>
					</label>
					<select 
						name="cost_item" 
						class="select select-bordered w-full"
						required>
						<option value="">Выберите статью</option>
						<% for (let i = 0; i < costItems.length; i++) { %>
							<option value="<%= costItems[i].id %>"><%= costItems[i].name %></option>
						<% } %>
					</select>
				</div>
			</div>

			<div class="grid grid-cols-2 gap-4">
				<!-- Сумма -->
				<div class="form-control">
					<label class="label">
						<span class="label-text">Сумма <span class="text-error">*</span></span>
					</label>
					<input 
						type="number" 
						name="sum" 
						class="input input-bordered w-full" 
						placeholder="0.00"
						step="0.01"
						min="0"
						required />
				</div>

				<!-- Срок оплаты -->
				<div class="form-control">
					<label class="label">
						<span class="label-text">Срок оплаты <span class="text-error">*</span></span>
					</label>
					<input 
						type="date" 
						name="repayment_date" 
						class="input input-bordered w-full"
						required />
				</div>
			</div>

			<!-- Описание -->
			<div class="form-control">
				<label class="label">
					<span class="label-text">Описание</span>
				</label>
				<textarea 
					name="description" 
					class="textarea textarea-bordered w-full" 
					rows="3"
					placeholder="Дополнительная информация"></textarea>
			</div>

			<!-- Кнопки действий -->
			<div class="modal-action">
				<button 
					type="button" 
					onclick="document.getElementById('addAccrualModal').close()" 
					class="btn btn-ghost">
					<i class="fas fa-times"></i>
					Отмена
				</button>
				<button 
					type="submit" 
					class="btn btn-primary">
					<i class="fas fa-save"></i>
					Сохранить
				</button>
			</div>
		</form>
	</div>
	<form method="dialog" class="modal-backdrop">
		<button>Закрыть</button>
	</form>
</dialog>

<!-- Модальное окно для редактирования начисления -->
<dialog id="editAccrualModal" class="modal">
	<div class="modal-box max-w-2xl">
		<h3 class="font-bold text-lg mb-4">
			<i class="fas fa-edit text-primary"></i>
			Редактировать начисление
		</h3>
		<form id="editAccrualForm" class="space-y-4">
			<input type="hidden" name="id" id="editAccrualId" />
			
			<!-- Название -->
			<div class="form-control">
				<label class="label">
					<span class="label-text">Название <span class="text-error">*</span></span>
				</label>
				<input 
					type="text" 
					name="name" 
					id="editAccrualName"
					class="input input-bordered w-full" 
					placeholder="Название начисления"
					required />
			</div>

			<!-- Номер -->
			<div class="form-control">
				<label class="label">
					<span class="label-text">Номер</span>
				</label>
				<input 
					type="text" 
					name="number" 
					id="editAccrualNumber"
					class="input input-bordered w-full" 
					placeholder="Номер документа" />
			</div>

			<div class="grid grid-cols-2 gap-4">
				<!-- Партнер -->
				<div class="form-control">
					<label class="label">
						<span class="label-text">Партнёр <span class="text-error">*</span></span>
					</label>
					<select 
						name="partner" 
						id="editAccrualPartner"
						class="select select-bordered w-full"
						required>
						<option value="">Выберите партнёра</option>
						<% for (let i = 0; i < partners.length; i++) { %>
							<option value="<%= partners[i].id %>"><%= partners[i].name %></option>
						<% } %>
					</select>
				</div>

				<!-- Статья расходов -->
				<div class="form-control">
					<label class="label">
						<span class="label-text">Статья расходов <span class="text-error">*</span></span>
					</label>
					<select 
						name="cost_item" 
						id="editAccrualCostItem"
						class="select select-bordered w-full"
						required>
						<option value="">Выберите статью</option>
						<% for (let i = 0; i < costItems.length; i++) { %>
							<option value="<%= costItems[i].id %>"><%= costItems[i].name %></option>
						<% } %>
					</select>
				</div>
			</div>

			<div class="grid grid-cols-2 gap-4">
				<!-- Сумма -->
				<div class="form-control">
					<label class="label">
						<span class="label-text">Сумма <span class="text-error">*</span></span>
					</label>
					<input 
						type="number" 
						name="sum" 
						id="editAccrualSum"
						class="input input-bordered w-full" 
						placeholder="0.00"
						step="0.01"
						min="0"
						required />
				</div>

				<!-- Срок оплаты -->
				<div class="form-control">
					<label class="label">
						<span class="label-text">Срок оплаты <span class="text-error">*</span></span>
					</label>
					<input 
						type="date" 
						name="repayment_date" 
						id="editAccrualRepaymentDate"
						class="input input-bordered w-full"
						required />
				</div>
			</div>

			<!-- Описание -->
			<div class="form-control">
				<label class="label">
					<span class="label-text">Описание</span>
				</label>
				<textarea 
					name="description" 
					id="editAccrualDescription"
					class="textarea textarea-bordered w-full" 
					rows="3"
					placeholder="Дополнительная информация"></textarea>
			</div>

			<!-- Принудительное закрытие -->
			<div class="form-control">
				<label class="label cursor-pointer justify-start gap-2">
					<input 
						type="checkbox" 
						name="Forced_closure" 
						id="editAccrualForcedClosure"
						class="checkbox checkbox-primary" />
					<span class="label-text">Принудительно закрыть</span>
				</label>
			</div>

			<!-- Кнопки действий -->
			<div class="modal-action">
				<button 
					type="button" 
					onclick="deleteAccrual()" 
					class="btn btn-error mr-auto">
					<i class="fas fa-trash"></i>
					Удалить
				</button>
				<button 
					type="button" 
					onclick="document.getElementById('editAccrualModal').close()" 
					class="btn btn-ghost">
					<i class="fas fa-times"></i>
					Отмена
				</button>
				<button 
					type="submit" 
					class="btn btn-primary">
					<i class="fas fa-save"></i>
					Сохранить
				</button>
			</div>
		</form>
	</div>
	<form method="dialog" class="modal-backdrop">
		<button>Закрыть</button>
	</form>
</dialog>

<!-- Модальное окно для разнесения платежей -->
<dialog id="paymentsModal" class="modal">
	<div class="modal-box max-w-full w-full h-screen m-0 rounded-none p-0 flex flex-col">
		<!-- Закрепленная шапка с кнопками -->
		<div class="sticky top-0 z-10 bg-base-100 border-b border-base-300 px-6 py-4 flex items-center justify-between">
			<div class="flex items-center gap-2">
				<i class="fas fa-link text-primary"></i>
				<h3 class="font-bold text-lg">Разнесение платежей по начислениям</h3>
			</div>
			<div class="flex items-center gap-2">
				<button onclick="savePaymentAllocations()" class="btn btn-primary btn-sm" id="btnSaveAllocations">
					<i class="fas fa-save"></i>
					Сохранить изменения
				</button>
				<form method="dialog" class="inline">
					<button class="btn btn-ghost btn-sm">
						<i class="fas fa-times"></i>
						Закрыть
					</button>
				</form>
			</div>
		</div>
		
		<!-- Контент с прокруткой -->
		<div id="paymentsModalContent" class="flex-1 overflow-y-auto px-6 py-4">
			<div class="flex items-center justify-center py-8">
				<span class="loading loading-spinner loading-lg"></span>
			</div>
		</div>
	</div>
	<form method="dialog" class="modal-backdrop">
		<button>close</button>
	</form>
</dialog>

<!-- Универсальное модальное окно уведомления -->
<dialog id="notificationModal" class="modal">
	<div class="modal-box">
		<h3 class="font-bold text-lg mb-2" id="notificationModalTitle">Сообщение</h3>
		<p class="py-2 text-base" id="notificationModalMessage"></p>
		<div class="modal-action">
			<button type="button" class="btn btn-primary" id="notificationModalConfirmBtn">Понятно</button>
		</div>
	</div>
	<form method="dialog" class="modal-backdrop">
		<button type="submit">Закрыть</button>
	</form>
</dialog>

<!-- Подтверждение действия -->
<dialog id="confirmationModal" class="modal">
	<div class="modal-box">
		<h3 class="font-bold text-lg mb-2" id="confirmationModalTitle">Подтверждение</h3>
		<p class="py-2 text-base" id="confirmationModalMessage"></p>
		<div class="modal-action flex gap-2">
			<button type="button" class="btn" id="confirmationModalCancelBtn">Отмена</button>
			<button type="button" class="btn btn-error" id="confirmationModalConfirmBtn">Подтвердить</button>
		</div>
	</div>
	<form method="dialog" class="modal-backdrop">
		<button type="submit">Закрыть</button>
	</form>
</dialog>

<!-- Модальное окно для выбора начисления или ожидаемого поступления -->
<dialog id="selectorModal" class="modal">
	<div class="modal-box max-w-3xl">
		<form method="dialog">
			<button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
		</form>
		<h3 class="font-bold text-lg mb-4" id="selectorModalTitle">
			<i class="fas fa-search"></i>
			Выбор
		</h3>
		
		<!-- Поле поиска -->
		<div class="form-control mb-4">
			<input 
				type="text" 
				id="selectorSearchInput" 
				placeholder="Поиск..." 
				class="input input-bordered w-full"
				oninput="filterSelectorItems()" />
		</div>
		
		<!-- Список -->
		<div class="overflow-y-auto max-h-96 border border-base-300 rounded-lg">
			<table class="table table-zebra table-sm table-pin-rows">
				<thead id="selectorTableHead">
					<!-- Заголовки будут заполнены через JS -->
				</thead>
				<tbody id="selectorList">
					<!-- Список будет заполнен через JS -->
				</tbody>
			</table>
		</div>
	</div>
	<form method="dialog" class="modal-backdrop">
		<button>close</button>
	</form>
</dialog>

<!-- Модальное окно подтверждения генерации -->
<dialog id="confirmGenerateModal" class="modal">
	<div class="modal-box">
		<h3 class="font-bold text-lg mb-4">
			<i class="fas fa-magic text-success"></i>
			Создание ожидаемых поступлений
		</h3>
		<p class="py-4">
			Создать ожидаемые поступления на <strong>текущий месяц</strong> на основе планируемых доходов?
		</p>
		<div class="modal-action">
			<form method="dialog" class="flex gap-2">
				<button class="btn btn-ghost">Отмена</button>
				<button class="btn btn-success" onclick="confirmGenerateWaitIncomes()">
					<i class="fas fa-check"></i>
					Создать
				</button>
			</form>
		</div>
	</div>
	<form method="dialog" class="modal-backdrop">
		<button>close</button>
	</form>
</dialog>

<!-- Модальное окно результата генерации -->
<dialog id="resultGenerateModal" class="modal">
	<div class="modal-box">
		<h3 class="font-bold text-lg mb-4" id="resultGenerateTitle">
			<i class="fas fa-check-circle text-success"></i>
			Результат
		</h3>
		<div id="resultGenerateContent" class="py-4">
			<!-- Контент будет заполнен через JS -->
		</div>
		<div class="modal-action">
			<form method="dialog">
				<button class="btn btn-primary" onclick="window.reloadWithLoader()">
					<i class="fas fa-sync-alt"></i>
					Обновить страницу
				</button>
			</form>
		</div>
	</div>
</dialog>

<!-- Модальное окно добавления ожидаемого платежа -->
<dialog id="addWaitIncomeModal" class="modal">
	<div class="modal-box">
		<form method="dialog">
			<button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
		</form>
		<h3 class="font-bold text-lg mb-4">
			<i class="fas fa-plus text-info"></i>
			Добавить ожидаемый платеж
		</h3>
		
		<form id="addWaitIncomeForm" class="space-y-4">
			<!-- Название -->
			<div class="form-control">
				<label class="label">
					<span class="label-text">Название платежа <span class="text-error">*</span></span>
				</label>
				<input 
					type="text" 
					id="waitIncomeName" 
					name="name"
					placeholder="Например: ООО Рога и копыта"
					class="input input-bordered w-full" 
					required />
			</div>
			
			<!-- Сумма -->
			<div class="form-control">
				<label class="label">
					<span class="label-text">Сумма <span class="text-error">*</span></span>
				</label>
				<div class="input-group">
					<input 
						type="number" 
						id="waitIncomeSum" 
						name="sum"
						placeholder="100000"
						step="0.01"
						min="0"
						class="input input-bordered w-full" 
						required />
					<span class="input-group-text">₽</span>
				</div>
				<label class="label">
					<span class="label-text-alt">Введите сумму без учета налогов (13% будет вычтено автоматически)</span>
				</label>
			</div>
			
			<!-- Месяц начисления -->
			<div class="form-control">
				<label class="label">
					<span class="label-text">Месяц начисления <span class="text-error">*</span></span>
				</label>
				<input 
					type="month" 
					id="waitIncomeMonth" 
					name="accrual_month"
					class="input input-bordered w-full" 
					required />
			</div>
			
			<!-- Кнопки -->
			<div class="modal-action">
				<button type="button" onclick="document.getElementById('addWaitIncomeModal').close()" class="btn btn-ghost">
					Отмена
				</button>
				<button type="submit" class="btn btn-info" id="btnSubmitWaitIncome">
					<i class="fas fa-save"></i>
					Сохранить
				</button>
			</div>
		</form>
	</div>
	<form method="dialog" class="modal-backdrop">
		<button>close</button>
	</form>
</dialog>

<!-- Модальное окно редактирования ожидаемого платежа -->
<dialog id="editWaitIncomeModal" class="modal">
	<div class="modal-box">
		<form method="dialog">
			<button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
		</form>
		<h3 class="font-bold text-lg mb-4">
			<i class="fas fa-edit text-warning"></i>
			Редактировать ожидаемый платеж
		</h3>
		
		<form id="editWaitIncomeForm" class="space-y-4">
			<input type="hidden" id="editWaitIncomeId" name="id" />
			
			<!-- Название -->
			<div class="form-control">
				<label class="label">
					<span class="label-text">Название платежа <span class="text-error">*</span></span>
				</label>
				<input 
					type="text" 
					id="editWaitIncomeName" 
					name="name"
					placeholder="Например: ООО Рога и копыта"
					class="input input-bordered w-full" 
					required />
			</div>
			
			<!-- Сумма -->
			<div class="form-control">
				<label class="label">
					<span class="label-text">Сумма <span class="text-error">*</span></span>
				</label>
				<div class="input-group">
					<input 
						type="number" 
						id="editWaitIncomeSum" 
						name="sum"
						placeholder="100000"
						step="0.01"
						min="0"
						class="input input-bordered w-full" 
						required />
					<span class="input-group-text">₽</span>
				</div>
				<label class="label">
					<span class="label-text-alt">Введите сумму без учета налогов (13% будет вычтено автоматически)</span>
				</label>
			</div>
			
			<!-- Месяц начисления -->
			<div class="form-control">
				<label class="label">
					<span class="label-text">Месяц начисления <span class="text-error">*</span></span>
				</label>
				<input 
					type="month" 
					id="editWaitIncomeMonth" 
					name="accrual_month"
					class="input input-bordered w-full" 
					required />
			</div>
			
			<!-- Кнопки -->
			<div class="modal-action">
				<button type="button" onclick="deleteWaitIncome()" class="btn btn-error btn-outline" id="btnDeleteWaitIncome">
					<i class="fas fa-trash"></i>
					Удалить
				</button>
				<button type="button" onclick="document.getElementById('editWaitIncomeModal').close()" class="btn btn-ghost">
					Отмена
				</button>
				<button type="submit" class="btn btn-warning" id="btnEditWaitIncome">
					<i class="fas fa-save"></i>
					Сохранить изменения
				</button>
			</div>
		</form>
	</div>
	<form method="dialog" class="modal-backdrop">
		<button>close</button>
	</form>
</dialog>

<!-- Модальное окно для ручного платежа -->
<dialog id="manualPaymentModal" class="modal">
	<div class="modal-box max-w-2xl">
		<form method="dialog">
			<button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
		</form>
		<h3 class="font-bold text-lg mb-4">
			<i class="fas fa-money-bill-wave text-success"></i>
			Ручной платеж
		</h3>
		
		<form id="manualPaymentForm" class="space-y-4">
			<input type="hidden" id="manualPaymentAccrualId" name="accural" />
			
			<!-- Информация о начислении -->
			<div class="alert alert-info">
				<i class="fas fa-info-circle"></i>
				<div>
					<p class="font-semibold" id="manualPaymentAccrualName">—</p>
					<p class="text-sm">Остаток к оплате: <span class="font-bold" id="manualPaymentBalance">—</span></p>
				</div>
			</div>
			
			<div class="grid grid-cols-2 gap-4">
				<!-- Сумма платежа -->
				<div class="form-control">
					<label class="label">
						<span class="label-text">Сумма платежа <span class="text-error">*</span></span>
					</label>
					<div class="input-group">
						<input 
							type="number" 
							id="manualPaymentSum" 
							name="sum"
							placeholder="0.00"
							step="0.01"
							min="0.01"
							class="input input-bordered w-full" 
							required />
						<span class="input-group-text">₽</span>
					</div>
				</div>
				
				<!-- Дата платежа -->
				<div class="form-control">
					<label class="label">
						<span class="label-text">Дата платежа <span class="text-error">*</span></span>
					</label>
					<input 
						type="date" 
						id="manualPaymentDate" 
						name="date"
						class="input input-bordered w-full" 
						required />
				</div>
			</div>
			
			<!-- Описание -->
			<div class="form-control">
				<label class="label">
					<span class="label-text">Описание</span>
				</label>
				<textarea 
					id="manualPaymentDescription" 
					name="description"
					class="textarea textarea-bordered w-full" 
					rows="2"
					placeholder="Дополнительная информация о платеже"></textarea>
			</div>
			
			<!-- Загрузка чеков -->
			<div class="form-control">
				<label class="label">
					<span class="label-text">Чеки / Подтверждения</span>
				</label>
				<input 
					type="file" 
					id="manualPaymentReceipts" 
					name="receipt"
					class="file-input file-input-bordered w-full"
					accept="image/*,.pdf"
					multiple />
				<label class="label">
					<span class="label-text-alt">Можно загрузить несколько файлов (фото чеков, PDF документы)</span>
				</label>
			</div>
			
			<!-- Кнопки -->
			<div class="modal-action">
				<button type="button" onclick="document.getElementById('manualPaymentModal').close()" class="btn btn-ghost">
					<i class="fas fa-times"></i>
					Отмена
				</button>
				<button type="submit" class="btn btn-success" id="btnSubmitManualPayment">
					<i class="fas fa-save"></i>
					Создать платеж
				</button>
			</div>
		</form>
	</div>
	<form method="dialog" class="modal-backdrop">
		<button>close</button>
	</form>
</dialog>

<script>
// Вспомогательные модальные окна для уведомлений и подтверждений
const notificationModal = document.getElementById('notificationModal');
const notificationModalTitle = document.getElementById('notificationModalTitle');
const notificationModalMessage = document.getElementById('notificationModalMessage');
const notificationModalConfirmBtn = document.getElementById('notificationModalConfirmBtn');
let notificationModalResolver = null;

function showNotificationModal({ title = 'Сообщение', message = '', confirmText = 'Понятно' } = {}) {
	if (!notificationModal) {
		return Promise.resolve();
	}

	notificationModalTitle.textContent = title;
	notificationModalMessage.textContent = message;
	notificationModalConfirmBtn.textContent = confirmText;

	if (notificationModal.open) {
		notificationModal.close();
	}

	return new Promise(resolve => {
		notificationModalResolver = resolve;
		notificationModal.showModal();
	});
}

function resolveNotificationModal() {
	if (notificationModalResolver) {
		const resolve = notificationModalResolver;
		notificationModalResolver = null;
		resolve();
	}
}

notificationModalConfirmBtn?.addEventListener('click', () => {
	if (notificationModal?.open) {
		notificationModal.close();
	} else {
		resolveNotificationModal();
	}
});

notificationModal?.addEventListener('close', () => {
	resolveNotificationModal();
});

notificationModal?.addEventListener('cancel', event => {
	event.preventDefault();
	resolveNotificationModal();
	if (!notificationModal.open) {
		return;
	}
	notificationModal.close();
});

const confirmationModal = document.getElementById('confirmationModal');
const confirmationModalTitle = document.getElementById('confirmationModalTitle');
const confirmationModalMessage = document.getElementById('confirmationModalMessage');
const confirmationModalConfirmBtn = document.getElementById('confirmationModalConfirmBtn');
const confirmationModalCancelBtn = document.getElementById('confirmationModalCancelBtn');
let confirmationModalResolver = null;

function showConfirmationModal({
	title = 'Подтвердите действие',
	message = '',
	confirmText = 'Подтвердить',
	cancelText = 'Отмена'
} = {}) {
	if (!confirmationModal) {
		return Promise.resolve(false);
	}

	confirmationModalTitle.textContent = title;
	confirmationModalMessage.textContent = message;
	confirmationModalConfirmBtn.textContent = confirmText;
	confirmationModalCancelBtn.textContent = cancelText;

	if (confirmationModal.open) {
		confirmationModal.close();
	}

	return new Promise(resolve => {
		confirmationModalResolver = resolve;
		confirmationModal.showModal();
	});
}

function closeConfirmationModal(result) {
	if (confirmationModalResolver) {
		const resolve = confirmationModalResolver;
		confirmationModalResolver = null;
		resolve(Boolean(result));
	}
	if (confirmationModal?.open) {
		confirmationModal.close();
	}
}

confirmationModalConfirmBtn?.addEventListener('click', () => {
	closeConfirmationModal(true);
});

confirmationModalCancelBtn?.addEventListener('click', () => {
	closeConfirmationModal(false);
});

confirmationModal?.addEventListener('cancel', event => {
	event.preventDefault();
	closeConfirmationModal(false);
});

confirmationModal?.addEventListener('close', () => {
	if (confirmationModalResolver) {
		const resolve = confirmationModalResolver;
		confirmationModalResolver = null;
		resolve(false);
	}
});

// Глобальные переменные для селектора начислений
let currentPaymentId = null;
let currentPaymentType = null; // 'income' или 'expense'
window.availableAccruals = [];
window.availableWaitIncomes = [];

function resolvePaymentType(indicator) {
	const normalized = (indicator || '').toString().trim().toLowerCase();

	if (!normalized) {
		return 'expense';
	}

	if (
		normalized.includes('приход') ||
		normalized.includes('credit') ||
		normalized === 'crdt' ||
		normalized === 'in'
	) {
		return 'income';
	}

	return 'expense';
}
function filterByCostItem() {
	applyFilters();
}

function filterByPartner() {
	applyFilters();
}

function applyFilters() {
	const partnerFilterValue = document.getElementById('partnerFilter').value;
	const costItemFilterValue = document.getElementById('costItemFilter').value;
	const rows = document.querySelectorAll('.accrual-row');
	
	let visibleCount = 0;
	rows.forEach(row => {
		const partnerName = row.getAttribute('data-partner-name');
		const costItem = row.getAttribute('data-cost-item');
		
		// Проверяем оба фильтра одновременно
		const partnerMatch = partnerFilterValue === '' || partnerName === partnerFilterValue;
		const costItemMatch = costItemFilterValue === '' || costItem === costItemFilterValue;
		
		if (partnerMatch && costItemMatch) {
			row.style.display = '';
			visibleCount++;
		} else {
			row.style.display = 'none';
		}
	});
}

function toggleForcedClosed() {
	const block = document.getElementById('forcedClosedBlock');
	const btn = document.getElementById('btnToggleForcedClosed');
	
	if (!block || !btn) {
		return;
	}
	
	const count = btn.dataset.count || '0';
	const currentDisplay = window.getComputedStyle(block).display;
	
	if (currentDisplay === 'none') {
		block.style.display = 'block';
		block.style.visibility = 'visible';
		block.style.opacity = '1';
		btn.innerHTML = '<i class="fas fa-ban"></i> Скрыть';
		btn.classList.remove('btn-outline');
		
		// Принудительно прокручиваем к блоку
		setTimeout(() => {
			block.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
		}, 100);
	} else {
		block.style.display = 'none';
		btn.innerHTML = '<i class="fas fa-ban"></i> Принудительно закрытые (' + count + ')';
		btn.classList.add('btn-outline');
	}
}

function toggleFullyPaid() {
	const block = document.getElementById('fullyPaidBlock');
	const btn = document.getElementById('btnToggleFullyPaid');
	
	if (!block || !btn) {
		return;
	}
	
	const count = btn.dataset.count || '0';
	const currentDisplay = window.getComputedStyle(block).display;
	
	if (currentDisplay === 'none') {
		block.style.display = 'block';
		block.style.visibility = 'visible';
		block.style.opacity = '1';
		btn.innerHTML = '<i class="fas fa-check-circle"></i> Скрыть';
		btn.classList.remove('btn-outline');
		
		// Принудительно прокручиваем к блоку
		setTimeout(() => {
			block.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
		}, 100);
	} else {
		block.style.display = 'none';
		btn.innerHTML = '<i class="fas fa-check-circle"></i> Полностью оплаченные (' + count + ')';
		btn.classList.add('btn-outline');
	}
}

window.loadBankStatements = async function() {
	const btn = document.getElementById('btnLoadBank');
	const resultDiv = document.getElementById('bankLoadResult');
	
	// Отключаем кнопку
	btn.disabled = true;
	btn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Загрузка...';
	
	resultDiv.style.display = 'none';
	resultDiv.innerHTML = '';
	
	let statementId = null;
	
	try {
		// Инициируем выписку (даты определяются автоматически на бэкенде)
		const initResponse = await fetch('/xapi/tochka/init-statement', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({})
		});
		
		const initData = await initResponse.json();
		
		if (!initData.success) {
			throw new Error(initData.message || 'Ошибка инициализации выписки');
		}
		
		statementId = initData.data.statementId;
		
		// Функция для проверки статуса выписки с повторными попытками
		const checkStatementStatus = async (attemptNumber = 1, maxAttempts = 20) => {
			// Показываем прогресс
			resultDiv.style.display = 'block';
			resultDiv.innerHTML = `
				<div class="alert alert-info">
					<i class="fas fa-spinner fa-spin"></i>
					<div>
						<p class="font-semibold">Обработка выписки...</p>
						<p class="text-sm">Попытка ${attemptNumber} из ${maxAttempts}</p>
						<p class="text-xs text-base-content/70 mt-1">Обычно занимает 5-15 секунд</p>
					</div>
				</div>
			`;
			
			// Ждём перед запросом (увеличивающаяся задержка)
			const delay = Math.min(3000 + (attemptNumber - 1) * 1000, 10000);
			await new Promise(resolve => setTimeout(resolve, delay));
			
			// Получаем выписку
			const statementResponse = await fetch(`/xapi/tochka/statement?statementId=${statementId}`);
			const statementData = await statementResponse.json();
			
			if (!statementData.success) {
				throw new Error(statementData.message || 'Ошибка получения выписки');
			}
			
			const status = statementData.status;
			
			// Если выписка готова - сохраняем
			if (status === 'Ready') {
				if (statementData.saveResult) {
					const { saved, skipped, skippedInternal, errors } = statementData.saveResult;
					
					// Формируем HTML с детальной информацией об ошибках
					let errorsHtml = '';
					if (errors.length > 0) {
						const warnings = errors.filter(e => e.warning);
						const realErrors = errors.filter(e => !e.warning);
						
						if (warnings.length > 0) {
							errorsHtml += `
								<details class="collapse collapse-arrow bg-warning/10 mt-2">
									<summary class="collapse-title text-sm font-medium">
										<i class="fas fa-exclamation-triangle text-warning"></i>
										Предупреждения (${warnings.length})
									</summary>
									<div class="collapse-content">
										<div class="text-xs space-y-2 mt-2">
											${warnings.map((err, idx) => `
												<div class="p-2 bg-base-100 rounded">
													<p><strong>#${err.index || idx}:</strong> ${err.warning || err.error}</p>
													${err.transactionId ? `<p class="text-base-content/60">ID: ${err.transactionId}</p>` : ''}
													${err.availableFields ? `<p class="text-base-content/50 text-xs mt-1">Доступные поля: ${err.availableFields}</p>` : ''}
												</div>
											`).join('')}
										</div>
									</div>
								</details>
							`;
						}
						
						if (realErrors.length > 0) {
							errorsHtml += `
								<details class="collapse collapse-arrow bg-error/10 mt-2">
									<summary class="collapse-title text-sm font-medium">
										<i class="fas fa-times-circle text-error"></i>
										Ошибки (${realErrors.length})
									</summary>
									<div class="collapse-content">
										<div class="text-xs space-y-2 mt-2">
											${realErrors.map((err, idx) => `
												<div class="p-2 bg-base-100 rounded">
													<p><strong>#${err.index || idx}:</strong> ${err.error}</p>
													${err.transactionId ? `<p class="text-base-content/60">ID: ${err.transactionId}</p>` : ''}
												</div>
											`).join('')}
										</div>
									</div>
								</details>
							`;
						}
					}
					
					// Информация о пропущенных внутренних переводах
					let internalTransfersInfo = '';
					if (skippedInternal > 0) {
						internalTransfersInfo = `
							<div class="alert alert-info text-xs mt-2">
								<i class="fas fa-info-circle"></i>
								<span>Пропущено внутренних переводов (собственные средства): ${skippedInternal}</span>
							</div>
						`;
					}
					
					resultDiv.innerHTML = `
						<div class="alert alert-success">
							<i class="fas fa-check-circle"></i>
							<div class="w-full">
								<p class="font-semibold">Выписка загружена успешно!</p>
								<p class="text-sm">
									Сохранено: ${saved}, 
									Пропущено дубликатов: ${skipped}, 
									${skippedInternal > 0 ? `Игнорировано внутренних: ${skippedInternal}, ` : ''}
									Проблем: ${errors.length}
								</p>
								${internalTransfersInfo}
								${errorsHtml}
							</div>
						</div>
					`;
					
					// Перезагружаем страницу для обновления баланса
					window.reloadWithLoader();
				} else {
					throw new Error('Выписка готова, но данные не были сохранены');
				}
			} 
			// Если ещё обрабатывается - повторяем
			else if (status === 'Created' || status === 'Processing') {
				if (attemptNumber < maxAttempts) {
					return await checkStatementStatus(attemptNumber + 1, maxAttempts);
				} else {
					throw new Error(`Превышено время ожидания. Выписка всё ещё в статусе: ${status}. Попробуйте позже.`);
				}
			}
			// Неизвестный статус
			else {
				throw new Error(`Неожиданный статус выписки: ${status}`);
			}
		};
		
		// Запускаем проверку статуса
		await checkStatementStatus();
		
	} catch (error) {
		resultDiv.style.display = 'block';
		resultDiv.innerHTML = `
			<div class="alert alert-error">
				<i class="fas fa-exclamation-circle"></i>
				<div>
					<p class="font-semibold">Ошибка загрузки выписки</p>
					<p class="text-sm">${error.message}</p>
					${statementId ? `<p class="text-xs text-base-content/70 mt-1">ID выписки: ${statementId}</p>` : ''}
				</div>
			</div>
		`;
	} finally {
		// Возвращаем кнопку в исходное состояние
		btn.disabled = false;
		btn.innerHTML = '<i class="fas fa-download"></i> Загрузить выписку';
	}
}

async function generateWaitIncomes() {
	// Показываем модальное окно подтверждения
	document.getElementById('confirmGenerateModal').showModal();
}

async function confirmGenerateWaitIncomes() {
	const btn = document.getElementById('btnGenerateWaitIncomes');
	
	// Закрываем модальное окно подтверждения
	document.getElementById('confirmGenerateModal').close();
	
	// Отключаем кнопку
	btn.disabled = true;
	btn.innerHTML = '<span class="loading loading-spinner loading-xs"></span> Создание...';
	
	try {
		const response = await fetch('/xapi/wait-incomes/generate-from-planned', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({})
		});
		
		const data = await response.json();
		
		if (!data.success) {
			throw new Error(data.message || 'Ошибка генерации');
		}
		
		// Показываем результат в модальном окне
		const title = document.getElementById('resultGenerateTitle');
		const content = document.getElementById('resultGenerateContent');
		
		// Форматируем месяц для отображения
		const monthDate = new Date(data.month);
		const monthName = monthDate.toLocaleDateString('ru-RU', { year: 'numeric', month: 'long' });
		
		// Проверяем наличие отладочной информации
		const debugInfo = data.debug || {};
		const hasErrors = data.errors && data.errors.length > 0;
		
		let errorsHtml = '';
		if (hasErrors) {
			errorsHtml = `
				<div class="alert alert-warning">
					<i class="fas fa-exclamation-triangle"></i>
					<div>
						<p class="font-semibold">Обнаружены ошибки при обработке:</p>
						<ul class="text-sm mt-2 list-disc list-inside">
							${data.errors.map(err => '<li>' + err.name + ': ' + err.error + '</li>').join('')}
						</ul>
					</div>
				</div>
			`;
		}
		
		let debugHtml = '';
		if (debugInfo.plannedIncomesCount !== undefined) {
			debugHtml = `
				<div class="alert alert-info">
					<i class="fas fa-info-circle"></i>
					<div class="text-sm">
						<p><strong>Отладочная информация:</strong></p>
						<p>Найдено записей в planned_income: ${debugInfo.plannedIncomesCount}</p>
						${debugInfo.message ? '<p>' + debugInfo.message + '</p>' : ''}
						${debugInfo.totalProcessed !== undefined ? '<p>Всего обработано: ' + debugInfo.totalProcessed + '</p>' : ''}
					</div>
				</div>
			`;
		}
		
		title.innerHTML = '<i class="fas fa-check-circle text-success"></i> Успешно создано';
		content.innerHTML = `
			<div class="space-y-3">
				<div class="alert alert-success">
					<i class="fas fa-info-circle"></i>
					<span>${data.message}</span>
				</div>
				${debugHtml}
				${errorsHtml}
				<div class="stats stats-vertical lg:stats-horizontal shadow w-full">
					<div class="stat">
						<div class="stat-title">Месяц</div>
						<div class="stat-value text-lg">${monthName}</div>
					</div>
					<div class="stat">
						<div class="stat-title">Создано</div>
						<div class="stat-value text-success">${data.generated}</div>
						<div class="stat-desc">новых записей</div>
					</div>
					<div class="stat">
						<div class="stat-title">Пропущено</div>
						<div class="stat-value text-warning">${data.skipped}</div>
						<div class="stat-desc">уже существуют</div>
					</div>
				</div>
			</div>
		`;
		
		document.getElementById('resultGenerateModal').showModal();
		
	} catch (error) {
		// Показываем ошибку в модальном окне
		const title = document.getElementById('resultGenerateTitle');
		const content = document.getElementById('resultGenerateContent');
		
		title.innerHTML = '<i class="fas fa-exclamation-circle text-error"></i> Ошибка';
		content.innerHTML = `
			<div class="alert alert-error">
				<i class="fas fa-times-circle"></i>
				<span>${error.message}</span>
			</div>
		`;
		
		document.getElementById('resultGenerateModal').showModal();
	} finally {
		// Возвращаем кнопку в исходное состояние
		btn.disabled = false;
		btn.innerHTML = '<i class="fas fa-magic"></i> Создать ожидаемые поступления';
	}
}

window.openPaymentsModal = async function() {
	const modal = document.getElementById('paymentsModal');
	const content = document.getElementById('paymentsModalContent');
	
	// Показываем модальное окно
	modal.showModal();
	
	// Загружаем неразнесенные платежи
	try {
		const response = await fetch('/xapi/tochka/unallocated-payments');
		const data = await response.json();
		
		if (!data.success) {
			throw new Error(data.message || 'Ошибка загрузки платежей');
		}
		
		if (data.payments.length === 0) {
			content.innerHTML = `
				<div class="alert alert-info">
					<i class="fas fa-info-circle"></i>
					<span>Все платежи разнесены. Неразнесенных платежей нет.</span>
				</div>
			`;
			return;
		}
		
		// Нормализуем типы платежей
		const paymentsWithType = data.payments.map(payment => {
			return {
				...payment,
				paymentType: resolvePaymentType(payment.creditDebitIndicator)
			};
		});

		// Подсчитываем количество платежей по типам
		const incomeCount = paymentsWithType.filter(p => p.paymentType === 'income').length;
		const expenseCount = paymentsWithType.filter(p => p.paymentType === 'expense').length;
		const totalCount = paymentsWithType.length;
		
		// Формируем таблицу с платежами
		let html = `
			<!-- Переключатель типа платежей -->
			<div class="flex items-center gap-3 mb-4 p-4 bg-base-200 rounded-lg">
				<span class="text-sm font-medium">Показать:</span>
				<div class="btn-group">
					<button 
						type="button"
						class="btn btn-sm btn-active payment-filter-btn" 
						data-filter="all"
						onclick="filterPaymentsByType(event, 'all')">
						<i class="fas fa-list"></i>
						Все (${totalCount})
					</button>
					<button 
						type="button"
						class="btn btn-sm payment-filter-btn" 
						data-filter="income"
						onclick="filterPaymentsByType(event, 'income')">
						<i class="fas fa-arrow-down text-success"></i>
						Приход (${incomeCount})
					</button>
					<button 
						type="button"
						class="btn btn-sm payment-filter-btn" 
						data-filter="expense"
						onclick="filterPaymentsByType(event, 'expense')">
						<i class="fas fa-arrow-up text-error"></i>
						Расход (${expenseCount})
					</button>
				</div>
			</div>
			
			<table class="table table-zebra table-sm">
				<thead>
					<tr>
						<th>Дата</th>
						<th>Тип</th>
						<th>Плательщик</th>
						<th class="text-right min-w-32">Сумма</th>
						<th>Описание</th>
						<th>Начисление / Ожид. поступление</th>
						<th class="text-center">Игнор.</th>
					</tr>
				</thead>
				<tbody>
		`;
		
		paymentsWithType.forEach(payment => {
			const isIncome = payment.paymentType === 'income';
			
			html += `
				<tr class="payment-row" data-payment-id="${payment.id}" data-payment-type="${payment.paymentType}">
					<td class="whitespace-nowrap text-sm">${formatDateShort(payment.date)}</td>
					<td class="whitespace-nowrap">
						<span class="badge badge-sm ${isIncome ? 'badge-success' : 'badge-error'}">
							${payment.creditDebitIndicator}
						</span>
					</td>
					<td class="text-sm">${payment.payer || '—'}</td>
					<td class="text-right font-semibold whitespace-nowrap">${formatCurrencyJS(payment.sum)}</td>
					<td class="text-sm max-w-xs">${payment.description || '—'}</td>
					<td>
						<div class="flex items-center gap-2">
							<input 
								type="hidden" 
								class="payment-link-id"
								data-payment-id="${payment.id}"
								data-link-type="${isIncome ? 'wait_income' : 'accural'}"
								value="" />
							<span class="text-sm text-base-content/70 payment-link-label flex-1" data-payment-id="${payment.id}">
								Не выбрано
							</span>
							<button 
								class="btn btn-xs btn-outline ${isIncome ? 'btn-success' : 'btn-primary'}"
								onclick="openSelector('${payment.id}', '${payment.paymentType}')">
								<i class="fas fa-search"></i>
								Выбрать
							</button>
							<button 
								class="btn btn-xs btn-ghost btn-circle payment-clear-btn hidden"
								data-payment-id="${payment.id}"
								onclick="clearSelection('${payment.id}')"
								title="Очистить">
								<i class="fas fa-times"></i>
							</button>
						</div>
					</td>
					<td class="text-center">
						<input 
							type="checkbox" 
							class="checkbox checkbox-sm payment-ignore-checkbox"
							data-payment-id="${payment.id}"
							${payment.ignore ? 'checked' : ''} />
					</td>
				</tr>
			`;
		});
		
		html += `
				</tbody>
			</table>
			<div class="mt-4 text-sm text-base-content/60">
				<p><strong>Всего неразнесенных платежей:</strong> ${totalCount}</p>
			</div>
		`;
		
		content.innerHTML = html;
		filterPaymentsByType('all');
		
		// Сохраняем списки глобально для селекторов
		window.availableAccruals = data.accruals;
		window.availableWaitIncomes = data.waitIncomes || [];
		
	} catch (error) {
		content.innerHTML = `
			<div class="alert alert-error">
				<i class="fas fa-exclamation-circle"></i>
				<span>${error.message}</span>
			</div>
		`;
	}
}

function formatDateShort(dateStr) {
	if (!dateStr) return '—';
	try {
		const date = new Date(dateStr);
		return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
	} catch {
		return dateStr;
	}
}

function formatCurrencyJS(amount) {
	if (amount === null || amount === undefined) return '—';
	const num = Number(amount);
	if (!Number.isFinite(num)) return '—';
	return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' ₽';
}

window.openSelector = function(paymentId, paymentType) {
	currentPaymentId = paymentId;
	currentPaymentType = paymentType;
	
	const modal = document.getElementById('selectorModal');
	const title = document.getElementById('selectorModalTitle');
	const tableHead = document.getElementById('selectorTableHead');
	const list = document.getElementById('selectorList');
	const searchInput = document.getElementById('selectorSearchInput');
	
	let html = '';
	
	if (paymentType === 'income') {
		// Ожидаемые поступления
		title.innerHTML = '<i class="fas fa-search"></i> Выбор ожидаемого поступления';
		searchInput.placeholder = 'Поиск по названию...';
		
		tableHead.innerHTML = `
			<tr>
				<th>Название</th>
				<th class="text-right">Сумма</th>
				<th>Дата поступления</th>
				<th class="text-center">Действие</th>
			</tr>
		`;
		
		window.availableWaitIncomes.forEach(item => {
			const escapedName = item.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
			
			html += `
				<tr class="selector-row" data-search="${item.name.toLowerCase()}">
					<td>
						<div class="font-semibold text-sm">${item.name}</div>
					</td>
					<td class="text-right whitespace-nowrap">
						<span class="font-semibold text-success">${formatCurrencyJS(item.sum)}</span>
					</td>
					<td class="whitespace-nowrap">
						${formatDateShort(item.accrualMonth)}
					</td>
					<td class="text-center">
						<button 
							class="btn btn-xs btn-success"
							onclick="selectItem('${item.id}', '${escapedName}', 'income')">
							Выбрать
						</button>
					</td>
				</tr>
			`;
		});
		
	} else {
		// Начисления (расходы)
		title.innerHTML = '<i class="fas fa-search"></i> Выбор начисления';
		searchInput.placeholder = 'Поиск по названию, номеру, партнеру или статье затрат...';
		
		tableHead.innerHTML = `
			<tr>
				<th>Начисление</th>
				<th>Партнер / Статья</th>
				<th class="text-right">Баланс</th>
				<th class="text-center">Действие</th>
			</tr>
		`;
		
		window.availableAccruals.forEach(accrual => {
			const escapedName = accrual.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
			const escapedNumber = accrual.number.replace(/'/g, "\\'").replace(/"/g, '&quot;');
			
			html += `
				<tr class="selector-row" data-search="${accrual.name.toLowerCase()} ${accrual.number.toLowerCase()} ${(accrual.partnerName || '').toLowerCase()} ${(accrual.costItemName || '').toLowerCase()}">
					<td>
						<div class="font-semibold text-sm">${accrual.name}</div>
						<div class="text-xs text-base-content/60">${accrual.number}</div>
					</td>
					<td>
						<div class="text-sm">${accrual.costItemName || '—'}</div>
						<div class="text-xs text-base-content/60">${accrual.partnerName || '—'}</div>
					</td>
					<td class="text-right whitespace-nowrap">
						<span class="font-semibold text-info">${formatCurrencyJS(accrual.balance)}</span>
					</td>
					<td class="text-center">
						<button 
							class="btn btn-xs btn-primary"
							onclick="selectItem('${accrual.id}', '${escapedName}', 'expense', '${escapedNumber}')">
							Выбрать
						</button>
					</td>
				</tr>
			`;
		});
	}
	
	list.innerHTML = html;
	searchInput.value = '';
	modal.showModal();
}

window.filterSelectorItems = function() {
	const searchValue = document.getElementById('selectorSearchInput').value.toLowerCase();
	const rows = document.querySelectorAll('.selector-row');
	
	rows.forEach(row => {
		const searchData = row.getAttribute('data-search');
		if (searchData.includes(searchValue)) {
			row.style.display = '';
		} else {
			row.style.display = 'none';
		}
	});
}

window.selectItem = function(itemId, itemName, type, itemNumber) {
	if (!currentPaymentId) return;
	
	// Обновляем скрытое поле
	const hiddenInput = document.querySelector(`.payment-link-id[data-payment-id="${currentPaymentId}"]`);
	if (hiddenInput) {
		hiddenInput.value = itemId;
	}
	
	// Обновляем метку
	const label = document.querySelector(`.payment-link-label[data-payment-id="${currentPaymentId}"]`);
	if (label) {
		if (type === 'income') {
			label.textContent = itemName;
		} else {
			// Показываем номер только если он не пустой
			label.textContent = itemNumber ? `${itemName} (${itemNumber})` : itemName;
		}
		label.classList.remove('text-base-content/70');
		label.classList.add('text-base-content', 'font-medium');
	}
	
	// Показываем кнопку очистки
	const clearBtn = document.querySelector(`.payment-clear-btn[data-payment-id="${currentPaymentId}"]`);
	if (clearBtn) {
		clearBtn.classList.remove('hidden');
	}
	
	// Закрываем модальное окно
	document.getElementById('selectorModal').close();
	currentPaymentId = null;
	currentPaymentType = null;
}

window.clearSelection = function(paymentId) {
	// Очищаем скрытое поле
	const hiddenInput = document.querySelector(`.payment-link-id[data-payment-id="${paymentId}"]`);
	if (hiddenInput) {
		hiddenInput.value = '';
	}
	
	// Сбрасываем метку
	const label = document.querySelector(`.payment-link-label[data-payment-id="${paymentId}"]`);
	if (label) {
		label.textContent = 'Не выбрано';
		label.classList.add('text-base-content/70');
		label.classList.remove('text-base-content', 'font-medium');
	}
	
	// Скрываем кнопку очистки
	const clearBtn = document.querySelector(`.payment-clear-btn[data-payment-id="${paymentId}"]`);
	if (clearBtn) {
		clearBtn.classList.add('hidden');
	}
}

window.filterPaymentsByType = function(arg1, arg2) {
	let event = null;
	let filterType = 'all';

	if (typeof arg1 === 'string') {
		filterType = arg1;
	} else {
		event = arg1 instanceof Event ? arg1 : null;
		filterType = typeof arg2 === 'string' ? arg2 : 'all';
	}

	if (event) {
		event.preventDefault();
		event.stopPropagation();
	}

	// Обновляем активную кнопку
	document.querySelectorAll('.payment-filter-btn').forEach(btn => {
		if (btn.getAttribute('data-filter') === filterType) {
			btn.classList.add('btn-active');
		} else {
			btn.classList.remove('btn-active');
		}
	});
	
	// Фильтруем строки
	const rows = document.querySelectorAll('.payment-row');
	let visibleCount = 0;
	
	rows.forEach(row => {
		const paymentType = row.getAttribute('data-payment-type');
		
		if (filterType === 'all') {
			row.style.display = '';
			visibleCount++;
		} else if (paymentType === filterType) {
			row.style.display = '';
			visibleCount++;
		} else {
			row.style.display = 'none';
		}
	});
}



window.savePaymentAllocations = async function() {
	const btn = document.getElementById('btnSaveAllocations');
	btn.disabled = true;
	btn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Сохранение...';
	
	// Собираем данные из формы
	const allocations = [];
	const hiddenInputs = document.querySelectorAll('.payment-link-id');
	
	hiddenInputs.forEach(hiddenInput => {
		const paymentId = hiddenInput.getAttribute('data-payment-id');
		const linkType = hiddenInput.getAttribute('data-link-type');
		const linkId = hiddenInput.value;
		const ignoreCheckbox = document.querySelector(`.payment-ignore-checkbox[data-payment-id="${paymentId}"]`);
		const ignore = ignoreCheckbox ? ignoreCheckbox.checked : false;
		
		const allocation = {
			paymentId,
			ignore
		};
		
		// Добавляем правильное поле в зависимости от типа связи
		if (linkType === 'wait_income') {
			allocation.waitIncomeId = linkId || null;
			allocation.accrualId = null;
		} else {
			allocation.accrualId = linkId || null;
			allocation.waitIncomeId = null;
		}
		
		allocations.push(allocation);
	});
	
	try {
		const response = await fetch('/xapi/tochka/save-allocations', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ allocations })
		});
		
		const data = await response.json();
		
		if (!data.success) {
			throw new Error(data.message || 'Ошибка сохранения');
		}
		
		// Закрываем модальное окно и перезагружаем страницу
		document.getElementById('paymentsModal').close();
		window.reloadWithLoader();
		
	} catch (error) {
		await showNotificationModal({
			title: 'Ошибка сохранения',
			message: error.message || 'Не удалось сохранить изменения'
		});
		btn.disabled = false;
		btn.innerHTML = '<i class="fas fa-save"></i> Сохранить изменения';
	}
}

function openAddWaitIncomeModal() {
	// Устанавливаем текущий месяц по умолчанию
	const now = new Date();
	const currentMonth = now.toISOString().substring(0, 7); // YYYY-MM формат
	document.getElementById('waitIncomeMonth').value = currentMonth;
	
	// Очищаем форму
	document.getElementById('addWaitIncomeForm').reset();
	document.getElementById('waitIncomeMonth').value = currentMonth;
	
	// Показываем модальное окно
	document.getElementById('addWaitIncomeModal').showModal();
}

async function openEditWaitIncomeModal(element) {
	// Получаем данные из data-атрибутов
	const id = element.dataset.id;
	const name = element.dataset.name;
	const sum = element.dataset.sum;
	const accrualMonth = element.dataset.accrualMonth;
	
	// Проверяем существование элементов формы
	const formElements = {
		editWaitIncomeId: document.getElementById('editWaitIncomeId'),
		editWaitIncomeName: document.getElementById('editWaitIncomeName'),
		editWaitIncomeSum: document.getElementById('editWaitIncomeSum'),
		editWaitIncomeMonth: document.getElementById('editWaitIncomeMonth'),
		editWaitIncomeModal: document.getElementById('editWaitIncomeModal'),
		btnEditWaitIncome: document.getElementById('btnEditWaitIncome'),
		btnDeleteWaitIncome: document.getElementById('btnDeleteWaitIncome')
	};
	
	// Проверяем, что все элементы найдены
	const missingElements = Object.entries(formElements)
		.filter(([key, element]) => !element)
		.map(([key]) => key);
	
	if (missingElements.length > 0) {
		await showNotificationModal({
			title: 'Ошибка',
			message: 'Не найдены элементы формы: ' + missingElements.join(', ')
		});
		return;
	}
	
	// Заполняем форму
	document.getElementById('editWaitIncomeId').value = id;
	document.getElementById('editWaitIncomeName').value = name;
	document.getElementById('editWaitIncomeSum').value = sum;
	
	// Преобразуем дату из YYYY-MM-DD в YYYY-MM для input[type="month"]
	const monthValue = accrualMonth ? accrualMonth.substring(0, 7) : '';
	document.getElementById('editWaitIncomeMonth').value = monthValue;
	
	// Показываем модальное окно
	document.getElementById('editWaitIncomeModal').showModal();
}

async function submitEditWaitIncomeForm() {
	const btn = document.getElementById('btnEditWaitIncome');
	btn.disabled = true;
	btn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Сохранение...';
	
	try {
		const id = document.getElementById('editWaitIncomeId').value;
		const name = document.getElementById('editWaitIncomeName').value;
		const sum = parseFloat(document.getElementById('editWaitIncomeSum').value);
		const accrualMonth = document.getElementById('editWaitIncomeMonth').value;
		
		const data = {
			name: name,
			sum: sum,
			accrual_month: accrualMonth + '-01' // Добавляем день для полной даты
		};
		
		const response = await fetch(`/xapi/wait-incomes/update?id=${id}`, {
			method: 'PATCH',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify(data)
		});
		
		const result = await response.json();
		
		if (!response.ok) {
			throw new Error(result.error || result.message || 'Ошибка при обновлении ожидаемого платежа');
		}
		
		if (!result.success) {
			throw new Error(result.error || 'Ошибка при обновлении ожидаемого платежа');
		}
		
		// Закрываем модальное окно и перезагружаем страницу
		document.getElementById('editWaitIncomeModal').close();
		window.reloadWithLoader();
		
	} catch (error) {
		await showNotificationModal({
			title: 'Ошибка обновления',
			message: error.message || 'Не удалось обновить ожидаемый платеж'
		});
		btn.disabled = false;
		btn.innerHTML = '<i class="fas fa-save"></i> Сохранить изменения';
	}
}

async function deleteWaitIncome() {
	const confirmed = await showConfirmationModal({
		title: 'Удаление ожидаемого платежа',
		message: 'Вы уверены, что хотите удалить этот ожидаемый платеж?',
		confirmText: 'Удалить',
		cancelText: 'Отмена'
	});

	if (!confirmed) {
		return;
	}

	const btn = document.getElementById('btnDeleteWaitIncome');
	const originalText = btn.innerHTML;
	btn.disabled = true;
	btn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Удаление...';

	try {
		const id = document.getElementById('editWaitIncomeId').value;
		
		const response = await fetch(`/xapi/wait-incomes/delete-simple?id=${id}`, {
			method: 'DELETE',
			headers: {
				'Content-Type': 'application/json',
			}
		});
		
		const result = await response.json();
		
		if (!response.ok) {
			throw new Error(result.error || result.message || 'Ошибка при удалении ожидаемого платежа');
		}
		
		if (!result.success) {
			throw new Error(result.error || 'Ошибка при удалении ожидаемого платежа');
		}
		
		// Закрываем модальное окно и перезагружаем страницу
		document.getElementById('editWaitIncomeModal').close();
		window.reloadWithLoader();
		
	} catch (error) {
		await showNotificationModal({
			title: 'Ошибка удаления',
			message: error.message || 'Не удалось удалить ожидаемый платеж'
		});
		btn.disabled = false;
		btn.innerHTML = originalText;
	}
}

// Обработчик отправки формы добавления ожидаемого платежа
document.addEventListener('DOMContentLoaded', function() {
	// Проверяем наличие блоков при загрузке
	const fullyPaidBlock = document.getElementById('fullyPaidBlock');
	const forcedClosedBlock = document.getElementById('forcedClosedBlock');
	
	if (!fullyPaidBlock) {
		// Блок не найден
	}
	if (!forcedClosedBlock) {
		// Блок не найден
	}
	
	const btnLoadBank = document.getElementById('btnLoadBank');
	if (btnLoadBank) {
		btnLoadBank.addEventListener('click', window.loadBankStatements);
	}

	const form = document.getElementById('addWaitIncomeForm');
	if (form) {
		form.addEventListener('submit', async function(e) {
			e.preventDefault();
			
			const btn = document.getElementById('btnSubmitWaitIncome');
			btn.disabled = true;
			btn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Сохранение...';
			
			try {
				const formData = new FormData(form);
				const data = {
					name: formData.get('name'),
					sum: parseFloat(formData.get('sum')),
					accrual_month: formData.get('accrual_month') + '-01' // Добавляем день для полной даты
				};
				
				const response = await fetch('/xapi/wait-incomes/create', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(data)
				});
				
				const result = await response.json();
				
				if (!result.success) {
					throw new Error(result.message || 'Ошибка при создании записи');
				}
				
				// Закрываем модальное окно и перезагружаем страницу
				document.getElementById('addWaitIncomeModal').close();
				window.reloadWithLoader();
				
			} catch (error) {
				await showNotificationModal({
					title: 'Ошибка создания',
					message: error.message || 'Не удалось создать ожидаемый платеж'
				});
				btn.disabled = false;
				btn.innerHTML = '<i class="fas fa-save"></i> Сохранить';
			}
		});
	}
	
	// Обработчик отправки формы редактирования ожидаемого платежа
	const editForm = document.getElementById('editWaitIncomeForm');
	if (editForm) {
		editForm.addEventListener('submit', async function(e) {
			e.preventDefault();
			await submitEditWaitIncomeForm();
		});
	}
	
	// Обработчик отправки формы добавления начисления
	const addAccrualForm = document.getElementById('addAccrualForm');
	if (addAccrualForm) {
		addAccrualForm.addEventListener('submit', async function(e) {
			e.preventDefault();
			await submitAddAccrualForm();
		});
	}
	
	// Обработчик отправки формы редактирования начисления
	const editAccrualForm = document.getElementById('editAccrualForm');
	if (editAccrualForm) {
		editAccrualForm.addEventListener('submit', async function(e) {
			e.preventDefault();
			await submitEditAccrualForm();
		});
	}
	
	// Обработчик отправки формы ручного платежа
	const manualPaymentForm = document.getElementById('manualPaymentForm');
	if (manualPaymentForm) {
		manualPaymentForm.addEventListener('submit', submitManualPaymentForm);
	}
});</script>

<script>
// Функция открытия модального окна добавления начисления
function openAddAccrualModal() {
	const modal = document.getElementById('addAccrualModal');
	if (modal) {
		// Очистка формы
		document.getElementById('addAccrualForm').reset();
		modal.showModal();
	}
}

// Функция отправки формы добавления начисления
async function submitAddAccrualForm() {
	const form = document.getElementById('addAccrualForm');
	const formData = new FormData(form);
	
	// Конвертируем FormData в объект
	const data = {
		name: formData.get('name'),
		number: formData.get('number') || '',
		partner: formData.get('partner'),
		cost_item: formData.get('cost_item'),
		sum: parseFloat(formData.get('sum')),
		repayment_date: formData.get('repayment_date'),
		description: formData.get('description') || ''
	};
	
	try {
		const response = await fetch('/xapi/accruals/create-simple', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify(data)
		});
		
		if (!response.ok) {
			const errorData = await response.json();
			throw new Error(errorData.message || 'Ошибка при создании начисления');
		}
		
		const result = await response.json();
		
		await showNotificationModal({
			title: 'Успех',
			message: 'Начисление успешно создано',
			confirmText: 'Понятно'
		});
		
		// Закрываем модальное окно
		document.getElementById('addAccrualModal').close();
		
		// Перезагружаем страницу для обновления данных
		window.reloadWithLoader();
		
	} catch (error) {
		await showNotificationModal({
			title: 'Ошибка',
			message: error.message || 'Не удалось создать начисление',
			confirmText: 'Понятно'
		});
	}
}

// Функция открытия модального окна редактирования начисления
function openEditAccrualModal(rowElement) {
	const modal = document.getElementById('editAccrualModal');
	if (!modal) return;
	
	// Функция для преобразования даты в формат YYYY-MM-DD
	const formatDateForInput = (dateStr) => {
		if (!dateStr) return '';
		try {
			const date = new Date(dateStr);
			const year = date.getFullYear();
			const month = String(date.getMonth() + 1).padStart(2, '0');
			const day = String(date.getDate()).padStart(2, '0');
			return `${year}-${month}-${day}`;
		} catch (e) {
			return dateStr.split(' ')[0]; // Если формат уже YYYY-MM-DD
		}
	};
	
	// Заполняем форму данными из data-атрибутов
	document.getElementById('editAccrualId').value = rowElement.dataset.accrualId || '';
	document.getElementById('editAccrualName').value = rowElement.dataset.accrualName || '';
	document.getElementById('editAccrualNumber').value = rowElement.dataset.accrualNumber || '';
	document.getElementById('editAccrualPartner').value = rowElement.dataset.accrualPartner || '';
	document.getElementById('editAccrualCostItem').value = rowElement.dataset.accrualCostItem || '';
	document.getElementById('editAccrualSum').value = rowElement.dataset.accrualSum || '';
	document.getElementById('editAccrualRepaymentDate').value = formatDateForInput(rowElement.dataset.accrualRepaymentDate || '');
	document.getElementById('editAccrualDescription').value = rowElement.dataset.accrualDescription || '';
	document.getElementById('editAccrualForcedClosure').checked = rowElement.dataset.accrualForcedClosure === 'true';
	
	modal.showModal();
}

// Функция отправки формы редактирования начисления
async function submitEditAccrualForm() {
	const form = document.getElementById('editAccrualForm');
	const formData = new FormData(form);
	
	const data = {
		id: formData.get('id'),
		name: formData.get('name'),
		number: formData.get('number') || '',
		partner: formData.get('partner'),
		cost_item: formData.get('cost_item'),
		sum: parseFloat(formData.get('sum')),
		repayment_date: formData.get('repayment_date'),
		description: formData.get('description') || '',
		Forced_closure: formData.get('Forced_closure') === 'on'
	};
	
	try {
		const response = await fetch('/xapi/accruals/update-simple', {
			method: 'PATCH',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify(data)
		});
		
		if (!response.ok) {
			const errorData = await response.json();
			throw new Error(errorData.message || 'Ошибка при обновлении начисления');
		}
		
		const result = await response.json();
		
		await showNotificationModal({
			title: 'Успех',
			message: 'Начисление успешно обновлено',
			confirmText: 'Понятно'
		});
		
		document.getElementById('editAccrualModal').close();
		window.reloadWithLoader();
		
	} catch (error) {
		await showNotificationModal({
			title: 'Ошибка',
			message: error.message || 'Не удалось обновить начисление',
			confirmText: 'Понятно'
		});
	}
}

// Функция открытия модального окна для ручного платежа
function openManualPaymentModal(accrualId, accrualName, balance) {
	const modal = document.getElementById('manualPaymentModal');
	if (!modal) return;
	
	// Заполняем данные о начислении
	document.getElementById('manualPaymentAccrualId').value = accrualId;
	document.getElementById('manualPaymentAccrualName').textContent = accrualName;
	document.getElementById('manualPaymentBalance').textContent = formatCurrencyJS(balance);
	
	// Устанавливаем сумму платежа равной балансу по умолчанию
	document.getElementById('manualPaymentSum').value = balance;
	
	// Устанавливаем текущую дату
	const today = new Date().toISOString().split('T')[0];
	document.getElementById('manualPaymentDate').value = today;
	
	// Очищаем остальные поля
	document.getElementById('manualPaymentDescription').value = '';
	document.getElementById('manualPaymentReceipts').value = '';
	
	modal.showModal();
}

// Обработчик отправки формы ручного платежа
async function submitManualPaymentForm(e) {
	e.preventDefault();
	
	const btn = document.getElementById('btnSubmitManualPayment');
	const originalText = btn.innerHTML;
	btn.disabled = true;
	btn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Создание...';
	
	try {
		const form = document.getElementById('manualPaymentForm');
		const formData = new FormData(form);
		
		// Отправляем данные с файлами
		const response = await fetch('/xapi/payments/create-manual', {
			method: 'POST',
			body: formData
		});
		
		if (!response.ok) {
			const errorData = await response.json();
			throw new Error(errorData.message || 'Ошибка при создании платежа');
		}
		
		const result = await response.json();
		
		if (!result.success) {
			throw new Error(result.message || 'Ошибка при создании платежа');
		}
		
		await showNotificationModal({
			title: 'Успех',
			message: 'Платеж успешно создан',
			confirmText: 'Понятно'
		});
		
		// Закрываем модальное окно
		document.getElementById('manualPaymentModal').close();
		
		// Перезагружаем страницу для обновления данных
		window.reloadWithLoader();
		
	} catch (error) {
		await showNotificationModal({
			title: 'Ошибка',
			message: error.message || 'Не удалось создать платеж',
			confirmText: 'Понятно'
		});
		btn.disabled = false;
		btn.innerHTML = originalText;
	}
}

// Функция удаления начисления
async function deleteAccrual() {
	const recordId = document.getElementById('editAccrualId').value;
	
	if (!recordId) {
		await showNotificationModal({
			title: 'Ошибка',
			message: 'ID начисления не найден',
			confirmText: 'Понятно'
		});
		return;
	}
	
	const confirmed = await showConfirmationModal({
		title: 'Подтверждение удаления',
		message: 'Вы уверены, что хотите удалить это начисление? Это действие нельзя отменить.',
		confirmText: 'Удалить',
		cancelText: 'Отмена'
	});
	
	if (!confirmed) return;
	
	try {
		const response = await fetch(`/xapi/accruals/delete-simple?id=${recordId}`, {
			method: 'DELETE'
		});
		
		if (!response.ok) {
			const errorData = await response.json();
			throw new Error(errorData.message || 'Ошибка при удалении начисления');
		}
		
		const result = await response.json();
		
		await showNotificationModal({
			title: 'Успех',
			message: 'Начисление успешно удалено',
			confirmText: 'Понятно'
		});
		
		document.getElementById('editAccrualModal').close();
		window.reloadWithLoader();
		
	} catch (error) {
		await showNotificationModal({
			title: 'Ошибка',
			message: error.message || 'Не удалось удалить начисление',
			confirmText: 'Понятно'
		});
	}
}
</script>