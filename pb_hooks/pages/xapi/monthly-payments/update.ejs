<%
/**
 * PATCH /xapi/monthly-payments/update
 * Обновляет существующий шаблон ежемесячного начисления
 */

meta('layout', false);

if (request.method !== 'PATCH') {
    return response.json(405, {
        success: false,
        message: 'Используйте метод PATCH'
    });
}

try {
	let body;
	try {
		body = request.body();
		if (typeof body === 'string') {
			body = JSON.parse(body);
		}
	} catch (parseError) {
		return response.json(400, {
			success: false,
			message: 'Неверный формат данных: ' + parseError.message
		});
	}
	
	// Валидация обязательных полей
	if (!body.id) {
		return response.json(400, {
			success: false,
			message: 'ID записи обязателен'
		});
	}
	
	if (!body.name || !body.partner || !body.cost_item || !body.sum || !body.repayment_date) {
		return response.json(400, {
			success: false,
			message: 'Заполните все обязательные поля'
		});
	}
	
	// Находим запись
	let record;
	try {
		record = $app.findRecordById('monthly_payments', body.id);
	} catch (error) {
		return response.json(404, {
			success: false,
			message: 'Шаблон не найден'
		});
	}
	
	// Формируем дату
	const day = parseInt(body.repayment_date);
	if (day < 1 || day > 31) {
		return response.json(400, {
			success: false,
			message: 'День месяца должен быть от 1 до 31'
		});
	}
	
	const now = new Date();
	const repaymentDate = new Date(now.getFullYear(), now.getMonth(), day);
	
	// Обновляем значения полей
	record.set('name', String(body.name));
	record.set('number', body.number ? String(body.number) : '');
	record.set('partner', String(body.partner));
	record.set('cost_item', String(body.cost_item));
	record.set('sum', parseFloat(body.sum));
	record.set('repayment_date', repaymentDate.toISOString());
	record.set('description', body.description ? String(body.description) : '');
	record.set('Forced_closure', Boolean(body.Forced_closure));
	
	// Сохраняем запись
	$app.save(record);
	
	return response.json(200, {
		success: true,
		data: {
			id: record.id,
			name: record.get('name'),
			sum: record.get('sum')
		},
		message: 'Шаблон успешно обновлен'
	});
	
} catch (error) {
	return response.json(500, {
		success: false,
		message: error.message || 'Внутренняя ошибка сервера',
		stack: error.stack
	});
}
%>
