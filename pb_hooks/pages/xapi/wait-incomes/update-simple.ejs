<%
meta('layout', false);

if (request.method !== 'PATCH') {
    return response.json(405, {
        success: false,
        message: 'Используйте метод PATCH'
    });
}

try {
    // Получаем параметры из URL
    const query = url(request.url).query || {};
    const recordId = query.id;
    
    if (!recordId) {
        throw new Error('ID записи не указан');
    }
    
    // Получаем данные из тела запроса
    const bodyRaw = request.body();
    let requestBody;

    if (typeof bodyRaw === 'string') {
        try {
            requestBody = JSON.parse(bodyRaw);
        } catch (parseError) {
            throw new Error('Некорректный JSON в теле запроса');
        }
    } else {
        requestBody = bodyRaw || {};
    }
    
    // Получаем запись для обновления
    const record = $app.dao().findRecordById('wait_incomes', recordId);
    
    // Обновляем поля
    record.set('name', requestBody.name);
    record.set('sum', requestBody.sum);
    record.set('accural_month', requestBody.accrual_month);
    
    // Сохраняем изменения
    $app.dao().saveRecord(record);
    
    return response.json(200, {
        success: true,
        message: 'Запись успешно обновлена',
        record: {
            id: record.id,
            name: record.get('name'),
            sum: record.get('sum'),
            accural_month: record.get('accural_month')
        }
    });

} catch (error) {
    return response.json(500, {
        success: false,
        message: 'Ошибка при обновлении: ' + error.message
    });
}
%>