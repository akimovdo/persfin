<%
/**
 * Endpoint: POST /xapi/wait-incomes/update?id=xxx
 * Обновление ожидаемого поступления
 * Body: { name: string, sum: number, accrual_month: string }
 */

try {
	// Получаем ID из URL
	const url = request.url();
	const urlParams = new URLSearchParams(url.split('?')[1] || '');
	const recordId = urlParams.get('id');
	
	if (!recordId) {
		return response.json(400, {
			success: false,
			message: 'ID записи не указан'
		});
	}

	// Парсим body запроса
	const bodyRaw = request.body();
	let requestData = {};
	
	if (typeof bodyRaw === 'string' && bodyRaw.length > 0) {
		try {
			requestData = JSON.parse(bodyRaw);
		} catch (parseError) {
			return response.json(400, {
				success: false,
				message: 'Невалидный JSON в теле запроса'
			});
		}
	} else if (typeof bodyRaw === 'object') {
		requestData = bodyRaw;
	} else {
		return response.json(400, {
			success: false,
			message: 'Отсутствует тело запроса'
		});
	}
	
	// Валидация обязательных полей
	if (!requestData.name || typeof requestData.name !== 'string') {
		return response.json(400, {
			success: false,
			message: 'Поле "name" обязательно и должно быть строкой'
		});
	}
	
	if (!requestData.sum || typeof requestData.sum !== 'number' || requestData.sum <= 0) {
		return response.json(400, {
			success: false,
			message: 'Поле "sum" обязательно и должно быть положительным числом'
		});
	}
	
	if (!requestData.accrual_month || typeof requestData.accrual_month !== 'string') {
		return response.json(400, {
			success: false,
			message: 'Поле "accrual_month" обязательно и должно быть строкой в формате YYYY-MM-DD'
		});
	}
	
	// Проверяем формат даты (должно быть YYYY-MM-DD)
	const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
	if (!dateRegex.test(requestData.accrual_month)) {
		return response.json(400, {
			success: false,
			message: 'Поле "accrual_month" должно быть в формате YYYY-MM-DD'
		});
	}
	
	// Проверяем, что дата валидна
	const accrualDate = new Date(requestData.accrual_month + 'T00:00:00.000Z');
	if (isNaN(accrualDate.getTime())) {
		return response.json(400, {
			success: false,
			message: 'Невалидная дата в поле "accrual_month"'
		});
	}
	
	// Находим существующую запись
	let existingRecord = null;
	try {
		existingRecord = $app.findRecordById('wait_incomes', recordId);
	} catch (e) {
		return response.json(404, {
			success: false,
			message: `Ожидаемое поступление с ID "${recordId}" не найдено`
		});
	}
	
	// Обновляем запись
	existingRecord.set('name', requestData.name.trim());
	existingRecord.set('sum', requestData.sum);
	existingRecord.set('accural_month', requestData.accrual_month + ' 00:00:00.000Z');
	
	$app.save(existingRecord);
	
	return response.json(200, {
		success: true,
		message: `Ожидаемое поступление "${requestData.name}" успешно обновлено`,
		data: {
			id: existingRecord.id,
			name: existingRecord.getString('name'),
			sum: existingRecord.get('sum'),
			accrual_month: existingRecord.getString('accural_month')
		}
	});
	
} catch (error) {
	return response.json(500, {
		success: false,
		message: 'Внутренняя ошибка сервера: ' + (error.message || String(error))
	});
}
-%>