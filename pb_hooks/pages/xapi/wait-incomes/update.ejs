<%
/**
 * API эндпоинт для обновления записи wait_incomes
 * PATCH /xapi/wait-incomes/update?id=xxx
 */
meta('layout', false);

if (request.method !== 'PATCH' && request.method !== 'POST') {
  return response.json(405, { 
    success: false, 
    error: 'Method not allowed' 
  });
}

try {
  const recordId = url.query.id || params.id;
  
  if (!recordId) {
    return response.json(400, {
      success: false,
      error: 'ID записи не указан'
    });
  }

  const formData = body();

  // Загружаем существующую запись
  const record = $app.findRecordById('wait_incomes', recordId);
  
  // Обновляем поля
  if (formData.name !== undefined) {
    record.set('name', formData.name);
  }
  if (formData.sum !== undefined) {
    record.set('sum', formData.sum);
  }
  if (formData.accrual_month !== undefined) {
    record.set('accural_month', formData.accrual_month); // Используем поле с опечаткой
  }
  
  $app.save(record);

  return response.json(200, {
    success: true,
    data: {
      id: record.getString('id'),
      name: record.getString('name'),
      sum: record.getFloat('sum'),
      accural_month: record.getString('accural_month')
    },
    message: 'Запись успешно обновлена'
  });

} catch (error) {
  log('[wait-incomes/update] Error:', error);
  return response.json(400, {
    success: false,
    error: error.message || 'Ошибка обновления записи'
  });
}
%>