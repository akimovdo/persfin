<%
meta('layout', false);

if (request.method !== 'PATCH') {
    return response.json(405, {
        success: false,
        message: 'Используйте метод PATCH'
    });
}

try {
	// Читаем тело запроса
	let body;
	try {
		body = request.body();
		if (typeof body === 'string') {
			body = JSON.parse(body);
		}
	} catch (parseError) {
		return response.json(400, {
			success: false,
			message: 'Неверный формат данных: ' + parseError.message
		});
	}
	
	// Валидация обязательных полей
	if (!body.id) {
		return response.json(400, {
			success: false,
			message: 'ID начисления не указан'
		});
	}
	
	if (!body.name || !body.partner || !body.cost_item || !body.sum || !body.repayment_date) {
		return response.json(400, {
			success: false,
			message: 'Заполните все обязательные поля'
		});
	}
	
	// Получаем и обновляем запись
	const record = $app.findRecordById('accruals', body.id);
	
	record.set('name', String(body.name));
	record.set('number', body.number ? String(body.number) : '');
	record.set('partner', String(body.partner));
	record.set('cost_item', String(body.cost_item));
	record.set('sum', parseFloat(body.sum));
	record.set('repayment_date', String(body.repayment_date));
	record.set('description', body.description ? String(body.description) : '');
	record.set('Forced_closure', body.Forced_closure === true);
	
	$app.save(record);
	
	return response.json(200, {
		success: true,
		data: {
			id: record.id,
			name: record.get('name'),
			sum: record.get('sum')
		}
	});
	
} catch (error) {
	return response.json(500, {
		success: false,
		message: error.message || 'Внутренняя ошибка сервера'
	});
}
%>
