<%
/**
 * GET /xapi/debug/check-internal-transfers
 * Поиск внутренних переводов
 */

meta('layout', false);

try {
  // Ищем платежи с описанием "Перевод собственных средств"
  const payments = $app.findRecordsByFilter(
    'payments', 
    'description ~ "Перевод собственных средств"',
    '-date',
    10,
    0
  );
  
  const result = {
    count: payments.length,
    records: []
  };
  
  for (let i = 0; i < payments.length; i++) {
    const payment = payments[i];
    let raw = payment.get('raw');
    
    // Если raw - строка, парсим её
    if (typeof raw === 'string') {
      try {
        raw = JSON.parse(raw);
      } catch (e) {
        // Если это байтовый массив, конвертируем
        if (Array.isArray(raw)) {
          const str = String.fromCharCode.apply(null, raw.filter(v => v > 0 && v < 256));
          try {
            raw = JSON.parse(str);
          } catch (e2) {
            raw = { error: 'Failed to parse byte array' };
          }
        } else {
          raw = { error: 'Failed to parse' };
        }
      }
    }
    
    const record = {
      id: payment.id,
      transactionId: payment.getString('transactionId'),
      date: payment.getString('date'),
      sum: payment.get('sum'),
      creditDebitIndicator: payment.getString('creditDebitIndicator'),
      description: payment.getString('description'),
      payer: payment.getString('payer'),
      ignore: payment.get('ignore'),
      raw: raw,
      // Анализ признаков внутреннего перевода
      analysis: {
        hasDebtorParty: raw && !!raw.DebtorParty,
        hasCreditorParty: raw && !!raw.CreditorParty,
        debtorINN: raw && raw.DebtorParty && raw.DebtorParty.inn,
        creditorINN: raw && raw.CreditorParty && raw.CreditorParty.inn,
        debtorName: raw && raw.DebtorParty && raw.DebtorParty.name,
        creditorName: raw && raw.CreditorParty && raw.CreditorParty.name,
        transactionTypeCode: raw && raw.transactionTypeCode,
        status: raw && raw.status,
        paymentId: raw && raw.paymentId
      }
    };
    
    result.records.push(record);
  }
  
  return response.json(200, {
    success: true,
    data: result,
    message: `Найдено ${payments.length} внутренних переводов`
  });
  
} catch (error) {
  return response.json(500, {
    success: false,
    error: error.message || String(error),
    stack: error.stack
  });
}
%>
