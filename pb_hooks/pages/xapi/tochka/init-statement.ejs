<%#
 POST /xapi/tochka/init-statement
 Инициация создания выписки по счёту за период

 Body (JSON):
 {
   "startDateTime": "2025-10-01",
   "endDateTime": "2025-10-31",
   "accountId": "optional" если не указан, используется из конфига
 }
%>

<%
meta('layout', false);

// Проверка метода запроса
if (request.method !== 'POST') {
  return response.json(405, { 
    success: false,
    error: 'Method Not Allowed',
    message: 'Используйте POST метод для этого эндпоинта'
  });
}

// Загружаем конфиг Точка банка
var tochkaConfig = null;
try {
  tochkaConfig = $app.findFirstRecordByFilter('tochka_config', 'is_active = true');
  if (!tochkaConfig) {
    return response.json(500, {
      success: false,
      error: 'Configuration Error',
      message: 'Не найдена активная конфигурация Точка банка'
    });
  }
} catch (error) {
  return response.json(500, {
    success: false,
    error: 'Configuration Error',
    message: 'Ошибка загрузки конфигурации: ' + error.message
  });
}

// Вспомогательная функция для форматирования даты в YYYY-MM-DD
var formatDateForApi = function(date) {
  var d = date instanceof Date ? date : new Date(date);
  var year = d.getFullYear();
  var month = String(d.getMonth() + 1).padStart(2, '0');
  var day = String(d.getDate()).padStart(2, '0');
  return year + '-' + month + '-' + day;
};

// Функция для запроса к API Точка банка
var makeApiRequest = function(endpoint, options) {
  options = options || {};
  var url = 'https://enter.tochka.com/uapi/open-banking/v1.0' + endpoint;
  
  var headers = {
    'Authorization': 'Bearer ' + tochkaConfig.getString('jwt_token'),
    'Content-Type': 'application/json',
    'Accept': 'application/json'
  };
  
  try {
    var response = $http.send({
      url: url,
      method: options.method || 'GET',
      headers: headers,
      body: options.body ? JSON.stringify(options.body) : undefined,
      timeout: 30
    });
    
    if (response.statusCode >= 200 && response.statusCode < 300) {
      return {
        success: true,
        data: response.json,
        statusCode: response.statusCode
      };
    } else {
      return {
        success: false,
        error: 'API Error',
        message: response.json?.message || 'Ошибка при запросе к API Точка банка',
        statusCode: response.statusCode,
        details: response.json
      };
    }
  } catch (error) {
    return {
      success: false,
      error: 'Request Failed',
      message: error.message || 'Не удалось выполнить запрос к API Точка банка',
      details: error
    };
  }
};

// Функция для обновления даты последней синхронизации
var updateLastSyncDate = function() {
  try {
    var config = $app.findRecordById('tochka_config', tochkaConfig.id);
    config.set('last_sync_date', new Date().toISOString());
    $app.save(config);
    return true;
  } catch (error) {
    return false;
  }
};

// Получить данные из body
var requestData = body() || {};

// Определение дат: если не указаны, берём из последней синхронизации
var startDateTime = requestData.startDateTime;
var endDateTime = requestData.endDateTime;

// Если даты не переданы, определяем автоматически
if (!startDateTime || !endDateTime) {
  try {
    var lastSync = tochkaConfig.get('last_sync_date');
    
    // Проверяем, что lastSync - это валидная дата
    if (lastSync && lastSync !== '' && !isNaN(new Date(lastSync).getTime())) {
      // Если есть последняя синхронизация, начинаем с неё
      startDateTime = formatDateForApi(new Date(lastSync));
    } else {
      // Если нет, берём последний месяц
      var lastMonth = new Date();
      lastMonth.setMonth(lastMonth.getMonth() - 1);
      startDateTime = formatDateForApi(lastMonth);
    }
    
    // Конечная дата - сегодня
    endDateTime = formatDateForApi(new Date());
  } catch (error) {
    return response.json(500, {
      success: false,
      error: 'Date Calculation Error',
      message: 'Ошибка при определении дат: ' + error.message,
      details: error
    });
  }
}

// Нормализуем даты на случай, если они пришли в другом формате
if (startDateTime && startDateTime.length > 10) {
  startDateTime = startDateTime.substring(0, 10);
}
if (endDateTime && endDateTime.length > 10) {
  endDateTime = endDateTime.substring(0, 10);
}

// Валидация формата дат (YYYY-MM-DD)
var dateRegex = /^\d{4}-\d{2}-\d{2}$/;
if (!dateRegex.test(startDateTime) || !dateRegex.test(endDateTime)) {
  return response.json(400, {
    success: false,
    error: 'Bad Request',
    message: 'Неверный формат даты. Используйте YYYY-MM-DD',
    debug: {
      startDateTime: startDateTime,
      endDateTime: endDateTime,
      startValid: dateRegex.test(startDateTime),
      endValid: dateRegex.test(endDateTime)
    }
  });
}

// Использовать accountId из запроса или из конфига
var accountId = requestData.accountId ? requestData.accountId : tochkaConfig.getString('account_id');

// Подготовить тело запроса к API Точка
var apiBody = {
  Data: {
    Statement: {
      accountId: accountId,
      startDateTime: startDateTime,
      endDateTime: endDateTime
    }
  }
};

// Выполнить запрос к API Точка синхронно
var result = makeApiRequest('/statements', {
  method: 'POST',
  body: apiBody
});

if (!result.success) {
  return response.json(result.statusCode ? result.statusCode : 500, {
    success: false,
    error: result.error,
    message: result.message,
    details: result.details
  });
}

var statementData = {};
if (result.data && result.data.Data && result.data.Data.Statement) {
  statementData = result.data.Data.Statement;
}

try {
  updateLastSyncDate();
} catch (e) {
  // Игнорируем ошибку обновления даты синхронизации
}

return response.json(200, {
  success: true,
  data: {
    statementId: statementData.statementId,
    status: statementData.status,
    accountId: statementData.accountId,
    startDateTime: statementData.startDateTime,
    endDateTime: statementData.endDateTime,
    creationDateTime: statementData.creationDateTime
  },
  message: 'Выписка инициирована. Используйте statementId для получения данных.'
});
%>