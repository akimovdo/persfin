<%
meta('layout', false);

if (request.method !== 'POST') {
    return response.json(405, {
        success: false,
        message: 'Используйте метод POST'
    });
}

try {
    const formData = body();
    
    // Валидация обязательных полей
    if (!formData.sum || !formData.date) {
        return response.json(400, {
            success: false,
            message: 'Заполните обязательные поля: sum, date'
        });
    }
    
    // Создаем новый платеж
    const collection = $app.findCollectionByNameOrId('payments');
    const record = new Record(collection);
    
    // Устанавливаем значения полей
    record.set('creditDebitIndicator', formData.creditDebitIndicator ? String(formData.creditDebitIndicator) : '');
    record.set('payer', formData.payer ? String(formData.payer) : '');
    record.set('sum', parseFloat(formData.sum));
    record.set('date', String(formData.date));
    record.set('description', formData.description ? String(formData.description) : '');
    record.set('transactionId', formData.transactionId ? String(formData.transactionId) : '');
    record.set('ignore', formData.ignore ? true : false);
    
    // Связь с начислением (optional)
    if (formData.accural) {
        record.set('accural', String(formData.accural));
    }
    
    // Сохраняем запись
    $app.save(record);
    
    return response.json(200, {
        success: true,
        message: 'Платеж успешно создан',
        data: {
            id: record.id,
            payer: record.get('payer'),
            sum: record.get('sum')
        }
    });
    
} catch (error) {
    console.error('[payments/create] Error:', error);
    return response.json(500, {
        success: false,
        message: error.message || 'Внутренняя ошибка сервера'
    });
}
%>
