<% // Глобальная защита всех страниц (кроме публичных)
  try {
    const _path = (request && request.url && request.url.pathname) || ''
    const isAuth = _path.startsWith('/auth/')
    const isPublicLanding = _path === '/'
    
    // Если не авторизован и это не страница авторизации и не лендинг – редирект на логин
    if (!isAuth && !isPublicLanding && !request.auth) {
      redirect('/auth/login', { next: _path || '/' })
    }
  } catch(_) {}
%>
<!doctype html>
<html lang="ru" data-theme="business">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Финансовая CRM - 42Bureau</title>
    <link href="<%=asset('/app.css')%>" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  </head>
  <body>
    <div class="drawer">
      <input id="my-drawer-3" type="checkbox" class="drawer-toggle" />
      <div class="drawer-content flex flex-col">
        <!-- Navbar -->
        <div class="navbar bg-base-300 w-full">
          <div class="flex-none lg:hidden">
            <label
              for="my-drawer-3"
              aria-label="open sidebar"
              class="btn btn-square btn-ghost"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                class="inline-block h-6 w-6 stroke-current"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                ></path>
              </svg>
            </label>
          </div>
          <div class="mx-2 flex-1 px-2">
            <a href="/" class="btn btn-ghost text-xl">
              <i class="fas fa-chart-line"></i>
              Финансовая CRM
            </a>
          </div>
          <div class="hidden flex-none lg:block">
            <ul class="menu menu-horizontal">
              <% if (request.auth) { 
                const email = request.auth.getString ? request.auth.getString('email') : (request.auth.email || '');
              %>
                <li><a href="/dashboard"><i class="fas fa-tachometer-alt"></i> Дашборд</a></li>
                <li><a href="/dashboard/payments"><i class="fas fa-credit-card"></i> Платежи</a></li>
                <li><a href="/dashboard/partners"><i class="fas fa-users"></i> Партнёры</a></li>
                <li>
                  <details>
                    <summary>
                      <i class="fas fa-user"></i>
                      <%= email %>
                    </summary>
                    <ul class="bg-base-100 p-2">
                      <li><a href="/auth/logout"><i class="fas fa-sign-out-alt"></i> Выйти</a></li>
                    </ul>
                  </details>
                </li>
              <% } else { %>
                <li><a href="/auth/login"><i class="fas fa-sign-in-alt"></i> Вход</a></li>
              <% } %>
            </ul>
          </div>
        </div>
        <main class="flex-1 p-4 bg-base-100"><%- slot %></main>
      </div>
      <div class="drawer-side">
        <label
          for="my-drawer-3"
          aria-label="close sidebar"
          class="drawer-overlay"
        ></label>
        <ul class="menu bg-base-200 min-h-full w-80 p-4">
          <% if (request.auth) { %>
            <!-- Sidebar content here -->
            <li class="menu-title">
              <span><i class="fas fa-chart-bar"></i> Аналитика</span>
            </li>
            <li><a href="/dashboard"><i class="fas fa-home"></i> Главная</a></li>
            <li><a href="/dashboard/accruals"><i class="fas fa-receipt"></i> Начисления</a></li>
            <li><a href="/dashboard/partners"><i class="fas fa-users"></i> Партнёры</a></li>
            <li><a href="/dashboard/payments"><i class="fas fa-credit-card"></i> Платежи</a></li>
            <li><a href="/dashboard/overdue"><i class="fas fa-exclamation-triangle"></i> Просрочка</a></li>
            
            <li class="menu-title">
              <span><i class="fas fa-cog"></i> Управление</span>
            </li>
            <li><a href="/docs"><i class="fas fa-book"></i> Документация</a></li>
          <% } else { %>
            <!-- Публичное меню -->
            <li class="menu-title">
              <span><i class="fas fa-info-circle"></i> Информация</span>
            </li>
            <li><a href="/"><i class="fas fa-home"></i> Главная</a></li>
            <li><a href="/auth/login"><i class="fas fa-sign-in-alt"></i> Вход в систему</a></li>
          <% } %>
        </ul>
      </div>
    </div>
    
    <!-- Глобальные UI компоненты -->
    <%- include('_toast') %>
    <%- include('_confirm_dialog') %>
  </body>
</html>
