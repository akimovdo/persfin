<%
meta('title', 'Конкретная отладка Денис Тинек');

let accrualData = null;
let rawData = null;
let error = null;

try {
    // Ищем начисление по партнеру "Тинек"
    const records = $app.findRecordsByFilter('accruals_all_with_status', "partner_name LIKE '%Тинек%'", '', 0, 10);
    
    if (records.length > 0) {
        const record = records[0];
        
        accrualData = {
            id: record.getString('id'),
            name: record.getString('accrual_name'),
            number: record.getString('number'),
            partnerName: record.getString('partner_name'),
            costItemName: record.getString('cost_item_name'),
            repaymentDate: record.getString('repayment_date'),
            daysDifference: record.get('days_difference'),
            daysDifferenceType: typeof record.get('days_difference'),
            totalAccrued: record.get('total_accrued'),
            totalPaid: record.get('total_paid'),
            balance: record.get('balance'),
            isForcedClosed: record.get('is_forced_closed'),
            created: record.getString('created'),
            updated: record.getString('updated')
        };
        
        // Получаем сырые данные из таблицы accruals
        const accrualId = record.getString('id');
        const rawRecords = $app.findRecordsByFilter('accruals', `id = '${accrualId}'`, '', 0, 1);
        
        if (rawRecords.length > 0) {
            const rawRecord = rawRecords[0];
            rawData = {
                id: rawRecord.getString('id'),
                name: rawRecord.getString('name'),
                number: rawRecord.getString('number'),
                sum: rawRecord.get('sum'),
                repaymentDate: rawRecord.getString('repayment_date'),
                isForcedClosed: rawRecord.get('is_forced_closed'),
                created: rawRecord.getString('created'),
                updated: rawRecord.getString('updated')
            };
        }
    }
    
} catch (err) {
    error = err;
}

// Функция для определения статуса
const getStatus = (daysDifference) => {
    if (typeof daysDifference !== 'number') return 'Неопределено';
    if (daysDifference < 0) return `Просрочено ${Math.abs(daysDifference)} дн.`;
    if (daysDifference === 0) return 'Оплата сегодня';
    return `До оплаты ${daysDifference} дн.`;
};
%>

<div class="container mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">Отладка начисления "Денис Тинек"</h1>
    
    <% if (error) { %>
        <div class="alert alert-error mb-4">
            <span>Ошибка: <%= error.message %></span>
        </div>
    <% } %>
    
    <div class="mb-4 p-4 bg-base-200 rounded">
        <h2 class="text-lg font-semibold mb-2">Системная информация</h2>
        <p><strong>Текущая дата/время:</strong> <%= new Date().toISOString() %></p>
        <p><strong>Текущая дата (только дата):</strong> <%= new Date().toISOString().split('T')[0] %></p>
    </div>
    
    <% if (!accrualData) { %>
        <div class="alert alert-warning">
            <span>Начисление с партнером содержащим "Тинек" не найдено</span>
        </div>
    <% } else { %>
        <div class="space-y-6">
            <!-- Данные из представления -->
            <div>
                <h2 class="text-lg font-semibold mb-4">Данные из представления accruals_all_with_status</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card bg-base-100 shadow">
                        <div class="card-body">
                            <h3 class="card-title text-base">Основная информация</h3>
                            <div class="space-y-2 text-sm">
                                <p><strong>ID:</strong> <%= accrualData.id %></p>
                                <p><strong>Название:</strong> <%= accrualData.name %></p>
                                <p><strong>Номер:</strong> <%= accrualData.number %></p>
                                <p><strong>Партнер:</strong> <%= accrualData.partnerName %></p>
                                <p><strong>Статья затрат:</strong> <%= accrualData.costItemName %></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card bg-base-100 shadow">
                        <div class="card-body">
                            <h3 class="card-title text-base">Финансовая информация</h3>
                            <div class="space-y-2 text-sm">
                                <p><strong>Начислено:</strong> <%= accrualData.totalAccrued %></p>
                                <p><strong>Оплачено:</strong> <%= accrualData.totalPaid %></p>
                                <p><strong>Баланс:</strong> <%= accrualData.balance %></p>
                                <p><strong>Принудительно закрыто:</strong> <%= accrualData.isForcedClosed %></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <div class="card bg-base-100 shadow">
                        <div class="card-body">
                            <h3 class="card-title text-base">Критически важные данные</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div>
                                    <p><strong>Дата погашения:</strong></p>
                                    <p class="text-lg font-mono bg-base-200 p-2 rounded"><%= accrualData.repaymentDate %></p>
                                </div>
                                <div>
                                    <p><strong>days_difference:</strong></p>
                                    <p class="text-lg font-mono bg-base-200 p-2 rounded">
                                        <%= accrualData.daysDifference %> (<%= accrualData.daysDifferenceType %>)
                                    </p>
                                </div>
                                <div>
                                    <p><strong>Вычисленный статус:</strong></p>
                                    <p class="text-lg font-semibold bg-base-200 p-2 rounded">
                                        <%= getStatus(accrualData.daysDifference) %>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Сырые данные из таблицы -->
            <% if (rawData) { %>
                <div>
                    <h2 class="text-lg font-semibold mb-4">Сырые данные из таблицы accruals</h2>
                    <div class="card bg-base-100 shadow">
                        <div class="card-body">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p><strong>ID:</strong> <%= rawData.id %></p>
                                    <p><strong>Название:</strong> <%= rawData.name %></p>
                                    <p><strong>Номер:</strong> <%= rawData.number %></p>
                                    <p><strong>Сумма:</strong> <%= rawData.sum %></p>
                                </div>
                                <div>
                                    <p><strong>Дата погашения (RAW):</strong></p>
                                    <p class="text-lg font-mono bg-warning/20 p-2 rounded"><%= rawData.repaymentDate %></p>
                                    <p><strong>Принудительно закрыто:</strong> <%= rawData.isForcedClosed %></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <% } %>
            
            <!-- Сравнение -->
            <div>
                <h2 class="text-lg font-semibold mb-4">Анализ</h2>
                <div class="space-y-4">
                    <% if (accrualData.repaymentDate === '2025-10-31') { %>
                        <div class="alert alert-success">
                            <span>✓ Дата погашения корректная (31.10.2025)</span>
                        </div>
                    <% } else { %>
                        <div class="alert alert-error">
                            <span>✗ Дата погашения неожиданная: <%= accrualData.repaymentDate %></span>
                        </div>
                    <% } %>
                    
                    <% if (accrualData.daysDifference === -1) { %>
                        <div class="alert alert-success">
                            <span>✓ days_difference корректное (-1 = просрочка на 1 день)</span>
                        </div>
                    <% } else if (accrualData.daysDifference === 0) { %>
                        <div class="alert alert-warning">
                            <span>⚠ days_difference = 0 (оплата сегодня) - возможно, миграция не применилась</span>
                        </div>
                    <% } else { %>
                        <div class="alert alert-error">
                            <span>✗ days_difference неожиданное: <%= accrualData.daysDifference %></span>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    <% } %>
    
    <div class="mt-6 flex gap-2">
        <a href="/debug/sql_debug" class="btn btn-secondary">
            SQL Debug
        </a>
        <a href="/debug/days_difference" class="btn btn-secondary">
            Общая отладка
        </a>
        <a href="/dashboard/accruals_all_with_status" class="btn btn-primary">
            Вернуться к дашборду
        </a>
    </div>
</div>