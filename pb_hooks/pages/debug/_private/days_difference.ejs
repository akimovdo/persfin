<%
meta('title', 'Отладка days_difference');

let debugData = [];
let error = null;

try {
    // Загружаем все записи начислений для отладки
    const records = $app.findRecordsByFilter('accruals_all_with_status', '', '', 0, 50);
    
    for (let i = 0; i < records.length; i++) {
        const record = records[i];
        const name = record.getString('accrual_name');
        const partnerName = record.getString('partner_name');
        const repaymentDate = record.getString('repayment_date');
        const daysDifference = record.get('days_difference');
        
        // Фильтруем записи с "Тинек" в имени партнера
        if (partnerName && partnerName.toLowerCase().includes('тинек')) {
            debugData.push({
                name: name,
                partnerName: partnerName,
                repaymentDate: repaymentDate,
                daysDifference: daysDifference,
                daysDifferenceType: typeof daysDifference
            });
        }
    }
} catch (err) {
    error = err;
}
%>

<div class="container mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">Отладка days_difference</h1>
    
    <% if (error) { %>
        <div class="alert alert-error mb-4">
            <span>Ошибка: <%= error.message %></span>
        </div>
    <% } %>
    
    <div class="mb-4">
        <p><strong>Текущая дата:</strong> <%= new Date().toISOString().split('T')[0] %></p>
        <p><strong>Время:</strong> <%= new Date().toISOString() %></p>
    </div>
    
    <% if (debugData.length > 0) { %>
        <div class="overflow-x-auto">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Название</th>
                        <th>Партнер</th>
                        <th>Дата погашения</th>
                        <th>days_difference</th>
                        <th>Тип данных</th>
                        <th>Ожидаемый статус</th>
                    </tr>
                </thead>
                <tbody>
                    <% debugData.forEach(item => { %>
                        <tr>
                            <td><%= item.name %></td>
                            <td><%= item.partnerName %></td>
                            <td><%= item.repaymentDate %></td>
                            <td class="font-mono"><%= item.daysDifference %></td>
                            <td><%= item.daysDifferenceType %></td>
                            <td>
                                <% if (typeof item.daysDifference === 'number') { %>
                                    <% if (item.daysDifference < 0) { %>
                                        <span class="badge badge-error">Просрочено <%= Math.abs(item.daysDifference) %> дн.</span>
                                    <% } else if (item.daysDifference === 0) { %>
                                        <span class="badge badge-warning">Оплата сегодня</span>
                                    <% } else { %>
                                        <span class="badge badge-info">До оплаты <%= item.daysDifference %> дн.</span>
                                    <% } %>
                                <% } else { %>
                                    <span class="badge badge-ghost">Неопределено</span>
                                <% } %>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    <% } else { %>
        <div class="alert alert-info">
            <span>Записи с "Тинек" в имени партнера не найдены</span>
        </div>
    <% } %>
    
    <div class="mt-6">
        <a href="/dashboard/accruals_all_with_status" class="btn btn-primary">
            Вернуться к дашборду
        </a>
    </div>
</div>