<%
meta('title', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è days_difference');

let fixVerification = {
    status: 'unknown',
    message: '',
    details: {},
    targetRecord: null,
    allChecks: []
};

try {
    console.log('=== –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ===');
    console.log('–í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏:', new Date().toLocaleString('ru-RU'));
    
    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
    console.log('1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π...');
    const migrations = $app.dao().findRecordsByFilter('_migrations', '', '-created', 0, 20);
    const finalMigration = migrations.find(m => m.get('file').includes('1762999999'));
    fixVerification.allChecks.push({
        check: '–§–∏–Ω–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞',
        status: finalMigration ? 'OK' : 'FAIL',
        details: finalMigration ? `–ü—Ä–∏–º–µ–Ω–µ–Ω–∞: ${finalMigration.get('created')}` : '–ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
    });
    
    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
    console.log('2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è...');
    const viewInfo = $app.dao().db().newQuery("SELECT sql FROM sqlite_master WHERE type='view' AND name='accruals_all_with_status'").one();
    const viewSql = viewInfo.sql || '';
    const hasCorrectFormula = viewSql.includes("julianday(date('now'))");
    const hasOldFormula = viewSql.includes("julianday('now')") && !viewSql.includes("julianday(date('now'))");
    
    fixVerification.allChecks.push({
        check: '–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ñ–æ—Ä–º—É–ª—É',
        status: hasCorrectFormula ? 'OK' : 'FAIL',
        details: hasCorrectFormula ? 'julianday(date(\'now\')) –Ω–∞–π–¥–µ–Ω–æ' : '–°—Ç–∞—Ä–∞—è —Ñ–æ—Ä–º—É–ª–∞ –≤—Å—ë –µ—â—ë –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è'
    });
    
    // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ü–µ–ª–µ–≤–æ–π –∑–∞–ø–∏—Å–∏
    console.log('3. –ü–æ–∏—Å–∫ —Ü–µ–ª–µ–≤–æ–π –∑–∞–ø–∏—Å–∏...');
    let targetRecords = [];
    
    // –ò—â–µ–º –ø–æ –¥–∞—Ç–µ –ø–æ–≥–∞—à–µ–Ω–∏—è 31.10.2025
    const recordsByDate = $app.findRecordsByFilter('accruals_all_with_status', "repayment_date = '2025-10-31'", '', 0, 20);
    targetRecords = targetRecords.concat(recordsByDate);
    
    // –ò—â–µ–º –ø–æ –∏–º–µ–Ω–∏ –î–µ–Ω–∏—Å
    const recordsByName = $app.findRecordsByFilter('accruals_all_with_status', "partner_name LIKE '%–î–µ–Ω–∏—Å%' OR accrual_name LIKE '%–î–µ–Ω–∏—Å%'", '', 0, 20);
    for (let record of recordsByName) {
        if (!targetRecords.find(r => r.getString('id') === record.getString('id'))) {
            targetRecords.push(record);
        }
    }
    
    console.log('–ù–∞–π–¥–µ–Ω–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π:', targetRecords.length);
    
    // –ò—â–µ–º —Ü–µ–ª–µ–≤—É—é –∑–∞–ø–∏—Å—å (–î–µ–Ω–∏—Å —Å –¥–∞—Ç–æ–π 31.10.2025)
    const mainTarget = targetRecords.find(r => 
        r.getString('repayment_date') === '2025-10-31' && 
        (r.getString('partner_name').toLowerCase().includes('–¥–µ–Ω–∏—Å') || 
         r.getString('accrual_name').toLowerCase().includes('–¥–µ–Ω–∏—Å'))
    );
    
    if (mainTarget) {
        fixVerification.targetRecord = {
            id: mainTarget.getString('id'),
            name: mainTarget.getString('accrual_name'),
            partner: mainTarget.getString('partner_name'),
            repaymentDate: mainTarget.getString('repayment_date'),
            daysDifference: mainTarget.get('days_difference'),
            daysDifferenceType: typeof mainTarget.get('days_difference'),
            balance: mainTarget.get('balance')
        };
        
        const isCorrect = mainTarget.get('days_difference') === -1;
        fixVerification.allChecks.push({
            check: '–¶–µ–ª–µ–≤–∞—è –∑–∞–ø–∏—Å—å –Ω–∞–π–¥–µ–Ω–∞ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞',
            status: isCorrect ? 'OK' : 'FAIL',
            details: `days_difference = ${mainTarget.get('days_difference')} (–æ–∂–∏–¥–∞–µ—Ç—Å—è -1)`
        });
        
        console.log('–¶–µ–ª–µ–≤–∞—è –∑–∞–ø–∏—Å—å –Ω–∞–π–¥–µ–Ω–∞:');
        console.log('  –ù–∞–∑–≤–∞–Ω–∏–µ:', fixVerification.targetRecord.name);
        console.log('  –ü–∞—Ä—Ç–Ω–µ—Ä:', fixVerification.targetRecord.partner);
        console.log('  days_difference:', fixVerification.targetRecord.daysDifference);
        console.log('  –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ:', isCorrect ? '–î–ê' : '–ù–ï–¢');
    } else {
        fixVerification.allChecks.push({
            check: '–¶–µ–ª–µ–≤–∞—è –∑–∞–ø–∏—Å—å –Ω–∞–π–¥–µ–Ω–∞',
            status: 'FAIL',
            details: '–ó–∞–ø–∏—Å—å "–î–µ–Ω–∏—Å –¢–∏–Ω–µ–∫" —Å –¥–∞—Ç–æ–π 31.10.2025 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
        });
        console.log('–¶–ï–õ–ï–í–ê–Ø –ó–ê–ü–ò–°–¨ –ù–ï –ù–ê–ô–î–ï–ù–ê!');
    }
    
    // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ —Å –¥–∞—Ç–æ–π 31.10.2025
    console.log('4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π —Å –¥–∞—Ç–æ–π 31.10.2025...');
    const oct31Records = $app.findRecordsByFilter('accruals_all_with_status', "repayment_date = '2025-10-31'", '', 0, 50);
    let correctCount = 0;
    let totalCount = oct31Records.length;
    
    for (let record of oct31Records) {
        const daysDiff = record.get('days_difference');
        if (daysDiff === -1) correctCount++;
    }
    
    fixVerification.allChecks.push({
        check: '–í—Å–µ –∑–∞–ø–∏—Å–∏ 31.10.2025 –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç -1 –¥–µ–Ω—å',
        status: correctCount === totalCount ? 'OK' : 'PARTIAL',
        details: `${correctCount} –∏–∑ ${totalCount} –∑–∞–ø–∏—Å–µ–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã`
    });
    
    console.log(`–ó–∞–ø–∏—Å–µ–π —Å 31.10.2025: ${totalCount}, –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö: ${correctCount}`);
    
    // –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
    const passedChecks = fixVerification.allChecks.filter(c => c.status === 'OK').length;
    const totalChecks = fixVerification.allChecks.length;
    
    if (passedChecks === totalChecks) {
        fixVerification.status = 'success';
        fixVerification.message = '–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ! –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã.';
    } else if (passedChecks > 0) {
        fixVerification.status = 'partial';
        fixVerification.message = `–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Å—Ç–∏—á–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ. –ü—Ä–æ–π–¥–µ–Ω–æ ${passedChecks} –∏–∑ ${totalChecks} –ø—Ä–æ–≤–µ—Ä–æ–∫.`;
    } else {
        fixVerification.status = 'failed';
        fixVerification.message = '–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ. –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞.';
    }
    
    console.log('–ò–¢–û–ì:', fixVerification.message);
    
} catch (err) {
    fixVerification.status = 'error';
    fixVerification.message = `–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${err.message}`;
    console.log('–û–®–ò–ë–ö–ê –ü–†–û–í–ï–†–ö–ò:', err.message);
}

console.log('=== –ö–û–ù–ï–¶ –ü–†–û–í–ï–†–ö–ò ===');
%>

<div class="container mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è days_difference</h1>
    
    <div class="alert alert-info mb-6">
        <i class="fas fa-info-circle"></i>
        <div>
            <div class="font-semibold">–¶–µ–ª—å –ø—Ä–æ–≤–µ—Ä–∫–∏:</div>
            <div>–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ "–î–µ–Ω–∏—Å –¢–∏–Ω–µ–∫" —Å –¥–∞—Ç–æ–π –ø–æ–≥–∞—à–µ–Ω–∏—è 31.10.2025 —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ 1 –¥–Ω." –≤–º–µ—Å—Ç–æ "–û–ø–ª–∞—Ç–∞ —Å–µ–≥–æ–¥–Ω—è"</div>
        </div>
    </div>
    
    <!-- –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å -->
    <div class="card bg-base-100 shadow mb-6">
        <div class="card-body">
            <div class="flex items-center gap-4">
                <div class="text-4xl">
                    <% if (fixVerification.status === 'success') { %>
                        <span class="text-success">‚úÖ</span>
                    <% } else if (fixVerification.status === 'partial') { %>
                        <span class="text-warning">‚ö†Ô∏è</span>
                    <% } else if (fixVerification.status === 'failed') { %>
                        <span class="text-error">‚ùå</span>
                    <% } else { %>
                        <span class="text-base-content/50">‚ùì</span>
                    <% } %>
                </div>
                <div>
                    <h2 class="text-xl font-bold 
                        <%= fixVerification.status === 'success' ? 'text-success' : 
                            fixVerification.status === 'partial' ? 'text-warning' : 
                            fixVerification.status === 'failed' ? 'text-error' : 'text-base-content' %>">
                        <%= fixVerification.message %>
                    </h2>
                    <p class="text-base-content/70">
                        –í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏: <%= new Date().toLocaleString('ru-RU') %>
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
    <div class="card bg-base-100 shadow mb-6">
        <div class="card-body">
            <h2 class="card-title mb-4">üìã –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏</h2>
            <div class="space-y-3">
                <% fixVerification.allChecks.forEach((check, index) => { %>
                    <div class="flex items-center gap-4 p-3 rounded-lg <%= 
                        check.status === 'OK' ? 'bg-success/10' : 
                        check.status === 'PARTIAL' ? 'bg-warning/10' : 
                        'bg-error/10' %>">
                        <div class="text-xl">
                            <% if (check.status === 'OK') { %>
                                <span class="text-success">‚úÖ</span>
                            <% } else if (check.status === 'PARTIAL') { %>
                                <span class="text-warning">‚ö†Ô∏è</span>
                            <% } else { %>
                                <span class="text-error">‚ùå</span>
                            <% } %>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold"><%= check.check %></div>
                            <div class="text-sm text-base-content/70"><%= check.details %></div>
                        </div>
                        <div class="badge <%= 
                            check.status === 'OK' ? 'badge-success' : 
                            check.status === 'PARTIAL' ? 'badge-warning' : 
                            'badge-error' %>">
                            <%= check.status %>
                        </div>
                    </div>
                <% }) %>
            </div>
        </div>
    </div>
    
    <!-- –¶–µ–ª–µ–≤–∞—è –∑–∞–ø–∏—Å—å -->
    <% if (fixVerification.targetRecord) { %>
        <div class="card bg-base-100 shadow mb-6">
            <div class="card-body">
                <h2 class="card-title mb-4">üéØ –¶–µ–ª–µ–≤–∞—è –∑–∞–ø–∏—Å—å</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> <%= fixVerification.targetRecord.name %><br>
                        <strong>–ü–∞—Ä—Ç–Ω–µ—Ä:</strong> <%= fixVerification.targetRecord.partner %><br>
                        <strong>–î–∞—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è:</strong> <%= fixVerification.targetRecord.repaymentDate %>
                    </div>
                    <div>
                        <strong>days_difference:</strong> 
                        <span class="font-mono <%= fixVerification.targetRecord.daysDifference === -1 ? 'text-success font-bold' : 'text-error font-bold' %>">
                            <%= fixVerification.targetRecord.daysDifference %>
                        </span>
                        (<%= fixVerification.targetRecord.daysDifferenceType %>)<br>
                        <strong>–ë–∞–ª–∞–Ω—Å:</strong> <%= fixVerification.targetRecord.balance %> ‚ÇΩ
                    </div>
                </div>
                
                <div class="mt-4 p-4 rounded-lg <%= 
                    fixVerification.targetRecord.daysDifference === -1 ? 'bg-success/20' : 'bg-error/20' %>">
                    <div class="font-semibold">
                        <% if (fixVerification.targetRecord.daysDifference === -1) { %>
                            ‚úÖ –°—Ç–∞—Ç—É—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω: "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ 1 –¥–Ω."
                        <% } else if (fixVerification.targetRecord.daysDifference === 0) { %>
                            ‚ùå –°—Ç–∞—Ç—É—Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω: "–û–ø–ª–∞—Ç–∞ —Å–µ–≥–æ–¥–Ω—è" (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ 1 –¥–Ω.")
                        <% } else { %>
                            ‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: <%= fixVerification.targetRecord.daysDifference %>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    <% } else { %>
        <div class="card bg-base-100 shadow mb-6">
            <div class="card-body">
                <h2 class="card-title text-error mb-4">üéØ –¶–µ–ª–µ–≤–∞—è –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</h2>
                <div class="alert alert-error">
                    <span>–ó–∞–ø–∏—Å—å "–î–µ–Ω–∏—Å –¢–∏–Ω–µ–∫" —Å –¥–∞—Ç–æ–π –ø–æ–≥–∞—à–µ–Ω–∏—è 31.10.2025 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</span>
                </div>
            </div>
        </div>
    <% } %>
    
    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div class="flex gap-4 flex-wrap">
        <button onclick="window.location.reload()" class="btn btn-primary">
            <i class="fas fa-sync-alt"></i>
            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É
        </button>
        
        <% if (fixVerification.status === 'success') { %>
            <a href="/dashboard/accruals_all_with_status" class="btn btn-success">
                <i class="fas fa-chart-line"></i>
                –ü–µ—Ä–µ–π—Ç–∏ –∫ –¥–∞—à–±–æ—Ä–¥—É
            </a>
        <% } else { %>
            <a href="/debug/sql_test" class="btn btn-secondary">
                <i class="fas fa-bug"></i>
                SQL —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            </a>
            <a href="/debug/all_accruals" class="btn btn-secondary">
                <i class="fas fa-list"></i>
                –í—Å–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
            </a>
        <% } %>
        
        <details class="dropdown">
            <summary class="btn btn-ghost">
                <i class="fas fa-cog"></i>
                –î—Ä—É–≥–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
            </summary>
            <ul class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow">
                <li><a href="/debug/search_tinek">–ü–æ–∏—Å–∫ –¢–∏–Ω–µ–∫</a></li>
                <li><a href="/debug/schema_check">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ö–µ–º—ã</a></li>
                <li><a href="/debug/sql_test">SQL —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</a></li>
                <li><a href="/debug/all_accruals">–í—Å–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è</a></li>
            </ul>
        </details>
    </div>
</div>