<%
meta('title', '–¢–µ—Å—Ç SQL –∑–∞–ø—Ä–æ—Å–∞ days_difference');

let sqlResult = null;
let error = null;
let currentDate = new Date().toISOString().split('T')[0];

try {
    // –ü—Ä—è–º–æ–π SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞—Å—á–µ—Ç–∞ days_difference
    const testSql = `
        SELECT 
            accrual_name,
            partner_name,
            repayment_date,
            date('now') as current_date,
            julianday('now') as julianday_now_with_time,
            julianday(date('now')) as julianday_now_date_only,
            julianday(repayment_date) as julianday_repayment,
            (julianday(repayment_date) - julianday(date('now'))) as days_diff_corrected,
            (julianday(repayment_date) - julianday('now')) as days_diff_old
        FROM accruals 
        WHERE partner_name LIKE '%–¢–∏–Ω–µ–∫%' 
           OR accrual_name LIKE '%–¢–∏–Ω–µ–∫%'
           OR partner_name LIKE '%–î–µ–Ω–∏—Å%'
           OR accrual_name LIKE '%–î–µ–Ω–∏—Å%'
           OR repayment_date = '2025-10-31'
        ORDER BY repayment_date, accrual_name
        LIMIT 10;
    `;
    
    console.log('=== –¢–ï–°–¢ SQL –ó–ê–ü–†–û–°–ê ===');
    console.log('–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞:', currentDate);
    console.log('SQL:', testSql);
    console.log('');
    
    sqlResult = $app.dao().db().newQuery(testSql).all();
    
    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', sqlResult.length);
    sqlResult.forEach((row, index) => {
        console.log(`--- –°—Ç—Ä–æ–∫–∞ ${index + 1} ---`);
        console.log('–ù–∞–∑–≤–∞–Ω–∏–µ:', row.accrual_name);
        console.log('–ü–∞—Ä—Ç–Ω–µ—Ä:', row.partner_name);
        console.log('–î–∞—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è:', row.repayment_date);
        console.log('–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ (SQL):', row.current_date);
        console.log('julianday now —Å –≤—Ä–µ–º–µ–Ω–µ–º:', row.julianday_now_with_time);
        console.log('julianday now —Ç–æ–ª—å–∫–æ –¥–∞—Ç–∞:', row.julianday_now_date_only);
        console.log('julianday –ø–æ–≥–∞—à–µ–Ω–∏—è:', row.julianday_repayment);
        console.log('days_diff –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π:', row.days_diff_corrected);
        console.log('days_diff —Å—Ç–∞—Ä—ã–π:', row.days_diff_old);
        console.log('');
    });
    
} catch (err) {
    error = err;
    console.log('–û–®–ò–ë–ö–ê SQL:', err.message);
}

console.log('=== –ö–û–ù–ï–¶ –¢–ï–°–¢–ê ===');
%>

<div class="container mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">–¢–µ—Å—Ç SQL –∑–∞–ø—Ä–æ—Å–∞ days_difference</h1>
    
    <div class="alert alert-info mb-4">
        <i class="fas fa-database"></i>
        <span>–ü—Ä—è–º–æ–π SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞—Å—á–µ—Ç–∞ days_difference. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∫–æ–Ω—Å–æ–ª–∏ PocketBase.</span>
    </div>
    
    <div class="card bg-base-100 shadow mb-4">
        <div class="card-body">
            <h2 class="card-title">–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <strong>–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ JavaScript:</strong><br>
                    <%= new Date().toISOString().split('T')[0] %>
                </div>
                <div>
                    <strong>–í—Ä–µ–º—è JavaScript:</strong><br>
                    <%= new Date().toLocaleTimeString('ru-RU') %>
                </div>
            </div>
        </div>
    </div>
    
    <% if (error) { %>
        <div class="alert alert-error mb-4">
            <span>–û—à–∏–±–∫–∞ SQL: <%= error.message %></span>
        </div>
    <% } %>
    
    <% if (sqlResult && sqlResult.length > 0) { %>
        <div class="card bg-base-100 shadow">
            <div class="card-body">
                <h2 class="card-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã SQL –∑–∞–ø—Ä–æ—Å–∞ (<%= sqlResult.length %>)</h2>
                <div class="overflow-x-auto">
                    <table class="table table-zebra table-sm">
                        <thead>
                            <tr>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–ü–∞—Ä—Ç–Ω–µ—Ä</th>
                                <th>–î–∞—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è</th>
                                <th>–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ SQL</th>
                                <th>julianday('now')</th>
                                <th>julianday(date('now'))</th>
                                <th>–°—Ç–∞—Ä—ã–π —Ä–∞—Å—á—ë—Ç</th>
                                <th>–ù–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç</th>
                                <th>–†–∞–∑–Ω–∏—Ü–∞</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% sqlResult.forEach((row, index) => { %>
                                <% 
                                const oldCalc = typeof row.days_diff_old === 'number' ? row.days_diff_old : parseFloat(row.days_diff_old);
                                const newCalc = typeof row.days_diff_corrected === 'number' ? row.days_diff_corrected : parseFloat(row.days_diff_corrected);
                                const isDifferent = Math.abs(oldCalc - newCalc) > 0.1;
                                const isTarget = row.repayment_date === '2025-10-31';
                                %>
                                <tr class="<%= isTarget ? 'bg-warning/20 ring-2 ring-warning' : isDifferent ? 'bg-info/10' : '' %>">
                                    <td>
                                        <%= row.accrual_name %>
                                        <% if (isTarget) { %>
                                            <span class="badge badge-warning badge-xs">üéØ</span>
                                        <% } %>
                                    </td>
                                    <td><%= row.partner_name %></td>
                                    <td class="whitespace-nowrap"><%= row.repayment_date %></td>
                                    <td class="whitespace-nowrap"><%= row.current_date %></td>
                                    <td class="font-mono text-xs"><%= parseFloat(row.julianday_now_with_time).toFixed(5) %></td>
                                    <td class="font-mono text-xs"><%= parseFloat(row.julianday_now_date_only).toFixed(5) %></td>
                                    <td class="font-mono <%= isDifferent ? 'text-error' : '' %>">
                                        <%= oldCalc.toFixed(2) %>
                                    </td>
                                    <td class="font-mono <%= isDifferent ? 'text-success font-bold' : '' %>">
                                        <%= newCalc.toFixed(2) %>
                                    </td>
                                    <td class="text-center">
                                        <% if (isDifferent) { %>
                                            <span class="badge badge-warning badge-sm">
                                                <%= (newCalc - oldCalc).toFixed(2) %>
                                            </span>
                                        <% } else { %>
                                            <span class="text-success">‚úì</span>
                                        <% } %>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 p-4 bg-info/20 rounded">
                    <h3 class="font-semibold mb-2">–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:</h3>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>julianday('now')</strong> - –≤–∫–ª—é—á–∞–µ—Ç –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 12:30), –ø–æ—ç—Ç–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω—ã–π</li>
                        <li><strong>julianday(date('now'))</strong> - —Ç–æ–ª—å–∫–æ –¥–∞—Ç–∞ (–ø–æ–ª–Ω–æ—á—å), –ø–æ—ç—Ç–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–æ—á–Ω—ã–π</li>
                        <li><strong>–°—Ç–∞—Ä—ã–π —Ä–∞—Å—á—ë—Ç</strong> - —Å –≤—Ä–µ–º–µ–Ω–µ–º, –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å 0 –≤–º–µ—Å—Ç–æ -1</li>
                        <li><strong>–ù–æ–≤—ã–π —Ä–∞—Å—á—ë—Ç</strong> - –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏, –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</li>
                        <li>üéØ - —Ü–µ–ª–µ–≤–∞—è –∑–∞–ø–∏—Å—å —Å –¥–∞—Ç–æ–π 31.10.2025, –¥–æ–ª–∂–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å -1</li>
                    </ul>
                </div>
            </div>
        </div>
    <% } else if (!error) { %>
        <div class="alert alert-warning">
            <span>–ó–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –í–æ–∑–º–æ–∂–Ω–æ, –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –±–∞–∑–µ.</span>
        </div>
    <% } %>
    
    <div class="mt-6 flex gap-2">
        <button onclick="window.location.reload()" class="btn btn-primary">
            <i class="fas fa-sync-alt"></i>
            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å
        </button>
        <a href="/debug/all_accruals" class="btn btn-secondary">
            –í—Å–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
        </a>
        <a href="/debug/search_tinek" class="btn btn-secondary">
            –ü–æ–∏—Å–∫ –¢–∏–Ω–µ–∫
        </a>
        <a href="/dashboard" class="btn btn-ghost">
            –î–∞—à–±–æ—Ä–¥
        </a>
    </div>
</div>