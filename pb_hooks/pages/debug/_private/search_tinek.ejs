<%
meta('title', 'Поиск начисления Денис Тинек');

let searchResults = [];
let error = null;

try {
    // Ищем по разным критериям
    const byPartner = $app.findRecordsByFilter('accruals_all_with_status', "partner_name LIKE '%Тинек%'", '', 0, 10);
    const byName = $app.findRecordsByFilter('accruals_all_with_status', "accrual_name LIKE '%Тинек%'", '', 0, 10);
    const byDescription = $app.findRecordsByFilter('accruals_all_with_status', "description LIKE '%Тинек%'", '', 0, 10);
    
    console.log('=== ПОИСК НАЧИСЛЕНИЯ ДЕНИС ТИНЕК ===');
    console.log('Время:', new Date().toLocaleString('ru-RU'));
    console.log('По партнеру:', byPartner.length, 'записей');
    console.log('По названию:', byName.length, 'записей');
    console.log('По описанию:', byDescription.length, 'записей');
    
    // Объединяем результаты
    const allResults = [...byPartner, ...byName, ...byDescription];
    const uniqueResults = [];
    const seenIds = new Set();
    
    for (let record of allResults) {
        const id = record.getString('id');
        if (!seenIds.has(id)) {
            seenIds.add(id);
            
            const data = {
                id: id,
                name: record.getString('accrual_name'),
                number: record.getString('number'),
                partnerName: record.getString('partner_name'),
                costItemName: record.getString('cost_item_name'),
                repaymentDate: record.getString('repayment_date'),
                daysDifference: record.get('days_difference'),
                daysDifferenceType: typeof record.get('days_difference'),
                balance: record.get('balance'),
                totalAccrued: record.get('total_accrued'),
                totalPaid: record.get('total_paid'),
                isForcedClosed: record.get('is_forced_closed'),
                created: record.getString('created'),
                updated: record.getString('updated')
            };
            
            uniqueResults.push(data);
            
            console.log('--- Найденная запись ---');
            console.log('ID:', data.id);
            console.log('Название:', data.name);
            console.log('Партнер:', data.partnerName);
            console.log('Дата погашения:', data.repaymentDate);
            console.log('days_difference:', data.daysDifference, '(тип:', data.daysDifferenceType + ')');
            console.log('Баланс:', data.balance);
            console.log('');
        }
    }
    
    searchResults = uniqueResults;
    
} catch (err) {
    error = err;
    console.log('ОШИБКА поиска:', err.message);
}

console.log('=== КОНЕЦ ПОИСКА ===');

// Функция для определения статуса
const getStatusInfo = (daysDifference) => {
    if (typeof daysDifference !== 'number') {
        return { status: 'unknown', label: 'Неопределено', class: 'badge-ghost' };
    }
    if (daysDifference < 0) {
        return { 
            status: 'overdue', 
            label: `Просрочено ${Math.abs(daysDifference)} дн.`, 
            class: 'badge-error' 
        };
    }
    if (daysDifference === 0) {
        return { 
            status: 'due-today', 
            label: 'Оплата сегодня', 
            class: 'badge-warning' 
        };
    }
    return { 
        status: 'upcoming', 
        label: `До оплаты ${daysDifference} дн.`, 
        class: 'badge-info' 
    };
};
%>

<div class="container mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">Поиск начисления "Денис Тинек"</h1>
    
    <div class="alert alert-info mb-4">
        <i class="fas fa-search"></i>
        <span>Поиск выполняется по партнеру, названию и описанию. Результаты выводятся в консоль PocketBase.</span>
    </div>
    
    <div class="space-y-4">
        <div class="card bg-base-100 shadow">
            <div class="card-body">
                <h2 class="card-title">Системная информация</h2>
                <p><strong>Текущая дата:</strong> <%= new Date().toISOString().split('T')[0] %></p>
                <p><strong>Время:</strong> <%= new Date().toLocaleTimeString('ru-RU') %></p>
            </div>
        </div>
        
        <% if (error) { %>
            <div class="alert alert-error">
                <span>Ошибка поиска: <%= error.message %></span>
            </div>
        <% } %>
        
        <div class="card bg-base-100 shadow">
            <div class="card-body">
                <h2 class="card-title">Результаты поиска: <%= searchResults.length %> записей</h2>
                
                <% if (searchResults.length === 0) { %>
                    <div class="alert alert-warning">
                        <span>Начисления с "Тинек" не найдено. Возможно, имя отличается?</span>
                    </div>
                    
                    <div class="mt-4">
                        <h3 class="text-lg font-semibold mb-2">Попробуйте альтернативные поиски:</h3>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="searchByKeyword('Денис')" class="btn btn-sm btn-outline">
                                Поиск "Денис"
                            </button>
                            <button onclick="searchByKeyword('АДО')" class="btn btn-sm btn-outline">
                                Поиск "АДО"
                            </button>
                            <button onclick="searchByKeyword('Кредит')" class="btn btn-sm btn-outline">
                                Поиск "Кредит"
                            </button>
                        </div>
                    </div>
                <% } else { %>
                    <div class="overflow-x-auto">
                        <table class="table table-zebra table-sm">
                            <thead>
                                <tr>
                                    <th>Название</th>
                                    <th>Партнер</th>
                                    <th>Статья</th>
                                    <th>Дата погашения</th>
                                    <th>days_difference</th>
                                    <th>Статус</th>
                                    <th>Баланс</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% searchResults.forEach(result => { %>
                                    <% const statusInfo = getStatusInfo(result.daysDifference); %>
                                    <tr class="<%= statusInfo.status === 'overdue' ? 'bg-error/10' : statusInfo.status === 'due-today' ? 'bg-warning/10' : '' %>">
                                        <td>
                                            <div class="font-semibold"><%= result.name %></div>
                                            <div class="text-xs text-base-content/60"><%= result.number || 'Без номера' %></div>
                                        </td>
                                        <td><%= result.partnerName %></td>
                                        <td><%= result.costItemName %></td>
                                        <td class="whitespace-nowrap">
                                            <%= result.repaymentDate %>
                                        </td>
                                        <td class="font-mono">
                                            <%= result.daysDifference %> 
                                            <span class="text-xs text-base-content/60">(<%= result.daysDifferenceType %>)</span>
                                        </td>
                                        <td>
                                            <span class="badge <%= statusInfo.class %>"><%= statusInfo.label %></span>
                                        </td>
                                        <td class="text-right">
                                            <div class="font-semibold <%= result.balance > 0 ? 'text-error' : 'text-success' %>">
                                                <%= typeof result.balance === 'number' ? result.balance.toFixed(2) + ' ₽' : result.balance %>
                                            </div>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                    
                    <% if (searchResults.length > 0) { %>
                        <div class="mt-4 p-4 bg-info/20 rounded">
                            <h3 class="font-semibold mb-2">Анализ найденных записей:</h3>
                            <% searchResults.forEach((result, index) => { %>
                                <div class="mb-2">
                                    <strong>Запись <%= index + 1 %>:</strong>
                                    <% if (result.repaymentDate === '2025-10-31') { %>
                                        <span class="text-success">✓ Дата погашения корректная (31.10.2025)</span>
                                    <% } else { %>
                                        <span class="text-warning">⚠ Дата погашения: <%= result.repaymentDate %></span>
                                    <% } %>
                                    
                                    <% if (result.daysDifference === -1) { %>
                                        <span class="text-success"> ✓ days_difference правильное (-1)</span>
                                    <% } else if (result.daysDifference === 0) { %>
                                        <span class="text-warning"> ⚠ days_difference = 0 (может быть ошибка)</span>
                                    <% } else { %>
                                        <span class="text-error"> ✗ days_difference неожиданное (<%= result.daysDifference %>)</span>
                                    <% } %>
                                </div>
                            <% }) %>
                        </div>
                    <% } %>
                <% } %>
            </div>
        </div>
    </div>
    
    <div class="mt-6 flex gap-2">
        <button onclick="window.location.reload()" class="btn btn-primary">
            <i class="fas fa-sync-alt"></i>
            Обновить поиск
        </button>
        <a href="/dashboard" class="btn btn-secondary">
            Вернуться к дашборду
        </a>
        <a href="/debug/schema_check" class="btn btn-ghost">
            Проверка схемы
        </a>
    </div>
</div>

<script>
function searchByKeyword(keyword) {
    // Перенаправляем на поиск с другим ключевым словом
    alert('Функция поиска по ключевому слову "' + keyword + '" пока не реализована. Проверьте консоль PocketBase для подробной информации.');
}
</script>