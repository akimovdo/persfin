<%
meta('title', '–û—Ç–ª–∞–¥–∫–∞ –¥–∞—Ç –∏ –≤—Ä–µ–º–µ–Ω–∏');

// –í—ã–≤–æ–¥–∏–º –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –≤—Ä–µ–º–µ–Ω–∏
console.log('=== –û–¢–õ–ê–î–ö–ê –î–ê–¢ –ò –í–†–ï–ú–ï–ù–ò ===');
console.log('–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è JavaScript:', new Date().toISOString());
console.log('–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ JavaScript:', new Date().toISOString().split('T')[0]);
console.log('–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –ª–æ–∫–∞–ª—å–Ω–æ–µ (–†–æ—Å—Å–∏—è):', new Date().toLocaleString('ru-RU', { timeZone: 'Europe/Moscow' }));

// –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É —á–µ—Ä–µ–∑ SQL
let sqlDateInfo = {};
try {
    const dateQuery = `
        SELECT 
            datetime('now') as sqlite_datetime_now,
            date('now') as sqlite_date_now,
            time('now') as sqlite_time_now,
            julianday('now') as sqlite_julianday_now,
            julianday(date('now')) as sqlite_julianday_date_now,
            (julianday(date('now')) - julianday('2025-10-31')) as days_from_oct31
    `;
    
    const dateResult = $app.dao().db().newQuery(dateQuery).one();
    sqlDateInfo = {
        datetime_now: dateResult.sqlite_datetime_now,
        date_now: dateResult.sqlite_date_now,
        time_now: dateResult.sqlite_time_now,
        julianday_now: dateResult.sqlite_julianday_now,
        julianday_date_now: dateResult.sqlite_julianday_date_now,
        days_from_oct31: dateResult.days_from_oct31
    };
    
    console.log('SQLite datetime(\'now\'):', sqlDateInfo.datetime_now);
    console.log('SQLite date(\'now\'):', sqlDateInfo.date_now);
    console.log('SQLite time(\'now\'):', sqlDateInfo.time_now);
    console.log('SQLite julianday(\'now\'):', sqlDateInfo.julianday_now);
    console.log('SQLite julianday(date(\'now\')):', sqlDateInfo.julianday_date_now);
    console.log('–†–∞–∑–Ω–∏—Ü–∞ –æ—Ç 31.10.2025 (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 1):', sqlDateInfo.days_from_oct31);
    
} catch (err) {
    console.log('–û—à–∏–±–∫–∞ SQL –∑–∞–ø—Ä–æ—Å–∞ –¥–∞—Ç:', err.message);
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∑–∞–ø–∏—Å—å –î–µ–Ω–∏—Å –¢–∏–Ω–µ–∫
let targetRecord = null;
try {
    const records = $app.findRecordsByFilter('accruals_all_with_status', "repayment_date = '2025-10-31'", '', 0, 10);
    console.log('');
    console.log('=== –ó–ê–ü–ò–°–ò –° –î–ê–¢–û–ô –ü–û–ì–ê–®–ï–ù–ò–Ø 31.10.2025 ===');
    console.log('–ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π:', records.length);
    
    records.forEach((record, index) => {
        const name = record.getString('accrual_name');
        const partner = record.getString('partner_name');
        const repaymentDate = record.getString('repayment_date');
        const daysDiff = record.get('days_difference');
        
        console.log(`--- –ó–∞–ø–∏—Å—å ${index + 1} ---`);
        console.log('–ù–∞–∑–≤–∞–Ω–∏–µ:', name);
        console.log('–ü–∞—Ä—Ç–Ω–µ—Ä:', partner);
        console.log('–î–∞—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è:', repaymentDate);
        console.log('days_difference:', daysDiff, '(—Ç–∏–ø:', typeof daysDiff + ')');
        
        // –ò—â–µ–º –∑–∞–ø–∏—Å—å —Å "–î–µ–Ω–∏—Å" –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∏–ª–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–µ
        if (name.toLowerCase().includes('–¥–µ–Ω–∏—Å') || partner.toLowerCase().includes('–¥–µ–Ω–∏—Å')) {
            targetRecord = {
                id: record.getString('id'),
                name: name,
                partner: partner,
                repaymentDate: repaymentDate,
                daysDifference: daysDiff,
                totalAccrued: record.get('total_accrued'),
                totalPaid: record.get('total_paid'),
                balance: record.get('balance')
            };
            console.log('>>> –≠–¢–û –¶–ï–õ–ï–í–ê–Ø –ó–ê–ü–ò–°–¨ (—Å–æ–¥–µ—Ä–∂–∏—Ç "–î–µ–Ω–∏—Å") <<<');
        }
        console.log('');
    });
    
} catch (err) {
    console.log('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∑–∞–ø–∏—Å–µ–π:', err.message);
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ accruals_all_with_status
let viewSQL = '';
try {
    const viewInfo = $app.dao().db().newQuery("SELECT sql FROM sqlite_master WHERE type='view' AND name='accruals_all_with_status'").one();
    viewSQL = viewInfo.sql || '';
    
    console.log('');
    console.log('=== SQL –ü–†–ï–î–°–¢–ê–í–õ–ï–ù–ò–Ø accruals_all_with_status ===');
    console.log('–°–æ–¥–µ—Ä–∂–∏—Ç julianday(date(\'now\')):', viewSQL.includes("julianday(date('now'))"));
    console.log('–°–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞—Ä—É—é julianday(\'now\'):', viewSQL.includes("julianday('now')") && !viewSQL.includes("julianday(date('now'))"));
    
    // –í—ã–≤–æ–¥–∏–º —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Å days_difference
    const daysDiffMatch = viewSQL.match(/days_difference[^,\)]+/i);
    if (daysDiffMatch) {
        console.log('–§–æ—Ä–º—É–ª–∞ days_difference:', daysDiffMatch[0]);
    }
    
} catch (err) {
    console.log('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è SQL –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è:', err.message);
}

console.log('=== –ö–û–ù–ï–¶ –û–¢–õ–ê–î–ö–ò ===');
%>

<div class="container mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">üïê –û—Ç–ª–∞–¥–∫–∞ –¥–∞—Ç –∏ –≤—Ä–µ–º–µ–Ω–∏</h1>
    
    <div class="alert alert-info mb-6">
        <i class="fas fa-info-circle"></i>
        <span>–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞—Ç–∞—Ö –≤—ã–≤–æ–¥–∏—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å PocketBase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ—Ä–º–∏–Ω–∞–ª.</span>
    </div>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è JavaScript -->
    <div class="card bg-base-100 shadow mb-4">
        <div class="card-body">
            <h2 class="card-title">üìÖ JavaScript –¥–∞—Ç—ã</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <strong>–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞:</strong><br>
                    <code><%= new Date().toISOString().split('T')[0] %></code>
                </div>
                <div>
                    <strong>–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è:</strong><br>
                    <code><%= new Date().toISOString() %></code>
                </div>
                <div>
                    <strong>–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è (–†–§):</strong><br>
                    <code><%= new Date().toLocaleString('ru-RU', { timeZone: 'Europe/Moscow' }) %></code>
                </div>
                <div>
                    <strong>UTC –≤—Ä–µ–º—è:</strong><br>
                    <code><%= new Date().toISOString() %></code>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è SQLite -->
    <div class="card bg-base-100 shadow mb-4">
        <div class="card-body">
            <h2 class="card-title">üóÑÔ∏è SQLite –¥–∞—Ç—ã</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <strong>date('now'):</strong><br>
                    <code><%= sqlDateInfo.date_now || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è' %></code>
                </div>
                <div>
                    <strong>datetime('now'):</strong><br>
                    <code><%= sqlDateInfo.datetime_now || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è' %></code>
                </div>
                <div>
                    <strong>julianday('now'):</strong><br>
                    <code><%= sqlDateInfo.julianday_now || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è' %></code>
                </div>
                <div>
                    <strong>julianday(date('now')):</strong><br>
                    <code><%= sqlDateInfo.julianday_date_now || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è' %></code>
                </div>
                <div class="md:col-span-2">
                    <strong>–î–Ω–µ–π –æ—Ç 31.10.2025:</strong><br>
                    <code class="<%= sqlDateInfo.days_from_oct31 == 1 ? 'text-success' : 'text-error' %>">
                        <%= sqlDateInfo.days_from_oct31 || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è' %>
                        <%= sqlDateInfo.days_from_oct31 == 1 ? '‚úÖ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)' : '‚ùå (–æ—à–∏–±–∫–∞, –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 1)' %>
                    </code>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –¶–µ–ª–µ–≤–∞—è –∑–∞–ø–∏—Å—å -->
    <% if (targetRecord) { %>
        <div class="card bg-base-100 shadow mb-4">
            <div class="card-body">
                <h2 class="card-title">üéØ –¶–µ–ª–µ–≤–∞—è –∑–∞–ø–∏—Å—å (–î–µ–Ω–∏—Å)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> <%= targetRecord.name %><br>
                        <strong>–ü–∞—Ä—Ç–Ω–µ—Ä:</strong> <%= targetRecord.partner %><br>
                        <strong>–î–∞—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è:</strong> <%= targetRecord.repaymentDate %>
                    </div>
                    <div>
                        <strong>days_difference:</strong> 
                        <span class="<%= targetRecord.daysDifference === -1 ? 'text-success' : 'text-error' %> font-bold">
                            <%= targetRecord.daysDifference %>
                        </span>
                        (<%= typeof targetRecord.daysDifference %>)<br>
                        <strong>–ë–∞–ª–∞–Ω—Å:</strong> <%= targetRecord.balance %> ‚ÇΩ
                    </div>
                </div>
                
                <div class="mt-4 p-4 rounded-lg <%= targetRecord.daysDifference === -1 ? 'bg-success/20' : 'bg-error/20' %>">
                    <% if (targetRecord.daysDifference === -1) { %>
                        <span class="text-success font-bold">‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ 1 –¥–Ω."</span>
                    <% } else if (targetRecord.daysDifference === 0) { %>
                        <span class="text-warning font-bold">‚ö†Ô∏è –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–û–ø–ª–∞—Ç–∞ —Å–µ–≥–æ–¥–Ω—è" (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)</span>
                    <% } else { %>
                        <span class="text-error font-bold">‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: <%= targetRecord.daysDifference %></span>
                    <% } %>
                </div>
            </div>
        </div>
    <% } else { %>
        <div class="card bg-base-100 shadow mb-4">
            <div class="card-body">
                <h2 class="card-title text-warning">‚ö†Ô∏è –¶–µ–ª–µ–≤–∞—è –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</h2>
                <p>–ó–∞–ø–∏—Å—å —Å "–î–µ–Ω–∏—Å" –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∏–ª–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–µ –∏ –¥–∞—Ç–æ–π –ø–æ–≥–∞—à–µ–Ω–∏—è 31.10.2025 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.</p>
            </div>
        </div>
    <% } %>
    
    <!-- –°—Ç–∞—Ç—É—Å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è -->
    <div class="card bg-base-100 shadow mb-4">
        <div class="card-body">
            <h2 class="card-title">üìä –°—Ç–∞—Ç—É—Å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è</h2>
            <div class="space-y-2">
                <div class="flex items-center gap-2">
                    <span class="<%= viewSQL.includes("julianday(date('now'))") ? 'text-success' : 'text-error' %>">
                        <%= viewSQL.includes("julianday(date('now'))") ? '‚úÖ' : '‚ùå' %>
                    </span>
                    <span>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é —Ñ–æ—Ä–º—É–ª—É julianday(date('now'))</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="<%= viewSQL.includes("julianday('now')") && !viewSQL.includes("julianday(date('now'))") ? 'text-error' : 'text-success' %>">
                        <%= viewSQL.includes("julianday('now')") && !viewSQL.includes("julianday(date('now'))") ? '‚ùå' : '‚úÖ' %>
                    </span>
                    <span>–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—É—é —Ñ–æ—Ä–º—É–ª—É julianday('now')</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="flex gap-4">
        <button onclick="window.location.reload()" class="btn btn-primary">
            <i class="fas fa-sync-alt"></i>
            –û–±–Ω–æ–≤–∏—Ç—å
        </button>
        <a href="/dashboard/accruals_all_with_status" class="btn btn-secondary">
            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –¥–∞—à–±–æ—Ä–¥—É
        </a>
        <a href="/debug/final_check" class="btn btn-info">
            –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        </a>
    </div>
</div>