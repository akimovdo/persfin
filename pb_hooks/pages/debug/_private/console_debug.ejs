<%
meta('title', 'Консольная диагностика');

// Логируем в консоль PocketBase для отладки
console.log('=== ДИАГНОСТИКА ДАННЫХ ===');
console.log('Время:', new Date().toLocaleString('ru-RU'));

let diagnostics = {
    currentTime: new Date().toISOString(),
    currentDate: new Date().toISOString().split('T')[0],
    records: [],
    error: null
};

try {
    // Ищем конкретно записи с Тинек
    const records = $app.findRecordsByFilter('accruals_all_with_status', "partner_name LIKE '%Тинек%'", '', 0, 5);
    
    console.log('Найдено записей с Тинек:', records.length);
    
    for (let i = 0; i < records.length; i++) {
        const record = records[i];
        
        const recordData = {
            id: record.getString('id'),
            name: record.getString('accrual_name'),
            partnerName: record.getString('partner_name'),
            repaymentDate: record.getString('repayment_date'),
            daysDifference: record.get('days_difference'),
            daysDifferenceType: typeof record.get('days_difference'),
            balance: record.get('balance'),
            isForcedClosed: record.get('is_forced_closed')
        };
        
        diagnostics.records.push(recordData);
        
        // Подробное логирование в консоль PocketBase
        console.log('--- Запись ' + (i + 1) + ' ---');
        console.log('ID:', recordData.id);
        console.log('Название:', recordData.name);
        console.log('Партнер:', recordData.partnerName);
        console.log('Дата погашения:', recordData.repaymentDate);
        console.log('days_difference:', recordData.daysDifference, '(тип:', recordData.daysDifferenceType + ')');
        console.log('Баланс:', recordData.balance);
        console.log('Принудительно закрыто:', recordData.isForcedClosed);
        
        // Определяем ожидаемый статус
        let expectedStatus = 'Неопределено';
        if (typeof recordData.daysDifference === 'number') {
            if (recordData.daysDifference < 0) {
                expectedStatus = `Просрочено ${Math.abs(recordData.daysDifference)} дн.`;
            } else if (recordData.daysDifference === 0) {
                expectedStatus = 'Оплата сегодня';
            } else {
                expectedStatus = `До оплаты ${recordData.daysDifference} дн.`;
            }
        }
        console.log('Ожидаемый статус:', expectedStatus);
        console.log('');
    }
    
    // Также проверим сырые данные из таблицы accruals
    if (records.length > 0) {
        const firstRecord = records[0];
        const accrualId = firstRecord.getString('id');
        
        console.log('=== СЫРЫЕ ДАННЫЕ ИЗ ТАБЛИЦЫ ACCRUALS ===');
        const rawRecords = $app.findRecordsByFilter('accruals', `id = '${accrualId}'`, '', 0, 1);
        
        if (rawRecords.length > 0) {
            const rawRecord = rawRecords[0];
            console.log('RAW - ID:', rawRecord.getString('id'));
            console.log('RAW - Название:', rawRecord.getString('name'));
            console.log('RAW - Дата погашения:', rawRecord.getString('repayment_date'));
            console.log('RAW - Сумма:', rawRecord.get('sum'));
            console.log('RAW - Принудительно закрыто:', rawRecord.get('is_forced_closed'));
        }
    }
    
} catch (err) {
    diagnostics.error = err.message;
    console.log('ОШИБКА:', err.message);
}

console.log('=== КОНЕЦ ДИАГНОСТИКИ ===');
%>

<div class="container mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">Консольная диагностика</h1>
    
    <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle"></i>
        <span>Проверьте консоль PocketBase для вывода информации о данных</span>
    </div>
    
    <div class="space-y-4">
        <div class="card bg-base-100 shadow">
            <div class="card-body">
                <h2 class="card-title">Системная информация</h2>
                <p><strong>Время:</strong> <%= diagnostics.currentTime %></p>
                <p><strong>Дата:</strong> <%= diagnostics.currentDate %></p>
            </div>
        </div>
        
        <% if (diagnostics.error) { %>
            <div class="alert alert-error">
                <span>Ошибка: <%= diagnostics.error %></span>
            </div>
        <% } %>
        
        <% if (diagnostics.records.length > 0) { %>
            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <h2 class="card-title">Найдено записей: <%= diagnostics.records.length %></h2>
                    
                    <div class="overflow-x-auto">
                        <table class="table table-zebra table-sm">
                            <thead>
                                <tr>
                                    <th>Название</th>
                                    <th>Партнер</th>
                                    <th>Дата погашения</th>
                                    <th>days_difference</th>
                                    <th>Статус</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% diagnostics.records.forEach(record => { %>
                                    <tr>
                                        <td><%= record.name %></td>
                                        <td><%= record.partnerName %></td>
                                        <td><%= record.repaymentDate %></td>
                                        <td class="font-mono">
                                            <%= record.daysDifference %> 
                                            <span class="text-xs text-base-content/60">(<%= record.daysDifferenceType %>)</span>
                                        </td>
                                        <td>
                                            <% if (typeof record.daysDifference === 'number') { %>
                                                <% if (record.daysDifference < 0) { %>
                                                    <span class="badge badge-error">Просрочено <%= Math.abs(record.daysDifference) %> дн.</span>
                                                <% } else if (record.daysDifference === 0) { %>
                                                    <span class="badge badge-warning">Оплата сегодня</span>
                                                <% } else { %>
                                                    <span class="badge badge-info">До оплаты <%= record.daysDifference %> дн.</span>
                                                <% } %>
                                            <% } else { %>
                                                <span class="badge badge-ghost">Неопределено</span>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        <% } else { %>
            <div class="alert alert-warning">
                <span>Записи не найдены</span>
            </div>
        <% } %>
    </div>
    
    <div class="mt-6">
        <button onclick="window.location.reload()" class="btn btn-primary mr-2">
            <i class="fas fa-sync-alt"></i>
            Обновить диагностику
        </button>
        <a href="/dashboard/accruals_all_with_status" class="btn btn-secondary">
            Вернуться к дашборду
        </a>
    </div>
</div>