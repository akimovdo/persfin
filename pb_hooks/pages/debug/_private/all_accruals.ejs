<%
meta('title', '–í—Å–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è —Å —Ä–∞—Å—á—ë—Ç–æ–º –¥–Ω–µ–π');

let allAccruals = [];
let error = null;
let totalCount = 0;

try {
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
    allAccruals = $app.findRecordsByFilter('accruals_all_with_status', '', '-updated', 0, 50);
    totalCount = allAccruals.length;
    
    console.log('=== –í–°–ï –ù–ê–ß–ò–°–õ–ï–ù–ò–Ø –° –†–ê–°–ß–Å–¢–û–ú –î–ù–ï–ô ===');
    console.log('–í—Ä–µ–º—è:', new Date().toLocaleString('ru-RU'));
    console.log('–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞:', new Date().toISOString().split('T')[0]);
    console.log('–ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π:', totalCount);
    console.log('');
    
    // –í—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ 10 –∑–∞–ø–∏—Å–µ–π –≤ –∫–æ–Ω—Å–æ–ª—å
    allAccruals.slice(0, 10).forEach((record, index) => {
        const data = {
            id: record.getString('id'),
            name: record.getString('accrual_name'),
            partner: record.getString('partner_name'),
            repaymentDate: record.getString('repayment_date'),
            daysDifference: record.get('days_difference'),
            balance: record.get('balance')
        };
        
        console.log(`--- –ó–∞–ø–∏—Å—å ${index + 1} ---`);
        console.log('–ù–∞–∑–≤–∞–Ω–∏–µ:', data.name);
        console.log('–ü–∞—Ä—Ç–Ω–µ—Ä:', data.partner);
        console.log('–î–∞—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è:', data.repaymentDate);
        console.log('days_difference:', data.daysDifference, '(', typeof data.daysDifference, ')');
        console.log('–ë–∞–ª–∞–Ω—Å:', data.balance);
        console.log('');
    });
    
    console.log('=== –ö–û–ù–ï–¶ –°–ü–ò–°–ö–ê ===');
    
} catch (err) {
    error = err;
    console.log('–û–®–ò–ë–ö–ê –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', err.message);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
const getStatusInfo = (daysDifference) => {
    if (typeof daysDifference !== 'number') {
        return { status: 'unknown', label: '–ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ', class: 'badge-ghost' };
    }
    if (daysDifference < 0) {
        return { 
            status: 'overdue', 
            label: `–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ ${Math.abs(daysDifference)} –¥–Ω.`, 
            class: 'badge-error' 
        };
    }
    if (daysDifference === 0) {
        return { 
            status: 'due-today', 
            label: '–û–ø–ª–∞—Ç–∞ —Å–µ–≥–æ–¥–Ω—è', 
            class: 'badge-warning' 
        };
    }
    return { 
        status: 'upcoming', 
        label: `–î–æ –æ–ø–ª–∞—Ç—ã ${daysDifference} –¥–Ω.`, 
        class: 'badge-info' 
    };
};

// –ü–æ–∏—Å–∫ –∑–∞–ø–∏—Å–µ–π —Å "–î–µ–Ω–∏—Å" –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
const denisRecords = allAccruals.filter(record => {
    const name = record.getString('accrual_name').toLowerCase();
    const partner = record.getString('partner_name').toLowerCase();
    return name.includes('–¥–µ–Ω–∏—Å') || partner.includes('–¥–µ–Ω–∏—Å');
});

// –ó–∞–ø–∏—Å–∏ —Å –¥–∞—Ç–æ–π –ø–æ–≥–∞—à–µ–Ω–∏—è 31.10.2025
const oct31Records = allAccruals.filter(record => 
    record.getString('repayment_date') === '2025-10-31'
);

%>

<div class="container mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">–í—Å–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è —Å —Ä–∞—Å—á—ë—Ç–æ–º –¥–Ω–µ–π</h1>
    
    <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle"></i>
        <span>–ü–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 50 –∑–∞–ø–∏—Å–µ–π. –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤—ã–≤–æ–¥–∏—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å PocketBase.</span>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-title">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
                <div class="stat-value text-primary"><%= totalCount %></div>
            </div>
        </div>
        
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-title">–° "–î–µ–Ω–∏—Å"</div>
                <div class="stat-value text-secondary"><%= denisRecords.length %></div>
            </div>
        </div>
        
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-title">–î–∞—Ç–∞ 31.10.2025</div>
                <div class="stat-value text-accent"><%= oct31Records.length %></div>
            </div>
        </div>
    </div>
    
    <% if (error) { %>
        <div class="alert alert-error mb-4">
            <span>–û—à–∏–±–∫–∞: <%= error.message %></span>
        </div>
    <% } %>
    
    <% if (denisRecords.length > 0) { %>
        <div class="card bg-base-100 shadow mb-6">
            <div class="card-body">
                <h2 class="card-title text-secondary">–ó–∞–ø–∏—Å–∏ —Å "–î–µ–Ω–∏—Å" (<%= denisRecords.length %>)</h2>
                <div class="overflow-x-auto">
                    <table class="table table-zebra table-sm">
                        <thead>
                            <tr>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–ü–∞—Ä—Ç–Ω–µ—Ä</th>
                                <th>–î–∞—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è</th>
                                <th>days_difference</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–ë–∞–ª–∞–Ω—Å</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% denisRecords.forEach(record => { %>
                                <% 
                                const daysDiff = record.get('days_difference');
                                const statusInfo = getStatusInfo(daysDiff);
                                const repaymentDate = record.getString('repayment_date');
                                const isTargetRecord = repaymentDate === '2025-10-31';
                                %>
                                <tr class="<%= isTargetRecord ? 'bg-warning/20 ring-2 ring-warning' : statusInfo.status === 'overdue' ? 'bg-error/10' : statusInfo.status === 'due-today' ? 'bg-warning/10' : '' %>">
                                    <td>
                                        <div class="font-semibold">
                                            <%= record.getString('accrual_name') %>
                                            <% if (isTargetRecord) { %>
                                                <span class="badge badge-warning badge-sm ml-1">–¶–ï–õ–ï–í–ê–Ø</span>
                                            <% } %>
                                        </div>
                                        <div class="text-xs text-base-content/60">ID: <%= record.getString('id').substring(0, 8) %>...</div>
                                    </td>
                                    <td><%= record.getString('partner_name') %></td>
                                    <td class="whitespace-nowrap">
                                        <%= repaymentDate %>
                                        <% if (isTargetRecord) { %>
                                            <span class="badge badge-warning badge-xs">üéØ</span>
                                        <% } %>
                                    </td>
                                    <td class="font-mono">
                                        <span class="<%= daysDiff === -1 && isTargetRecord ? 'text-success font-bold' : daysDiff === 0 && isTargetRecord ? 'text-warning font-bold' : '' %>">
                                            <%= daysDiff %>
                                        </span>
                                        <div class="text-xs text-base-content/60">(<%= typeof daysDiff %>)</div>
                                    </td>
                                    <td>
                                        <span class="badge <%= statusInfo.class %>"><%= statusInfo.label %></span>
                                        <% if (isTargetRecord) { %>
                                            <div class="text-xs mt-1">
                                                <% if (daysDiff === -1) { %>
                                                    <span class="text-success">‚úì –ü—Ä–∞–≤–∏–ª—å–Ω–æ!</span>
                                                <% } else if (daysDiff === 0) { %>
                                                    <span class="text-warning">‚ö† –ü—Ä–æ–±–ª–µ–º–∞</span>
                                                <% } else { %>
                                                    <span class="text-error">‚úó –û—à–∏–±–∫–∞</span>
                                                <% } %>
                                            </div>
                                        <% } %>
                                    </td>
                                    <td class="text-right">
                                        <div class="font-semibold <%= record.get('balance') > 0 ? 'text-error' : 'text-success' %>">
                                            <%= typeof record.get('balance') === 'number' ? record.get('balance').toFixed(2) + ' ‚ÇΩ' : record.get('balance') %>
                                        </div>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    <% } %>
    
    <% if (oct31Records.length > 0) { %>
        <div class="card bg-base-100 shadow mb-6">
            <div class="card-body">
                <h2 class="card-title text-accent">–ó–∞–ø–∏—Å–∏ —Å –¥–∞—Ç–æ–π –ø–æ–≥–∞—à–µ–Ω–∏—è 31.10.2025 (<%= oct31Records.length %>)</h2>
                <div class="overflow-x-auto">
                    <table class="table table-zebra table-sm">
                        <thead>
                            <tr>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–ü–∞—Ä—Ç–Ω–µ—Ä</th>
                                <th>days_difference</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% oct31Records.forEach(record => { %>
                                <% 
                                const daysDiff = record.get('days_difference');
                                const statusInfo = getStatusInfo(daysDiff);
                                const isCorrect = daysDiff === -1;
                                %>
                                <tr class="<%= isCorrect ? 'bg-success/10' : 'bg-error/10' %>">
                                    <td>
                                        <div class="font-semibold"><%= record.getString('accrual_name') %></div>
                                        <div class="text-xs text-base-content/60">ID: <%= record.getString('id').substring(0, 8) %>...</div>
                                    </td>
                                    <td><%= record.getString('partner_name') %></td>
                                    <td class="font-mono">
                                        <span class="<%= isCorrect ? 'text-success' : 'text-error' %> font-bold">
                                            <%= daysDiff %>
                                        </span>
                                        <div class="text-xs text-base-content/60">(<%= typeof daysDiff %>)</div>
                                    </td>
                                    <td>
                                        <span class="badge <%= statusInfo.class %>"><%= statusInfo.label %></span>
                                    </td>
                                    <td>
                                        <% if (isCorrect) { %>
                                            <span class="text-success">‚úì –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ 1 –¥–Ω.</span>
                                        <% } else { %>
                                            <span class="text-error">‚úó –î–æ–ª–∂–Ω–æ –±—ã—Ç—å "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ 1 –¥–Ω."</span>
                                        <% } %>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    <% } %>
    
    <div class="card bg-base-100 shadow">
        <div class="card-body">
            <h2 class="card-title">–ü–µ—Ä–≤—ã–µ 15 –∑–∞–ø–∏—Å–µ–π (–≤—Å–µ)</h2>
            <div class="overflow-x-auto">
                <table class="table table-zebra table-sm">
                    <thead>
                        <tr>
                            <th>‚Ññ</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–ü–∞—Ä—Ç–Ω–µ—Ä</th>
                            <th>–î–∞—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è</th>
                            <th>days_difference</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% allAccruals.slice(0, 15).forEach((record, index) => { %>
                            <% 
                            const daysDiff = record.get('days_difference');
                            const statusInfo = getStatusInfo(daysDiff);
                            %>
                            <tr>
                                <td><%= index + 1 %></td>
                                <td>
                                    <div class="max-w-xs truncate"><%= record.getString('accrual_name') %></div>
                                </td>
                                <td>
                                    <div class="max-w-xs truncate"><%= record.getString('partner_name') %></div>
                                </td>
                                <td class="whitespace-nowrap text-sm"><%= record.getString('repayment_date') %></td>
                                <td class="font-mono text-sm">
                                    <%= daysDiff %> (<%= typeof daysDiff %>)
                                </td>
                                <td>
                                    <span class="badge <%= statusInfo.class %> badge-sm"><%= statusInfo.label %></span>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="mt-6 flex gap-2">
        <button onclick="window.location.reload()" class="btn btn-primary">
            <i class="fas fa-sync-alt"></i>
            –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
        </button>
        <a href="/debug/search_tinek" class="btn btn-secondary">
            –ü–æ–∏—Å–∫ –¢–∏–Ω–µ–∫
        </a>
        <a href="/dashboard" class="btn btn-ghost">
            –î–∞—à–±–æ—Ä–¥
        </a>
    </div>
</div>