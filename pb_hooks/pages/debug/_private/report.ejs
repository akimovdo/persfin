<%
meta('title', '–û—Ç—á—ë—Ç –æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ days_difference');

// –ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á—ë—Ç –æ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ
const report = {
    issue: '–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ "–î–µ–Ω–∏—Å –¢–∏–Ω–µ–∫" —Å –¥–∞—Ç–æ–π –ø–æ–≥–∞—à–µ–Ω–∏—è 31.10.2025 –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ "–û–ø–ª–∞—Ç–∞ —Å–µ–≥–æ–¥–Ω—è" –≤–º–µ—Å—Ç–æ "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ 1 –¥–Ω."',
    cause: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ julianday(\'now\') –≤–º–µ—Å—Ç–æ julianday(date(\'now\')) –≤ —Ä–∞—Å—á—ë—Ç–µ days_difference',
    solution: '–°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SQL-–∑–∞–ø—Ä–æ—Å–∞ –≤ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ accruals_all_with_status',
    migrationFile: '1762999999_final_fix_accruals_days_difference.js',
    timestamp: new Date().toLocaleString('ru-RU')
};

console.log('=== –û–¢–ß–Å–¢ –û –ò–°–ü–†–ê–í–õ–ï–ù–ò–ò ===');
console.log('–í—Ä–µ–º—è:', report.timestamp);
console.log('–ü—Ä–æ–±–ª–µ–º–∞:', report.issue);
console.log('–ü—Ä–∏—á–∏–Ω–∞:', report.cause);
console.log('–†–µ—à–µ–Ω–∏–µ:', report.solution);
console.log('–§–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏:', report.migrationFile);
console.log('');

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
let migrationApplied = false;
try {
    const migrations = $app.dao().findRecordsByFilter('_migrations', "file LIKE '%1762999999%'", '', 0, 1);
    migrationApplied = migrations.length > 0;
    console.log('–ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞:', migrationApplied ? '–î–ê' : '–ù–ï–¢');
} catch (err) {
    console.log('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–∏–≥—Ä–∞—Ü–∏–∏:', err.message);
}

console.log('=== –ö–û–ù–ï–¶ –û–¢–ß–Å–¢–ê ===');
%>

<div class="container mx-auto p-6 max-w-4xl">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold mb-2">üìä –û—Ç—á—ë—Ç –æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ days_difference</h1>
        <p class="text-base-content/70">–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ PocketBase</p>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="card bg-gradient-to-r from-primary/10 to-secondary/10 shadow-lg mb-6">
        <div class="card-body">
            <h2 class="card-title text-xl mb-4">üéØ –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã</h2>
            <div class="bg-base-100/50 p-4 rounded-lg">
                <p class="text-lg"><%= report.issue %></p>
            </div>
        </div>
    </div>
    
    <!-- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="card bg-base-100 shadow">
            <div class="card-body">
                <h3 class="card-title text-error mb-3">‚ùå –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã</h3>
                <div class="space-y-2">
                    <p><strong>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞:</strong></p>
                    <code class="block bg-base-200 p-2 rounded text-sm">
                        julianday('now') - –≤–∫–ª—é—á–∞–µ—Ç –≤—Ä–µ–º—è
                    </code>
                    <p class="text-sm text-base-content/70">
                        –§—É–Ω–∫—Ü–∏—è julianday('now') –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –ò –≤—Ä–µ–º—è, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –Ω–µ—Ç–æ—á–Ω—ã–º —Ä–∞—Å—á—ë—Ç–∞–º –ø—Ä–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ –¥–∞—Ç.
                    </p>
                </div>
            </div>
        </div>
        
        <div class="card bg-base-100 shadow">
            <div class="card-body">
                <h3 class="card-title text-success mb-3">‚úÖ –†–µ—à–µ–Ω–∏–µ</h3>
                <div class="space-y-2">
                    <p><strong>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞:</strong></p>
                    <code class="block bg-base-200 p-2 rounded text-sm">
                        julianday(date('now')) - —Ç–æ–ª—å–∫–æ –¥–∞—Ç–∞
                    </code>
                    <p class="text-sm text-base-content/70">
                        –§—É–Ω–∫—Ü–∏—è date('now') –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è —Ç–æ—á–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –°—Ç–∞—Ç—É—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="card bg-base-100 shadow mb-6">
        <div class="card-body">
            <h3 class="card-title mb-4">üîß –ü—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</h3>
            <div class="space-y-4">
                <div class="flex items-center gap-3">
                    <span class="text-2xl <%= migrationApplied ? 'text-success' : 'text-error' %>">
                        <%= migrationApplied ? '‚úÖ' : '‚ùå' %>
                    </span>
                    <div>
                        <div class="font-semibold">–ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</div>
                        <div class="text-sm text-base-content/70">
                            –§–∞–π–ª: <%= report.migrationFile %>
                        </div>
                        <div class="text-sm">
                            –°—Ç–∞—Ç—É—Å: <span class="<%= migrationApplied ? 'text-success' : 'text-error' %>">
                                <%= migrationApplied ? '–ü—Ä–∏–º–µ–Ω–µ–Ω–∞' : '–ù–µ –Ω–∞–π–¥–µ–Ω–∞' %>
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-base-200 p-4 rounded-lg">
                    <h4 class="font-semibold mb-2">–û–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ SQL-–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ:</h4>
                    <code class="text-xs block">
                        accruals_all_with_status - –æ–±–Ω–æ–≤–ª—ë–Ω —Ä–∞—Å—á—ë—Ç days_difference
                    </code>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
    <div class="card bg-gradient-to-r from-success/10 to-info/10 shadow-lg mb-6">
        <div class="card-body">
            <h3 class="card-title text-success mb-4">üéâ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h4 class="font-semibold text-error mb-2">–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:</h4>
                    <div class="bg-error/10 p-3 rounded border-l-4 border-error">
                        <div class="font-semibold">–î–µ–Ω–∏—Å –¢–∏–Ω–µ–∫</div>
                        <div class="text-sm">–î–∞—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è: 31.10.2025</div>
                        <div class="badge badge-warning">–û–ø–ª–∞—Ç–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-semibold text-success mb-2">–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:</h4>
                    <div class="bg-success/10 p-3 rounded border-l-4 border-success">
                        <div class="font-semibold">–î–µ–Ω–∏—Å –¢–∏–Ω–µ–∫</div>
                        <div class="text-sm">–î–∞—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è: 31.10.2025</div>
                        <div class="badge badge-error">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ 1 –¥–Ω.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div class="card bg-base-100 shadow">
        <div class="card-body">
            <h3 class="card-title mb-4">üîó –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è</h3>
            <div class="flex gap-3 flex-wrap">
                <a href="/debug/final_check" class="btn btn-primary">
                    <i class="fas fa-check-circle"></i>
                    –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                </a>
                <a href="/dashboard/accruals_all_with_status" class="btn btn-success">
                    <i class="fas fa-chart-line"></i>
                    –û—Ç–∫—Ä—ã—Ç—å –¥–∞—à–±–æ—Ä–¥
                </a>
                <a href="/debug/sql_test" class="btn btn-info">
                    <i class="fas fa-database"></i>
                    SQL —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                </a>
                <a href="/debug/all_accruals" class="btn btn-secondary">
                    <i class="fas fa-list"></i>
                    –í—Å–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
                </a>
            </div>
            
            <div class="mt-4 text-sm text-base-content/70">
                <p><strong>–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞:</strong> <%= report.timestamp %></p>
                <p><strong>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã:</strong> PocketBase —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ</p>
            </div>
        </div>
    </div>
</div>