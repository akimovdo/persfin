<%
meta('title', 'Проверка схемы представления');

let schemaInfo = null;
let testQuery = null;
let error = null;

try {
    // Получаем SQL представления напрямую из схемы SQLite
    const db = $app.dao().db();
    
    // Проверяем SQL создания представления
    const schemaQuery = "SELECT sql FROM sqlite_master WHERE type='view' AND name='accruals_all_with_status'";
    const result = db.newQuery(schemaQuery).one();
    
    schemaInfo = {
        sql: result ? result.sql : 'View not found',
        hasCorrectFormula: result ? result.sql.includes("julianday(date('now'))") : false,
        hasOldFormula: result ? result.sql.includes("julianday('now')") : false
    };
    
    // Тестируем расчет напрямую в SQLite
    const testSQL = `
        SELECT 
            julianday('2025-10-31') as julian_repayment,
            julianday('now') as julian_now_with_time,
            julianday(date('now')) as julian_now_date_only,
            CAST((julianday('2025-10-31') - julianday('now')) AS INTEGER) as old_calculation,
            CAST((julianday('2025-10-31') - julianday(date('now'))) AS INTEGER) as new_calculation,
            date('now') as current_date,
            datetime('now') as current_datetime
    `;
    
    const testResult = db.newQuery(testSQL).one();
    testQuery = testResult;
    
} catch (err) {
    error = err;
}
%>

<div class="container mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">Проверка схемы представления</h1>
    
    <% if (error) { %>
        <div class="alert alert-error mb-4">
            <span>Ошибка: <%= error.message %></span>
        </div>
    <% } %>
    
    <% if (schemaInfo) { %>
        <div class="space-y-6">
            <!-- Статус миграции -->
            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <h2 class="card-title">Статус миграции</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="font-semibold mb-2">Исправленная формула найдена:</p>
                            <% if (schemaInfo.hasCorrectFormula) { %>
                                <div class="badge badge-success">✓ Да (julianday(date('now')))</div>
                            <% } else { %>
                                <div class="badge badge-error">✗ Нет</div>
                            <% } %>
                        </div>
                        
                        <div>
                            <p class="font-semibold mb-2">Старая формула найдена:</p>
                            <% if (schemaInfo.hasOldFormula) { %>
                                <div class="badge badge-warning">⚠ Да (julianday('now'))</div>
                            <% } else { %>
                                <div class="badge badge-success">✓ Нет</div>
                            <% } %>
                        </div>
                    </div>
                    
                    <% if (schemaInfo.hasCorrectFormula && !schemaInfo.hasOldFormula) { %>
                        <div class="alert alert-success mt-4">
                            <span>✓ Миграция применена правильно!</span>
                        </div>
                    <% } else if (schemaInfo.hasOldFormula) { %>
                        <div class="alert alert-error mt-4">
                            <span>✗ Обнаружена старая формула в представлении. Миграция не применилась.</span>
                        </div>
                    <% } else { %>
                        <div class="alert alert-warning mt-4">
                            <span>⚠ Неопределенное состояние миграции</span>
                        </div>
                    <% } %>
                </div>
            </div>
            
            <!-- SQL представления -->
            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <h2 class="card-title">SQL представления accruals_all_with_status</h2>
                    <pre class="bg-base-200 p-4 rounded text-xs overflow-x-auto whitespace-pre-wrap"><%= schemaInfo.sql %></pre>
                </div>
            </div>
            
            <!-- Тестовые расчеты -->
            <% if (testQuery) { %>
                <div class="card bg-base-100 shadow">
                    <div class="card-body">
                        <h2 class="card-title">Тестовые расчеты SQLite</h2>
                        
                        <div class="overflow-x-auto">
                            <table class="table table-zebra table-sm">
                                <tbody>
                                    <tr>
                                        <td class="font-semibold">Текущая дата</td>
                                        <td><%= testQuery.current_date %></td>
                                    </tr>
                                    <tr>
                                        <td class="font-semibold">Текущее время</td>
                                        <td><%= testQuery.current_datetime %></td>
                                    </tr>
                                    <tr>
                                        <td class="font-semibold">Julian day (31.10.2025)</td>
                                        <td class="font-mono"><%= testQuery.julian_repayment %></td>
                                    </tr>
                                    <tr>
                                        <td class="font-semibold">Julian day (сейчас с временем)</td>
                                        <td class="font-mono"><%= testQuery.julian_now_with_time %></td>
                                    </tr>
                                    <tr>
                                        <td class="font-semibold">Julian day (сегодня без времени)</td>
                                        <td class="font-mono"><%= testQuery.julian_now_date_only %></td>
                                    </tr>
                                    <tr class="bg-error/20">
                                        <td class="font-semibold">Старый расчет (с временем)</td>
                                        <td class="font-mono text-lg"><%= testQuery.old_calculation %></td>
                                    </tr>
                                    <tr class="bg-success/20">
                                        <td class="font-semibold">Новый расчет (без времени)</td>
                                        <td class="font-mono text-lg"><%= testQuery.new_calculation %></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4 p-4 bg-info/20 rounded">
                            <p><strong>Интерпретация:</strong></p>
                            <p>Старый расчет: <%= testQuery.old_calculation %> 
                                (<%= testQuery.old_calculation < 0 ? 'просрочка на ' + Math.abs(testQuery.old_calculation) + ' дн.' : 
                                    testQuery.old_calculation === 0 ? 'оплата сегодня' : 'до оплаты ' + testQuery.old_calculation + ' дн.' %>)
                            </p>
                            <p>Новый расчет: <%= testQuery.new_calculation %> 
                                (<%= testQuery.new_calculation < 0 ? 'просрочка на ' + Math.abs(testQuery.new_calculation) + ' дн.' : 
                                    testQuery.new_calculation === 0 ? 'оплата сегодня' : 'до оплаты ' + testQuery.new_calculation + ' дн.' %>)
                            </p>
                        </div>
                    </div>
                </div>
            <% } %>
        </div>
    <% } %>
    
    <div class="mt-6 flex gap-2">
        <% if (schemaInfo && schemaInfo.hasOldFormula) { %>
            <button onclick="reapplyMigration()" class="btn btn-warning">
                <i class="fas fa-redo"></i>
                Переприменить миграцию
            </button>
        <% } %>
        <button onclick="window.location.reload()" class="btn btn-primary">
            <i class="fas fa-sync-alt"></i>
            Обновить
        </button>
        <a href="/dashboard/accruals_all_with_status" class="btn btn-secondary">
            Вернуться к дашборду
        </a>
    </div>
</div>

<script>
async function reapplyMigration() {
    if (!confirm('Переприменить миграцию для исправления расчета days_difference?')) {
        return;
    }
    
    try {
        // Здесь можно добавить API вызов для переприменения миграции
        alert('Функция переприменения миграции пока не реализована. Обратитесь к разработчику.');
    } catch (error) {
        alert('Ошибка: ' + error.message);
    }
}
</script>