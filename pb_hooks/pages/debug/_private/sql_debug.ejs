<%
meta('title', 'SQL Query Debug');

let queryResult = null;
let error = null;

try {
    // Выполняем прямой SQL запрос для проверки
    const db = $app.dao().db();
    
    // Проверяем текущий запрос представления
    const viewInfo = db.newQuery("SELECT sql FROM sqlite_master WHERE type='view' AND name='accruals_all_with_status'").one();
    
    queryResult = {
        viewSQL: viewInfo ? viewInfo.sql : 'View not found',
        currentTime: new Date().toISOString(),
        currentDate: new Date().toISOString().split('T')[0]
    };
    
    // Выполняем тестовый запрос
    const testQuery = `
        SELECT 
            'now()' as label,
            julianday('now') as julian_now,
            julianday(date('now')) as julian_date_now,
            date('now') as date_now,
            datetime('now') as datetime_now
        UNION ALL
        SELECT 
            '2025-10-31' as label,
            julianday('2025-10-31') as julian_now,
            julianday(date('2025-10-31')) as julian_date_now,
            '2025-10-31' as date_now,
            '2025-10-31 00:00:00' as datetime_now
    `;
    
    const testResults = db.newQuery(testQuery).all();
    queryResult.testResults = testResults;
    
} catch (err) {
    error = err;
}
%>

<div class="container mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">SQL Query Debug</h1>
    
    <% if (error) { %>
        <div class="alert alert-error mb-4">
            <span>Ошибка: <%= error.message %></span>
        </div>
    <% } %>
    
    <% if (queryResult) { %>
        <div class="space-y-6">
            <div>
                <h2 class="text-lg font-semibold mb-2">Информация о времени</h2>
                <p><strong>Текущее время (JS):</strong> <%= queryResult.currentTime %></p>
                <p><strong>Текущая дата (JS):</strong> <%= queryResult.currentDate %></p>
            </div>
            
            <div>
                <h2 class="text-lg font-semibold mb-2">SQL представления accruals_all_with_status</h2>
                <pre class="bg-base-200 p-4 rounded text-xs overflow-x-auto"><%= queryResult.viewSQL %></pre>
            </div>
            
            <% if (queryResult.testResults) { %>
                <div>
                    <h2 class="text-lg font-semibold mb-2">Тестовые результаты SQLite</h2>
                    <div class="overflow-x-auto">
                        <table class="table table-bordered table-sm">
                            <thead>
                                <tr>
                                    <th>Label</th>
                                    <th>julianday()</th>
                                    <th>julianday(date())</th>
                                    <th>date()</th>
                                    <th>datetime()</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% queryResult.testResults.forEach(row => { %>
                                    <tr>
                                        <td><%= row.label %></td>
                                        <td class="font-mono"><%= row.julian_now %></td>
                                        <td class="font-mono"><%= row.julian_date_now %></td>
                                        <td><%= row.date_now %></td>
                                        <td><%= row.datetime_now %></td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                    
                    <% if (queryResult.testResults.length >= 2) { %>
                        <%
                            const nowRow = queryResult.testResults[0];
                            const dateRow = queryResult.testResults[1];
                            const diff = Math.floor(dateRow.julian_now - nowRow.julian_date_now);
                        %>
                        <div class="mt-4 p-4 bg-info/20 rounded">
                            <p><strong>Расчет разности дней:</strong></p>
                            <p>julianday('2025-10-31') - julianday(date('now')) = <%= dateRow.julian_now %> - <%= nowRow.julian_date_now %> = <%= diff %></p>
                            <p><strong>Результат:</strong> <%= diff %> (должно быть -1 для просрочки на 1 день)</p>
                        </div>
                    <% } %>
                </div>
            <% } %>
        </div>
    <% } %>
    
    <div class="mt-6">
        <a href="/debug/days_difference" class="btn btn-secondary mr-2">
            Отладка данных
        </a>
        <a href="/dashboard/accruals_all_with_status" class="btn btn-primary">
            Вернуться к дашборду
        </a>
    </div>
</div>